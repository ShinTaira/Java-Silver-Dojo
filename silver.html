<!DOCTYPE html>
<html lang="ja" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Silver 完全攻略道場 (Ver 17.1 - Official Chapters)</title>
    <!-- Favicon: Java-like Coffee Cup -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M25,55 C25,80 45,90 65,90 H75 V80 H65 C50,80 35,75 35,55 V45 H25 Z' fill='%235382a1'/><path d='M25,45 H75 V55 C75,70 70,75 65,75 H35 C30,75 25,70 25,55 Z' fill='%235382a1'/><path d='M75,45 H85 C90,45 90,55 85,60 H75 Z' fill='%235382a1'/><path d='M40,30 Q50,10 60,30 T80,30' fill='none' stroke='%23f89820' stroke-width='6' stroke-linecap='round'/><path d='M30,20 Q40,0 50,20 T70,20' fill='none' stroke='%23f89820' stroke-width='6' stroke-linecap='round'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .drill-card {
            transition: all 0.2s ease;
            border-bottom: 4px solid transparent;
        }

        .drill-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .option-btn {
            transition: all 0.1s ease;
        }

        .option-selected {
            background-color: #eff6ff !important;
            border-color: #3b82f6 !important;
            color: #1d4ed8 !important;
            box-shadow: 0 0 0 2px #3b82f6 inset !important;
        }

        .option-selected .opt-mark {
            background-color: #3b82f6 !important;
            color: white !important;
        }

        .dark .option-selected {
            background-color: #1e3a8a !important;
            border-color: #60a5fa !important;
            color: #bfdbfe !important;
            box-shadow: 0 0 0 2px #60a5fa inset !important;
        }

        .dark .option-selected .opt-mark {
            background-color: #60a5fa !important;
            color: #1e3a8a !important;
        }

        .loader {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Coding Area specific */
        .coding-textarea {
            background-color: #1e1e1e;
            color: #d4d4d4;
            caret-color: white;
            font-family: 'Consolas', 'Monaco', 'Andale Mono', 'Ubuntu Mono', monospace;
            line-height: 1.5;
            tab-size: 4;
        }

        /* Error Overlay */
        #global-error-display {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #ef4444;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            z-index: 9999;
        }

        /* Markdown Styling for AI Response */
        .ai-response {
            line-height: 1.7;
        }

        .ai-response h3 {
            font-weight: bold;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            font-size: 1.2em;
            color: #4f46e5;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.3em;
        }

        .dark .ai-response h3 {
            color: #818cf8;
            border-color: #334155;
        }

        .ai-response h4 {
            font-weight: bold;
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
        }

        .ai-response ul {
            list-style-type: disc;
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .ai-response ol {
            list-style-type: decimal;
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .ai-response li {
            margin-bottom: 0.3em;
        }

        .ai-response strong {
            font-weight: bold;
            color: #1e293b;
            background: linear-gradient(transparent 70%, #fef3c7 70%);
        }

        .dark .ai-response strong {
            color: #f1f5f9;
            background: linear-gradient(transparent 70%, #4b5563 70%);
        }

        .ai-response p {
            margin-bottom: 1em;
        }

        .ai-response blockquote {
            border-left: 4px solid #cbd5e1;
            padding-left: 1em;
            margin: 1em 0;
            color: #64748b;
            font-style: italic;
        }

        .dark .ai-response blockquote {
            border-color: #475569;
            color: #94a3b8;
        }

        /* Table Styles for AI Response */
        .ai-response table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.9em;
        }

        .ai-response th,
        .ai-response td {
            border: 1px solid #cbd5e1;
            padding: 10px;
            text-align: left;
        }

        .dark .ai-response th,
        .dark .ai-response td {
            border-color: #475569;
        }

        .ai-response th {
            background-color: #f1f5f9;
            font-weight: bold;
            color: #334155;
        }

        .dark .ai-response th {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        .ai-response tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .dark .ai-response tr:nth-child(even) {
            background-color: #0f172a;
        }

        /* Code Block in AI Response */
        .ai-response pre {
            margin: 1em 0;
            border-radius: 8px;
            overflow-x: auto;
            background-color: #1e1e1e !important;
        }

        .ai-response code {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9em;
        }

        .ai-response p>code {
            background-color: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            color: #ef4444;
            font-weight: bold;
        }

        .dark .ai-response p>code {
            background-color: #334155;
            color: #fca5a5;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-[#f8fafc] dark:bg-darkbg dark:text-slate-200">

    <!-- Global Error Display -->
    <div id="global-error-display"></div>

    <!-- Navbar -->
    <header
        class="bg-white dark:bg-darkcard border-b border-slate-200 dark:border-slate-700 z-50 shrink-0 transition-colors">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="index.html" class="flex items-center gap-3 hover:opacity-75 transition" title="ポータル画面に戻る">
                        <div class="w-10 h-10 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"
                                class="w-10 h-10 drop-shadow-md">
                                <path d="M25,55 C25,80 45,90 65,90 H75 V80 H65 C50,80 35,75 35,55 V45 H25 Z"
                                    fill="#5382a1" />
                                <path d="M25,45 H75 V55 C75,70 70,75 65,75 H35 C30,75 25,70 25,55 Z" fill="#5382a1" />
                                <path d="M75,45 H85 C90,45 90,55 85,60 H75 Z" fill="#5382a1" />
                                <path d="M40,30 Q50,10 60,30 T80,30" fill="none" stroke="#f89820" stroke-width="6"
                                    stroke-linecap="round" />
                                <path d="M30,20 Q40,0 50,20 T70,20" fill="none" stroke="#f89820" stroke-width="6"
                                    stroke-linecap="round" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="font-bold text-xl tracking-tight text-slate-900 dark:text-white">Java Silver 道場
                            </h1>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-none">Ver 17.1 Official
                                Chapters</p>
                        </div>
                    </a>

                    <div
                        class="bg-slate-100 dark:bg-slate-800 p-1 rounded-xl flex gap-1 items-center border border-slate-200 dark:border-slate-700 shadow-inner">
                        <a href="bronze.html"
                            class="exam-toggle-btn px-3 py-1.5 text-xs rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition">Bronze</a>
                        <span
                            class="exam-toggle-btn px-3 py-1.5 text-xs rounded-lg exam-toggle-active shadow-sm cursor-default">Silver</span>
                        <a href="gold.html"
                            class="exam-toggle-btn px-3 py-1.5 text-xs rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition">Gold</a>
                    </div>
                </div>
                <div class="flex items-center gap-1 sm:gap-2">
                    <nav class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg overflow-x-auto">
                        <button onclick="app.switchTab('dashboard')" id="nav-dashboard"
                            class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">ホーム</button>
                        <button onclick="app.switchTab('create')" id="nav-create"
                            class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">作成</button>
                        <button onclick="app.switchTab('coding')" id="nav-coding"
                            class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">💻
                            実践</button>
                        <button onclick="app.switchTab('history')" id="nav-history"
                            class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">記録</button>
                        <button onclick="app.switchTab('ai')" id="nav-ai"
                            class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">AI先生</button>
                        <button onclick="app.switchTab('settings')" id="nav-settings"
                            class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">設定</button>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative">

        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 fade-in">
            <div class="max-w-5xl mx-auto">
                <!-- Status Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div
                        class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase">登録問題数</div>
                        <div class="text-3xl font-bold text-slate-800 dark:text-white mt-1" id="stat-total">0</div>
                    </div>
                    <div
                        class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase">正解率</div>
                        <div class="text-3xl font-bold text-emerald-500 mt-1" id="stat-rate">0%</div>
                    </div>
                    <div
                        class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm col-span-2 flex items-center justify-between bg-gradient-to-r from-white to-slate-50 dark:from-darkcard dark:to-slate-800">
                        <div>
                            <div class="text-xs text-slate-400 font-bold uppercase">苦手な問題</div>
                            <div class="text-3xl font-bold text-red-500 mt-1"><span id="wrong-count">0</span> <span
                                    class="text-base text-slate-400 font-normal">問</span></div>
                        </div>
                        <button onclick="app.startQuiz('review')" id="btn-review"
                            class="px-6 py-2.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-bold rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 transition disabled:opacity-50 disabled:cursor-not-allowed">復習する</button>
                    </div>
                </div>

                <!-- Level Based Quizzes -->
                <div class="mb-8">
                    <h3 class="text-base font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2">
                        <span class="text-xl">📊</span> レベル別演習 (各30問)
                    </h3>
                    <div class="grid grid-cols-3 gap-4">
                        <button onclick="app.startQuiz('level-1')"
                            class="bg-gradient-to-br from-emerald-400 to-teal-500 text-white p-4 rounded-xl shadow-lg hover:scale-[1.02] transition relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-3 text-4xl opacity-20 group-hover:scale-125 transition">
                                🐣</div>
                            <div class="font-bold text-lg">初級</div>
                            <div class="text-xs opacity-90 mt-1">基本・変数・演算子</div>
                        </button>
                        <button onclick="app.startQuiz('level-2')"
                            class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg hover:scale-[1.02] transition relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-3 text-4xl opacity-20 group-hover:scale-125 transition">
                                🦅</div>
                            <div class="font-bold text-lg">中級</div>
                            <div class="text-xs opacity-90 mt-1">OOP・配列・API</div>
                        </button>
                        <button onclick="app.startQuiz('level-3')"
                            class="bg-gradient-to-br from-violet-600 to-fuchsia-600 text-white p-4 rounded-xl shadow-lg hover:scale-[1.02] transition relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-3 text-4xl opacity-20 group-hover:scale-125 transition">
                                🔥</div>
                            <div class="font-bold text-lg">上級</div>
                            <div class="text-xs opacity-90 mt-1">例外・ラムダ・継承</div>
                        </button>
                    </div>
                </div>

                <!-- Main Actions -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div
                        class="bg-white dark:bg-darkcard p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="text-base font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2">
                            <span class="text-xl">🔍</span> キーワード演習
                        </h3>
                        <div class="flex gap-2">
                            <input type="text" id="search-input"
                                class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition dark:text-white"
                                placeholder="例: ラムダ, 例外, 継承...">
                            <button onclick="app.startSearchQuiz()"
                                class="bg-slate-800 dark:bg-slate-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-700 dark:hover:bg-slate-600 transition">検索</button>
                        </div>
                    </div>
                    <div
                        class="bg-white dark:bg-darkcard p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between">
                        <div>
                            <h3
                                class="text-base font-bold text-slate-700 dark:text-slate-200 mb-1 flex items-center gap-2">
                                <span class="text-xl">🔖</span> ブックマーク
                            </h3>
                            <p class="text-xs text-slate-400">保存済み: <span id="bookmark-count"
                                    class="font-bold text-slate-700 dark:text-slate-300">0</span> 問</p>
                        </div>
                        <button onclick="app.startQuiz('bookmark')" id="btn-bookmark"
                            class="px-6 py-2.5 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 font-bold rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition disabled:opacity-50">解く</button>
                    </div>
                </div>

                <!-- IMPORT SECTION -->
                <div
                    class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-6 mb-8 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 class="text-base font-bold text-indigo-800 dark:text-indigo-300 flex items-center gap-2">📥
                            データ読み込み・復元</h3>
                        <p class="text-xs text-indigo-600 dark:text-indigo-400 mt-1">
                            🚨画面が白い、または問題がない場合はここからデータを読み込んでください‼️
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="dataManager.generateDemoData()"
                            class="px-4 py-2 bg-white dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 border border-indigo-200 dark:border-indigo-700 rounded-lg text-sm font-bold hover:bg-indigo-50 dark:hover:bg-slate-700 transition">サンプルデータ作成</button>
                        <label
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition cursor-pointer shadow-md">
                            JSONファイルを読み込む (複数可)
                            <input type="file" class="hidden" multiple onchange="dataManager.importData(this)">
                        </label>
                    </div>
                </div>

                <!-- Coding Link -->
                <div class="mb-10" onclick="app.switchTab('coding')">
                    <div
                        class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-6 text-white shadow-lg cursor-pointer hover:scale-[1.01] transition relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 text-8xl opacity-10 group-hover:scale-110 transition">💻
                        </div>
                        <h3 class="text-xl font-bold flex items-center gap-2 mb-1"><span>実践コーディング道場</span><span
                                class="bg-white/20 text-[10px] px-2 py-0.5 rounded">〜コードに慣れよう！！〜</span></h3>
                        <p class="text-emerald-100 text-sm">手を動かして覚える。全20問以上の実践ドリル。</p>
                    </div>
                </div>

                <!-- User Questions -->
                <div class="mb-10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                            <span>📚 オリジナル問題集</span><span
                                class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 text-[10px] px-2 py-0.5 rounded font-bold">User
                                Made</span>
                        </h3>
                    </div>
                    <div
                        class="bg-gradient-to-br from-slate-800 to-slate-900 dark:from-slate-900 dark:to-black rounded-2xl p-6 text-white shadow-lg relative overflow-hidden group border border-slate-700">
                        <div
                            class="absolute top-0 right-0 p-8 opacity-10 text-9xl transform translate-x-10 -translate-y-4 select-none">
                            ✍️</div>
                        <div
                            class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                            <div>
                                <h4 class="text-xl font-bold mb-1">黒本 問題集</h4>
                                <p class="text-slate-400 text-sm">黒本の問題のみを出題<br><span class="text-xs opacity-70">※登録数:
                                        <span id="user-q-count">0</span> 問</span></p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="app.startQuiz('user-random')"
                                    class="px-5 py-2.5 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg text-sm font-bold transition">ランダム10問</button>
                                <button onclick="app.startQuiz('user-all')"
                                    class="px-5 py-2.5 bg-indigo-500 hover:bg-indigo-400 text-white rounded-lg text-sm font-bold shadow-lg transition">全問解く</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chapters Grid -->
                <div class="mb-12">
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4">📖 章ごとの練習 (Java Silver 公式準拠)
                    </h3>
                    <div id="chapter-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <div
                            class="col-span-full py-12 text-center text-slate-400 bg-white dark:bg-darkcard border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                            <p>データを読み込むとここに章が表示されます</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CODING TAB -->
        <div id="tab-coding" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-5xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><span>💻
                                実践コーディング道場</span></h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">実際にコードを書いて覚えよう（実践モード）</p>
                    </div>
                </div>

                <!-- Coding Menu -->
                <div id="coding-menu" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <!-- Dynamic generation -->
                </div>

                <!-- Coding Workspace (Hidden by default) -->
                <div id="coding-workspace" class="hidden flex-1 flex flex-col md:flex-row gap-4 h-full min-h-[500px]">
                    <!-- Problem Side -->
                    <div class="md:w-1/3 flex flex-col gap-4">
                        <div
                            class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex-1">
                            <button onclick="codingApp.close()"
                                class="mb-4 text-xs text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white font-bold flex items-center gap-1">←
                                メニューに戻る</button>
                            <span class="text-xs font-bold text-white px-2 py-0.5 rounded" id="coding-tag">基本</span>
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mt-2 mb-4" id="coding-title">
                                問題タイトル</h3>
                            <div class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap"
                                id="coding-desc">ここに問題文が表示されます。</div>

                            <div id="coding-hint-box" class="mt-6 hidden">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">必須キーワード</div>
                                <div id="coding-keywords" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Editor Side -->
                    <div class="md:w-2/3 flex flex-col gap-4">
                        <div
                            class="flex-1 bg-[#1e1e1e] rounded-xl overflow-hidden border border-slate-700 shadow-lg flex flex-col">
                            <div
                                class="bg-[#2d2d2d] px-4 py-2 flex justify-between items-center border-b border-[#3e3e3e]">
                                <span class="text-xs text-gray-400 font-mono">Main.java</span>
                                <span class="text-[10px] text-gray-500">Auto-saved</span>
                            </div>
                            <textarea id="coding-editor"
                                class="coding-textarea flex-1 p-4 w-full h-full resize-none outline-none text-sm"
                                spellcheck="false" placeholder="// ここにコードを書いてください..."></textarea>
                        </div>

                        <div class="flex justify-between items-center">
                            <button onclick="codingApp.showAnswer()"
                                class="text-sm text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400 underline">模範解答を見る</button>
                            <button onclick="codingApp.check()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition active:scale-95 flex items-center gap-2">
                                <span>判定する</span> <span class="text-lg">▶</span>
                            </button>
                        </div>

                        <!-- Result Area -->
                        <div id="coding-result"
                            class="hidden bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-lg fade-in">
                            <h4 class="font-bold text-lg mb-2 flex items-center gap-2" id="coding-result-title"></h4>
                            <p class="text-sm text-slate-600 dark:text-slate-300 mb-4" id="coding-result-msg"></p>

                            <div
                                class="bg-slate-50 dark:bg-slate-800 rounded-lg p-3 border border-slate-200 dark:border-slate-600">
                                <div class="text-xs text-slate-400 mb-1">模範解答:</div>
                                <pre
                                    class="text-xs overflow-x-auto"><code class="language-java" id="coding-answer-code"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CREATE TAB -->
        <div id="tab-create" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-3xl mx-auto space-y-6">
                <div
                    class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div
                        class="border-b border-slate-100 dark:border-slate-700 p-5 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                            <span>📝 問題を作成</span>
                        </h2>
                        <span
                            class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-2 py-1 rounded font-bold">User
                            Studio</span>
                    </div>
                    <form id="create-form" onsubmit="creator.saveQuestion(event)" class="p-6 space-y-6">
                        <input type="hidden" id="edit-id" value="">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">カテゴリ
                                    (章)</label>
                                <div class="relative">
                                    <select id="create-chapter"
                                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none appearance-none transition dark:text-white"
                                        onchange="creator.updateCategoryLabel()">
                                        <option value="1">第1章: 簡単なJAVAプログラムの作成</option>
                                        <option value="2">第2章: Javaの基本データ型と文字列操作</option>
                                        <option value="3">第3章: 演算子と判定構造</option>
                                        <option value="4">第4章: 制御構造</option>
                                        <option value="5">第5章: 配列の操作</option>
                                        <option value="6">第6章: インスタンスとメソッド</option>
                                        <option value="7">第7章: クラスの継承、インターフェイス、抽象クラス</option>
                                        <option value="8">第8章: 関数型インターフェイス、ラムダ式</option>
                                        <option value="9">第9章: API</option>
                                        <option value="10">第10章: 例外処理</option>
                                        <option value="11">第11章: モジュールシステム</option>
                                        <option value="mock1">模擬試験①</option>
                                        <option value="mock2">模擬試験②</option>
                                        <option value="mock3">模擬試験③</option>
                                        <option value="99">その他</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <input type="hidden" id="create-cat-name" value="簡単なJAVAプログラムの作成">
                            </div>
                            <div><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">問題文</label><textarea
                                    id="create-text" rows="3"
                                    class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white"
                                    required placeholder="問題文を入力..."></textarea></div>
                            <div><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Javaコード
                                    (任意)</label><textarea id="create-code" rows="4"
                                    class="w-full bg-slate-900 text-slate-200 font-mono text-sm rounded-lg p-3 border border-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                    placeholder="public class Main { ... }"></textarea></div>
                            <div
                                class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center mb-3"><label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-wider">選択肢 &
                                        正解</label><button type="button" onclick="creator.addOption()"
                                        class="text-xs bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-indigo-600 dark:text-indigo-400 px-3 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900 transition font-bold shadow-sm">＋
                                        追加</button></div>
                                <div id="options-container" class="space-y-3"></div>
                                <p class="text-xs text-indigo-500 dark:text-indigo-400 mt-2 font-bold ml-1">※
                                    正解を選択してください</p>
                            </div>
                            <div><label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">解説</label>
                                <textarea id="create-explanation" rows="4"
                                    class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white"
                                    required placeholder="解説を入力..."></textarea>
                                <!-- Image Paste Area -->
                                <div
                                    class="mt-2 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-dashed border-slate-300 dark:border-slate-600">
                                    <p class="text-xs text-slate-400 mb-2">解説入力欄をクリックして画像を貼り付け(Ctrl+V)できます</p>
                                    <div id="explanation-image-preview" class="hidden relative inline-block">
                                        <img id="preview-img" src=""
                                            class="max-h-40 rounded border border-slate-200 dark:border-slate-600 shadow-sm">
                                        <button type="button" onclick="creator.removeImage()"
                                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow-sm">×</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                            <button type="button" onclick="creator.cancelEdit()" id="btn-cancel-edit"
                                class="hidden text-sm text-slate-500 hover:text-slate-800 px-4 py-2">キャンセル</button>
                            <button type="submit" id="btn-save-question"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5">追加する</button>
                        </div>
                    </form>
                </div>
                <div
                    class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">作成済みリスト</h3>
                    <div id="user-questions-list" class="space-y-2">
                        <div class="text-center text-slate-400 py-8 text-sm">まだ自作問題はありません</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI TAB -->
        <div id="tab-ai" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-3xl mx-auto space-y-6">
                <!-- API Settings -->
                <div
                    class="bg-white dark:bg-darkcard p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2">
                        <span>🔑 Gemini API 設定</span>
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">API
                                Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="api-key-input"
                                    class="flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-sm outline-none focus:border-indigo-500 transition dark:text-white"
                                    placeholder="AIzaSy...">
                                <button onclick="aiTutor.saveKey()"
                                    class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition">保存</button>
                            </div>
                        </div>
                        <div>
                            <label
                                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Model</label>
                            <select id="api-model-select"
                                class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white"
                                onchange="aiTutor.toggleCustomModelInput()">
                                <option value="gemini-2.5-flash-preview-09-2025">gemini-2.5-flash (推奨・最新)</option>
                                <option value="custom">カスタム入力...</option>
                            </select>
                            <input type="text" id="api-model-custom"
                                class="w-full mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none hidden dark:text-white"
                                placeholder="例: gemini-2.5-flash-preview-09-2025">
                        </div>
                    </div>
                    <div id="key-status" class="text-xs text-slate-400 mt-4 flex items-center gap-1"><span
                            class="w-2 h-2 rounded-full bg-slate-300"></span> 未設定</div>
                </div>

                <!-- AI Tutor Area -->
                <div
                    class="bg-gradient-to-br from-indigo-600 to-violet-600 p-8 rounded-2xl shadow-lg text-white relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-9xl opacity-10 select-none">🎓</div>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold mb-1">AI 先生の学習分析</h2>
                        <p class="text-indigo-100 text-sm mb-6">あなたの学習履歴（苦手分野や間違えた問題）を分析して、アドバイスとオリジナル問題作成のヒントを教えます。</p>

                        <div id="ai-analysis-stats"
                            class="bg-white/10 backdrop-blur-md rounded-lg p-4 mb-6 border border-white/20 hidden">
                            <h4 class="text-xs font-bold text-indigo-200 uppercase tracking-wider mb-2">Current Status
                            </h4>
                            <div class="flex gap-4 text-sm">
                                <div>苦手: <span id="ai-weak-text" class="font-bold"></span></div>
                            </div>
                        </div>

                        <button onclick="aiTutor.getAdvice()" id="btn-get-advice"
                            class="w-full bg-white text-indigo-600 font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-50 transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>🧠 分析＆アドバイスをもらう</button>

                        <div id="ai-loading" class="hidden mt-6 flex flex-col items-center">
                            <div class="loader mb-3 border-t-white border-white/20"></div>
                            <p class="text-xs text-indigo-100 animate-pulse" id="ai-status-text">学習履歴を分析中...</p>
                        </div>
                    </div>
                </div>

                <!-- AI Output Area -->
                <div id="ai-output-box"
                    class="hidden bg-white dark:bg-darkcard p-6 md:p-8 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3 mb-4 pb-4 border-b border-slate-100 dark:border-slate-700">
                        <div
                            class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-xl">
                            🤖</div>
                        <div>
                            <div class="font-bold text-slate-800 dark:text-white">AI先生</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">Java Silver エキスパート</div>
                        </div>
                    </div>
                    <div id="ai-response-content"
                        class="text-sm md:text-base leading-relaxed text-slate-700 dark:text-slate-300 ai-response whitespace-pre-wrap">
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-2xl mx-auto space-y-8">
                <!-- Theme Switcher -->
                <div
                    class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">🌙 外観設定
                        </h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400">目に優しいダークモードに切り替えます。</p>
                    </div>
                    <button onclick="app.toggleTheme()" id="theme-toggle-btn"
                        class="bg-slate-200 dark:bg-slate-700 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none">
                        <span aria-hidden="true" id="theme-toggle-circle"
                            class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                    </button>
                </div>

                <div
                    class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2">📂
                        データ管理</h3>
                    <p class="text-sm text-slate-500 mb-6">学習データをバックアップ・復元できます。</p>
                    <div class="grid gap-4">
                        <div
                            class="border border-slate-100 dark:border-slate-700 rounded-lg p-4 bg-slate-50 dark:bg-slate-800">
                            <h4 class="font-bold text-sm text-slate-700 dark:text-slate-300 mb-2">📤 エクスポート (保存)</h4>
                            <button onclick="dataManager.exportData()"
                                class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-bold shadow-sm">データを書き出し</button>
                        </div>
                        <div
                            class="border border-slate-100 dark:border-slate-700 rounded-lg p-4 bg-slate-50 dark:bg-slate-800">
                            <h4 class="font-bold text-sm text-slate-700 dark:text-slate-300 mb-2">📥 インポート (読み込み)</h4>
                            <label
                                class="text-sm bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition font-bold shadow-sm cursor-pointer inline-block">
                                ファイルを選択して読み込む (複数可)
                                <input type="file" class="hidden" multiple onchange="dataManager.importData(this)">
                            </label>
                        </div>
                        <div
                            class="border border-red-50 dark:border-red-900/30 rounded-lg p-4 bg-red-50/50 dark:bg-red-900/20 mt-4">
                            <h4 class="font-bold text-sm text-red-700 dark:text-red-400 mb-2">🗑 データ初期化</h4>
                            <button onclick="dataManager.resetAll()"
                                class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-300 underline">すべてのデータを削除する</button>
                        </div>
                    </div>
                </div>
                <div class="text-center text-xs text-slate-400">
                    <p>Java Silver Dojo Ver 17.1</p>
                    <p>Storage Key: javaSilverDojo_GlobalData</p>
                </div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="tab-history" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2"><span>📈
                            学習記録</span></h2>
                    <select id="history-filter"
                        class="text-sm border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-1.5 bg-white dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500"
                        onchange="app.renderHistory()">
                        <option value="all">すべて表示</option>
                        <option value="mock">模擬試験</option>
                        <option value="level">レベル別</option>
                    </select>
                </div>
                <div class="grid md:grid-cols-12 gap-6">
                    <div class="md:col-span-8 space-y-6">
                        <div
                            class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-64 md:h-80">
                            <canvas id="historyChart"></canvas>
                        </div>
                        <div id="history-list" class="space-y-3"></div>
                    </div>
                    <div class="md:col-span-4">
                        <div class="sticky top-6">
                            <div
                                class="bg-white dark:bg-darkcard p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none text-9xl">💊</div>
                                <h3
                                    class="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2 relative z-10">
                                    <span class="text-xl">🚑</span> 苦手克服サポート
                                </h3>
                                <div id="weakness-advice-list" class="space-y-4 relative z-10"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUIZ VIEW -->
        <div id="tab-quiz-view" class="absolute inset-0 overflow-y-auto p-4 bg-[#f8fafc] dark:bg-darkbg hidden z-50">
            <div class="max-w-3xl mx-auto pb-20 fade-in mt-4">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="app.quitQuiz()"
                        class="text-xs text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-bold flex items-center gap-1 p-2 transition"><span
                            class="text-lg">←</span> 中断して戻る</button>
                    <div class="text-xs font-mono text-slate-500 dark:text-slate-400 bg-white dark:bg-darkcard border border-slate-200 dark:border-slate-600 px-3 py-1 rounded-full shadow-sm"
                        id="mode-display">Random</div>
                </div>
                <div id="quiz-timer"
                    class="hidden text-center text-xl font-mono font-bold text-slate-700 dark:text-slate-200 mb-6 bg-yellow-50 dark:bg-yellow-900/20 py-2 rounded-lg border border-yellow-200 dark:border-yellow-900/50">
                    ⏳ 90:00</div>

                <!-- KEYBOARD HINT -->
                <div class="text-center text-[10px] text-slate-400 mb-2 font-mono hidden md:block">
                    [Key: 1-4:Select, Enter:Submit/Next]
                </div>

                <div
                    class="bg-white dark:bg-darkcard p-6 md:p-10 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 mb-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100 dark:bg-slate-800">
                        <div id="quiz-progress" class="h-full bg-indigo-500 transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-start mb-6 mt-2">
                        <span
                            class="inline-block bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-3 py-1 rounded-md text-xs font-bold tracking-wide uppercase border border-indigo-100 dark:border-indigo-800"
                            id="q-category">Category</span>
                        <a href="index.html" class="flex items-center gap-3 hover:opacity-75 transition"
                            title="ポータル画面に戻る">
                            <button onclick="app.toggleBookmark()" id="btn-quiz-bookmark"
                                class="text-slate-300 hover:text-yellow-400 transition transform hover:scale-110 focus:outline-none">
                                <svg class="w-6 h-6 fill-current" viewBox="0 0 20 20">
                                    <path
                                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z">
                                    </path>
                                </svg>
                            </button>
                            <div class="font-mono text-slate-300 font-bold text-xl"><span id="q-current"
                                    class="text-slate-800 dark:text-white">1</span><span class="text-sm">/</span><span
                                    id="q-total" class="text-sm">10</span></div>
                        </a>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-100 mb-6 leading-relaxed whitespace-pre-wrap"
                        id="q-text">Problem Text</h3>
                    <div id="code-container"
                        class="bg-[#1e1e1e] rounded-lg overflow-hidden mb-6 relative group hidden border border-slate-700 shadow-inner">
                        <pre
                            class="!m-0 !p-5 overflow-x-auto text-sm"><code class="language-java code-input text-gray-100 leading-6 font-mono" id="code-content"></code></pre>
                    </div>
                </div>
                <div id="options-list" class="grid gap-3 mb-10"></div>
                <button id="btn-submit-answer" onclick="app.submitAnswer()"
                    class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-[0.98] mb-8 text-lg">回答する
                    (Enter)</button>

                <!-- Explanation with Memo -->
                <div id="explanation-box"
                    class="hidden bg-white dark:bg-darkcard border border-emerald-100 dark:border-emerald-900/50 rounded-2xl p-6 md:p-8 shadow-lg fade-in relative overflow-hidden ring-4 ring-emerald-50 dark:ring-emerald-900/20">
                    <div class="absolute top-0 right-0 p-6 opacity-10"><svg class="w-32 h-32 text-emerald-600"
                            fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4"><span id="result-badge"
                                class="font-bold text-xl"></span></div>
                        <div class="text-slate-700 dark:text-slate-300 text-sm md:text-base leading-8 whitespace-pre-wrap font-mono mb-8"
                            id="explanation-text"></div>

                        <!-- Image Display in Explanation -->
                        <div id="explanation-image-container" class="mb-8 hidden">
                            <img id="explanation-img" src=""
                                class="max-w-full rounded-lg border border-slate-200 dark:border-slate-600 shadow-md">
                        </div>

                        <!-- NEW: Memo Feature -->
                        <div
                            class="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl p-4 border border-indigo-100 dark:border-indigo-800 mb-6">
                            <h4
                                class="text-xs font-bold text-indigo-500 dark:text-indigo-400 uppercase tracking-wider mb-2 flex items-center gap-1">
                                <span>✏️</span> 自分用メモ
                            </h4>
                            <textarea id="user-note-input"
                                class="w-full bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-800 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white"
                                rows="2" placeholder="ここが間違えやすい、○○メソッドは××など..."></textarea>
                            <div class="flex justify-end mt-2">
                                <button onclick="app.saveNote()"
                                    class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 transition font-bold">メモを保存</button>
                            </div>
                        </div>

                        <button onclick="app.nextQuestion()"
                            class="w-full bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2 active:scale-[0.98]">
                            <span>次の問題へ (Enter)</span><svg class="w-5 h-5" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="session-result"
            class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div
                class="bg-white dark:bg-darkcard rounded-2xl shadow-2xl max-w-sm w-full p-8 text-center space-y-6 fade-in transform scale-100">
                <div class="text-6xl mb-2 animate-bounce">🎉</div>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white">お疲れ様でした！</h3>
                <div
                    class="grid grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-800 p-5 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">正解数</div>
                        <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-1"><span
                                id="res-score">0</span></div>
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">正解率</div>
                        <div class="text-3xl font-bold text-slate-800 dark:text-white mt-1" id="res-rate">0%</div>
                    </div>
                </div>
                <button onclick="app.closeSessionResult()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95">OK</button>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script>
        // Global Error Handler
        window.onerror = function (message, source, lineno, colno, error) {
            const errDiv = document.getElementById('global-error-display');
            errDiv.style.display = 'block';
            errDiv.innerText = `Error: ${message} at line ${lineno}`;
            console.error('Global Error Caught:', error);
        };

        var STORAGE_KEY = 'javaSilverDojo_GlobalData';
        var LEGACY_KEYS = ['javaSilverAI_v14_2', 'javaSilverAI_v14_8'];

        // Updated Chapter Map based on Official Exams
        const CHAPTER_TITLES = {
            1: "簡単なJAVAプログラムの作成",
            2: "基本データ型と文字列操作",
            3: "演算子と判定構造",
            4: "制御構造",
            5: "配列の操作",
            6: "インスタンスとメソッド",
            7: "クラスの継承、インターフェイス、抽象クラス",
            8: "関数型インターフェイス、ラムダ式",
            9: "API",
            10: "例外処理",
            11: "モジュールシステム"
        };

        var codingDrills = [
            { id: 'c1', title: 'Hello World', tag: '基本', desc: 'Mainクラスを作成し、mainメソッド内で "Hello World" と出力してください。', keywords: ['class', 'Main', 'public', 'static', 'void', 'main', 'System.out.println', 'Hello World'], answer: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}' },
            { id: 'c2', title: '変数の宣言', tag: '基本', desc: 'int型の変数 num を宣言して 10 を代入し、その値を出力してください。', keywords: ['int', 'num', '=', '10', 'System.out.println'], answer: 'public class Main {\n    public static void main(String[] args) {\n        int num = 10;\n        System.out.println(num);\n    }\n}' },
            { id: 'c3', title: '条件分岐 (if)', tag: '基本', desc: 'int型の変数 score が 80 以上の場合は "Pass"、それ以外は "Fail" と出力してください。', keywords: ['if', 'else', '>=', 'System.out.println'], answer: 'int score = 85;\nif (score >= 80) {\n    System.out.println("Pass");\n} else {\n    System.out.println("Fail");\n}' },
            { id: 'c4', title: 'ループ (for)', tag: '基本', desc: 'for文を使って、0から4までの数字を順番に出力してください。', keywords: ['for', 'int', 'i', '<', '++', 'System.out.println'], answer: 'for (int i = 0; i < 5; i++) {\n    System.out.println(i);\n}' },
            { id: 'c5', title: '配列の操作', tag: '基本', desc: 'String型の配列 colors を作成し、"Red", "Blue", "Green" を格納して、拡張for文ですべて出力してください。', keywords: ['String[]', 'colors', '{', '}', 'for', 'String', 'System.out.println'], answer: 'String[] colors = {"Red", "Blue", "Green"};\nfor (String color : colors) {\n    System.out.println(color);\n}' },
            { id: 'c6', title: '文字列の長さ', tag: '初級', desc: 'String型の変数 str に "Java" を代入し、その文字数（長さ）を出力してください。', keywords: ['String', 'str', 'length()', 'System.out.println'], answer: 'String str = "Java";\nSystem.out.println(str.length());' },
            { id: 'c7', title: 'Switch文', tag: '初級', desc: 'int型の変数 day が 1 の場合は "Monday"、2 の場合は "Tuesday"、それ以外は "Other" と出力する switch 文を書いてください。', keywords: ['switch', 'case', 'break', 'default', 'System.out.println'], answer: 'int day = 1;\nswitch (day) {\n    case 1:\n        System.out.println("Monday");\n        break;\n    case 2:\n        System.out.println("Tuesday");\n        break;\n    default:\n        System.out.println("Other");\n        break;\n}' },
            { id: 'c8', title: '型変換 (Cast)', tag: '初級', desc: 'double型の変数 d に 9.9 を代入し、それを int型にキャストして変数 i に代入した後、i を出力してください。', keywords: ['double', 'int', '(int)', 'System.out.println'], answer: 'double d = 9.9;\nint i = (int) d;\nSystem.out.println(i);' },
            { id: 'c9', title: 'クラスの定義', tag: '中級 (OOP)', desc: 'name フィールド（String）を持つ Person クラスを定義してください。', keywords: ['class', 'Person', 'String', 'name'], answer: 'class Person {\n    String name;\n}' },
            { id: 'c10', title: 'コンストラクタ', tag: '中級 (OOP)', desc: 'Person クラスに、name を引数として受け取り初期化するコンストラクタを追加してください。', keywords: ['Person', 'String', 'this.name', '='], answer: 'class Person {\n    String name;\n    public Person(String name) {\n        this.name = name;\n    }\n}' },
            { id: 'c11', title: 'メソッド定義', tag: '中級 (OOP)', desc: '2つの int 型引数を受け取り、その和を返す静的メソッド add を定義してください。', keywords: ['public', 'static', 'int', 'add', 'return', '+'], answer: 'public static int add(int a, int b) {\n    return a + b;\n}' },
            { id: 'c12', title: 'オーバーライド', tag: '中級 (OOP)', desc: 'Object クラスの toString メソッドをオーバーライドし、"MyObject" という文字列を返すようにしてください。', keywords: ['@Override', 'public', 'String', 'toString', 'return'], answer: '@Override\npublic String toString() {\n    return "MyObject";\n}' },
            { id: 'c13', title: 'カプセル化', tag: '中級 (OOP)', desc: 'private な int 型フィールド age を持ち、その getter と setter メソッドを持つクラス定義の一部を書いてください。', keywords: ['private', 'int', 'age', 'public', 'getAge', 'setAge', 'return', 'this.age'], answer: 'private int age;\n\npublic int getAge() {\n    return age;\n}\n\npublic void setAge(int age) {\n    this.age = age;\n}' },
            { id: 'c14', title: '例外処理', tag: '上級 (Silver)', desc: '0除算の可能性がある処理を try-catch ブロックで囲み、ArithmeticException をキャッチして "Error" と出力してください。', keywords: ['try', 'catch', 'ArithmeticException', 'System.out.println'], answer: 'try {\n    int result = 10 / 0;\n} catch (ArithmeticException e) {\n    System.out.println("Error");\n}' },
            { id: 'c15', title: 'インターフェース', tag: '上級 (Silver)', desc: 'greet メソッド（引数なし、戻り値void）を持つ Greeter インターフェースを定義してください。', keywords: ['interface', 'Greeter', 'void', 'greet'], answer: 'interface Greeter {\n    void greet();\n}' },
            { id: 'c16', title: 'ラムダ式', tag: '上級 (Silver)', desc: 'List<String> list の各要素を、forEach メソッドとラムダ式を使って出力してください。', keywords: ['list.forEach', '->', 'System.out.println'], answer: 'list.forEach(s -> System.out.println(s));' },
            { id: 'c17', title: 'StringBuilder', tag: '試験対策', desc: 'StringBuilder を使って "A" に "B" を追加し、さらに "C" を追加して文字列として出力してください。', keywords: ['StringBuilder', 'new', 'append', 'toString', 'System.out.println'], answer: 'StringBuilder sb = new StringBuilder("A");\nsb.append("B").append("C");\nSystem.out.println(sb.toString());' },
            { id: 'c18', title: '文字列比較', tag: '試験対策', desc: 'String型の変数 s1 と s2 の内容が等しいかどうかを判定するif文を書いてください（nullチェックは不要）。', keywords: ['if', 's1.equals(s2)'], answer: 'if (s1.equals(s2)) {\n    // 処理\n}' },
            { id: 'c19', title: 'Map操作', tag: '業務実践', desc: 'HashMap<String, Integer> を作成し、キー "Apple" に 100 を追加し、その後 "Apple" の値を取得して出力してください。', keywords: ['HashMap', 'put', 'get', 'System.out.println'], answer: 'Map<String, Integer> map = new HashMap<>();\nmap.put("Apple", 100);\nSystem.out.println(map.get("Apple"));' },
            { id: 'c20', title: 'リスト抽出', tag: '業務実践', desc: 'Integer型のリスト nums から、偶数だけを拡張for文とif文で出力してください。', keywords: ['for', 'if', '%', '==', '0', 'System.out.println'], answer: 'for (Integer n : nums) {\n    if (n % 2 == 0) {\n        System.out.println(n);\n    }\n}' },
            { id: 'c21', title: 'Staticメソッド呼び出し', tag: '中級 (OOP)', desc: 'Mathクラスのmaxメソッドを使って、10と20のうち大きい方を表示してください。', keywords: ['Math.max', 'System.out.println'], answer: 'System.out.println(Math.max(10, 20));' }
        ];

        // --- MODULES DEFINITIONS ---

        var aiTutor = {
            apiKey: '',
            model: 'gemini-2.5-flash-preview-09-2025',
            init: function () {
                try {
                    this.apiKey = localStorage.getItem('gemini_api_key') || '';
                    var savedModel = localStorage.getItem('gemini_api_model');
                    if (savedModel && (savedModel.includes('gemini-2.5') || savedModel === 'custom')) {
                        this.model = savedModel;
                    } else {
                        this.model = 'gemini-2.5-flash-preview-09-2025';
                    }

                    var select = document.getElementById('api-model-select');
                    if (select) {
                        if (this.model === 'gemini-2.5-flash-preview-09-2025') {
                            select.value = this.model;
                            document.getElementById('api-model-custom').classList.add('hidden');
                        } else {
                            select.value = 'custom';
                            document.getElementById('api-model-custom').classList.remove('hidden');
                            document.getElementById('api-model-custom').value = this.model;
                        }
                    }
                    this.updateStatus();
                } catch (e) { console.warn("AI Init failed", e); }
            },
            toggleCustomModelInput: function () {
                var val = document.getElementById('api-model-select').value;
                var customInput = document.getElementById('api-model-custom');
                if (val === 'custom') customInput.classList.remove('hidden');
                else customInput.classList.add('hidden');
            },
            saveKey: function () {
                var key = document.getElementById('api-key-input').value.trim();
                var model = document.getElementById('api-model-select').value;
                if (model === 'custom') model = document.getElementById('api-model-custom').value.trim();
                if (key) localStorage.setItem('gemini_api_key', key);
                localStorage.setItem('gemini_api_model', model);
                this.model = model;
                alert('設定を保存しました。');
                this.init();
            },
            updateStatus: function () {
                var statusEl = document.getElementById('key-status');
                var btn = document.getElementById('btn-get-advice');
                if (this.apiKey) {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> 設定済み';
                    statusEl.className = 'text-xs text-emerald-600 mt-2 flex items-center gap-1 font-bold';
                    if (btn) btn.disabled = false;
                } else {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-slate-300"></span> 未設定';
                    statusEl.className = 'text-xs text-slate-400 mt-2 flex items-center gap-1';
                    if (btn) btn.disabled = true;
                }
            },
            analyzeStats: function () {
                if (!app || !app.data) return { weakCategories: [], recentMistakes: [] };

                var wrongCounts = {};
                var totalCounts = {};
                app.data.questions.forEach(q => {
                    var cat = q.category || "その他";
                    totalCounts[cat] = (totalCounts[cat] || 0) + 1;
                    if (app.data.results[q.id] === false) {
                        wrongCounts[cat] = (wrongCounts[cat] || 0) + 1;
                    }
                });

                var weakCategories = Object.keys(wrongCounts)
                    .sort((a, b) => wrongCounts[b] - wrongCounts[a])
                    .slice(0, 3);

                var recentMistakes = [];
                var wrongQs = app.data.questions.filter(q => app.data.results[q.id] === false);
                recentMistakes = wrongQs.sort(() => 0.5 - Math.random()).slice(0, 3).map(q => {
                    return {
                        category: q.category,
                        text: q.text,
                        correctAnswer: Array.isArray(q.options) && typeof q.answer === 'number' ? q.options[q.answer] : "N/A"
                    };
                });

                return { weakCategories, recentMistakes };
            },
            updateWeaknessDisplay: function () {
                var stats = this.analyzeStats();
                var text = stats.weakCategories.length > 0 ? stats.weakCategories.join('、') : "データ不足";
                var el = document.getElementById('ai-weak-text');
                var container = document.getElementById('ai-analysis-stats');
                if (el) el.innerText = text;
                if (container) container.classList.remove('hidden');
            },
            getAdvice: async function () {
                var stats = this.analyzeStats();
                var btn = document.getElementById('btn-get-advice');
                var loading = document.getElementById('ai-loading');
                var outputBox = document.getElementById('ai-output-box');
                var contentDiv = document.getElementById('ai-response-content');

                btn.classList.add('hidden');
                loading.classList.remove('hidden');
                outputBox.classList.add('hidden');

                var weaknessStr = stats.weakCategories.length ? stats.weakCategories.join(', ') : "まだデータがありません";
                var mistakesStr = stats.recentMistakes.map((m, i) =>
                    `[${i + 1}] 分野:${m.category}\n問題:${m.text}\n正解:${m.correctAnswer}`
                ).join('\n---\n');

                var prompt = `
あなたはJava Silver (SE11) 資格試験の熱血かつ論理的なベテラン講師です。
生徒（ユーザー）の学習履歴データを分析し、日本語でアドバイスをしてください。

【生徒データ】
・現在の苦手分野: ${weaknessStr}
・最近間違えた問題の例:
${mistakesStr || "（まだ間違いデータがありません）"}

【指示】
1. 生徒の苦手分野傾向を分析し、なぜそこでつまずきやすいか簡潔に解説してください。
2. 今後の学習戦略（どの章を重点的にやるべきか）を提案してください。
3. 「オリジナル問題作成」機能を使っている生徒に対して、「次は〇〇についてのひっかけ問題を作ってみよう」といった、理解を深めるための作問テーマを1つ提案してください。
4. **重要**: アドバイス内にJavaのコード例を示す場合は、必ず \`\`\`java ... \`\`\` の形式で記述してください。
5. 口調は「～だね」「～しよう！」といった、親しみやすくも頼れる先生のトーンでお願いします。Markdown形式で見やすく整形してください。
`;

                var fetchWithRetry = async (model, retries = 1) => {
                    var url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${this.apiKey}`;
                    try {
                        var res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!res.ok) {
                            if (res.status === 429 && retries > 0) {
                                await new Promise(r => setTimeout(r, 3000));
                                return fetchWithRetry(model, retries - 1);
                            }
                            var err = await res.json().catch(() => ({}));
                            throw new Error(err.error?.message || res.statusText);
                        }
                        return res.json();
                    } catch (e) { throw e; }
                };

                try {
                    var data = await fetchWithRetry(this.model);
                    var text = data.candidates[0].content.parts[0].text;

                    if (typeof marked !== 'undefined') {
                        contentDiv.innerHTML = marked.parse(text);
                        if (typeof Prism !== 'undefined') {
                            setTimeout(() => {
                                contentDiv.querySelectorAll('pre code').forEach((block) => {
                                    block.classList.add('language-java');
                                    Prism.highlightElement(block);
                                });
                            }, 10);
                        }
                    } else {
                        var formatted = text
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                            .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                            .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                            .replace(/\n/gim, '<br>');
                        contentDiv.innerHTML = formatted;
                    }

                    outputBox.classList.remove('hidden');
                } catch (e) {
                    alert(`AI通信エラー: ${e.message}`);
                } finally {
                    btn.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            }
        };

        var creator = {
            categoryNames: {
                "1": "簡単なJAVAプログラムの作成",
                "2": "基本データ型と文字列操作",
                "3": "演算子と判定構造",
                "4": "制御構造",
                "5": "配列の操作",
                "6": "インスタンスとメソッド",
                "7": "クラスの継承、インターフェイス、抽象クラス",
                "8": "関数型インターフェイス、ラムダ式",
                "9": "API",
                "10": "例外処理",
                "11": "モジュールシステム",
                "mock1": "模擬試験①",
                "mock2": "模擬試験②",
                "mock3": "模擬試験③",
                "99": "その他"
            },
            currentImage: null, // Temporary store for image
            updateCategoryLabel: function () { var val = document.getElementById('create-chapter').value; document.getElementById('create-cat-name').value = this.categoryNames[val]; },
            addOption: function () {
                var container = document.getElementById('options-container');
                var idx = container.children.length;
                var div = document.createElement('div');
                div.className = "flex items-start gap-3 option-row";
                div.innerHTML = `
                    <input type="checkbox" name="correct-idx" value="${idx}" class="w-5 h-5 mt-2 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                    <textarea class="create-option flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition resize-y dark:text-white" rows="2" placeholder="選択肢 ${String.fromCharCode(65 + idx)}" required></textarea>
                    <button type="button" onclick="creator.removeOption(this)" class="text-slate-400 hover:text-red-500 px-2 font-bold text-lg mt-1">×</button>
                `;
                container.appendChild(div);
            },
            removeOption: function (btn) { btn.closest('.option-row').remove(); this.reindexOptions(); },
            reindexOptions: function () {
                var rows = document.querySelectorAll('.option-row');
                rows.forEach((row, index) => {
                    row.querySelector('input[type="checkbox"]').value = index;
                    row.querySelector('.create-option').placeholder = `選択肢 ${String.fromCharCode(65 + index)}`;
                });
            },
            resetForm: function () {
                document.getElementById('create-form').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('options-container').innerHTML = '';
                for (var i = 0; i < 4; i++) this.addOption();
                var btn = document.getElementById('btn-save-question');
                btn.innerText = "追加する";
                btn.className = "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5";
                document.getElementById('btn-cancel-edit').classList.add('hidden');

                this.currentImage = null;
                document.getElementById('explanation-image-preview').classList.add('hidden');
                document.getElementById('preview-img').src = "";

                this.updateCategoryLabel();
                this.setupPasteListener();
            },
            setupPasteListener: function () {
                var area = document.getElementById('create-explanation');
                // Remove old listeners to avoid duplicates
                var newArea = area.cloneNode(true);
                area.parentNode.replaceChild(newArea, area);
                newArea.addEventListener('paste', this.handlePaste.bind(this));
                newArea.id = 'create-explanation'; // Restore ID
            },
            handlePaste: function (e) {
                var items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") === 0) {
                        e.preventDefault();
                        var blob = items[i].getAsFile();
                        this.compressImage(blob);
                        return;
                    }
                }
            },
            compressImage: function (file) {
                var reader = new FileReader();
                reader.onload = (event) => {
                    var img = new Image();
                    img.onload = () => {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var maxWidth = 600;
                        var scale = maxWidth / img.width;
                        if (scale > 1) scale = 1;

                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // JPEG compression 0.7
                        var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        this.currentImage = dataUrl;

                        // Show Preview
                        var preview = document.getElementById('explanation-image-preview');
                        var previewImg = document.getElementById('preview-img');
                        previewImg.src = dataUrl;
                        preview.classList.remove('hidden');
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            },
            removeImage: function () {
                this.currentImage = null;
                document.getElementById('explanation-image-preview').classList.add('hidden');
                document.getElementById('preview-img').src = "";
            },
            renderUserQuestions: function () {
                var listEl = document.getElementById('user-questions-list');
                var userQs = app.data.questions.filter(q => q.id.includes('user'));
                listEl.innerHTML = '';
                if (userQs.length === 0) { listEl.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">まだ自作問題はありません</div>'; return; }
                [...userQs].reverse().forEach(q => {
                    var div = document.createElement('div');
                    div.className = "flex justify-between items-start bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-600 hover:border-indigo-300 dark:hover:border-indigo-700 transition";
                    div.innerHTML = `<div class="flex-1 pr-2"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-2 py-0.5 rounded font-bold whitespace-nowrap">${q.category}</span></div><p class="text-sm text-slate-700 dark:text-slate-300 font-medium line-clamp-2">${q.text}</p></div><div class="flex flex-col gap-2"><button onclick="creator.editQuestion('${q.id}')" class="text-xs bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-500 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:text-indigo-600 dark:hover:text-indigo-300 transition">編集</button><button onclick="creator.deleteQuestion('${q.id}')" class="text-xs bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-500 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded hover:bg-red-50 dark:hover:bg-red-900 hover:text-red-600 dark:hover:text-red-300 transition">削除</button></div>`;
                    listEl.appendChild(div);
                });
            },
            editQuestion: function (id) {
                var q = app.data.questions.find(x => x.id === id);
                if (!q) return;
                document.getElementById('edit-id').value = q.id;
                document.getElementById('create-text').value = q.text;
                document.getElementById('create-code').value = q.code || '';
                document.getElementById('create-explanation').value = q.explanation;

                // Restore Image
                if (q.explanationImage) {
                    this.currentImage = q.explanationImage;
                    document.getElementById('preview-img').src = q.explanationImage;
                    document.getElementById('explanation-image-preview').classList.remove('hidden');
                } else {
                    this.removeImage();
                }

                var select = document.getElementById('create-chapter');
                var options = Array.from(select.options);
                var found = options.find(o => o.text.includes(q.category));
                if (found) select.value = found.value;

                var container = document.getElementById('options-container');
                container.innerHTML = '';
                q.options.forEach((optText) => {
                    this.addOption();
                    var inputs = container.querySelectorAll('.create-option');
                    inputs[inputs.length - 1].value = optText;
                });

                var checkboxes = document.querySelectorAll('input[name="correct-idx"]');
                var correctArr = Array.isArray(q.answer) ? q.answer : [q.answer];
                correctArr.forEach(idx => { if (checkboxes[idx]) checkboxes[idx].checked = true; });

                var btn = document.getElementById('btn-save-question');
                btn.innerText = "更新する";
                btn.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5";
                document.getElementById('btn-cancel-edit').classList.remove('hidden');
                document.getElementById('tab-create').scrollTop = 0;
            },
            cancelEdit: function () { this.resetForm(); },
            deleteQuestion: function (id) {
                if (!confirm('この問題を削除しますか？')) return;
                app.data.questions = app.data.questions.filter(q => q.id !== id);
                app.save();
                this.renderUserQuestions();
            },
            saveQuestion: function (e) {
                e.preventDefault();
                var editId = document.getElementById('edit-id').value;
                var chapterNum = document.getElementById('create-chapter').value;
                var select = document.getElementById('create-chapter');
                var chapterName = select.options[select.selectedIndex].text.replace(/^\d+:\s*/, '');

                var text = document.getElementById('create-text').value;
                var code = document.getElementById('create-code').value;

                var opts = Array.from(document.querySelectorAll('.create-option')).map(i => i.value);
                var checkedBoxes = document.querySelectorAll('input[name="correct-idx"]:checked');
                if (checkedBoxes.length === 0) return alert("正解を少なくとも1つ選択してください");

                var correctIdxs = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
                var finalAnswer = correctIdxs.length === 1 ? correctIdxs[0] : correctIdxs;

                var explanation = document.getElementById('create-explanation').value;

                if (editId) {
                    var index = app.data.questions.findIndex(q => q.id === editId);
                    if (index !== -1) {
                        app.data.questions[index] = {
                            ...app.data.questions[index],
                            category: chapterName,
                            text: text,
                            code: code,
                            options: opts,
                            answer: finalAnswer,
                            explanation: explanation,
                            explanationImage: this.currentImage // Save Image
                        };
                        alert('問題を更新しました！');
                    }
                    this.cancelEdit();
                } else {
                    var idPrefix = `user-${chapterNum}-`;
                    var newId = idPrefix + Date.now();
                    var newQ = {
                        id: newId,
                        category: chapterName,
                        text: text,
                        code: code,
                        options: opts,
                        answer: finalAnswer,
                        explanation: explanation,
                        explanationImage: this.currentImage // Save Image
                    };
                    app.data.questions.push(newQ);
                    alert(`問題を追加しました！`);
                    this.resetForm();
                }
                app.save();
                this.renderUserQuestions();
            }
        };

        var dataManager = {
            importData: function (input) {
                if (input.files.length === 0) return;
                var readers = Array.from(input.files).map(file => new Promise(r => {
                    var reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsText(file);
                }));

                Promise.all(readers).then(results => {
                    var qCount = 0;
                    var hCount = 0;
                    var updateCount = 0;
                    var newQs = [];
                    var seenIds = new Set(app.data.questions.map(q => q.id));
                    var existingHistoryDates = new Set(app.data.history.map(h => h.date));

                    results.forEach(res => {
                        try {
                            var json = JSON.parse(res);
                            var questionsSource = Array.isArray(json) ? json : (json.questions || []);

                            questionsSource.forEach(q => {
                                if (q.id) {
                                    if (!seenIds.has(q.id)) {
                                        newQs.push(q);
                                        seenIds.add(q.id);
                                        qCount++;
                                    } else {
                                        var idx = app.data.questions.findIndex(existing => existing.id === q.id);
                                        if (idx !== -1) {
                                            app.data.questions[idx] = q;
                                            updateCount++;
                                        }
                                    }
                                }
                            });

                            if (!Array.isArray(json) && json.history) {
                                json.history.forEach(h => {
                                    if (!existingHistoryDates.has(h.date)) {
                                        app.data.history.push(h);
                                        existingHistoryDates.add(h.date);
                                        hCount++;
                                    }
                                });
                            }
                            if (!Array.isArray(json) && json.results) {
                                app.data.results = { ...app.data.results, ...json.results };
                            }
                            if (!Array.isArray(json) && json.bookmarks) {
                                var newBm = json.bookmarks.filter(b => !app.data.bookmarks.includes(b));
                                app.data.bookmarks = [...app.data.bookmarks, ...newBm];
                            }

                        } catch (e) {
                            console.error("JSON Parse Error:", e);
                            alert("一部のファイルを読み込めませんでした。JSON形式を確認してください。");
                        }
                    });

                    if (qCount > 0 || hCount > 0 || updateCount > 0) {
                        if (qCount > 0) app.data.questions = [...app.data.questions, ...newQs];
                        app.data.history.sort((a, b) => a.date - b.date);

                        app.save();
                        var msg = `読み込み完了！\n`;
                        if (qCount > 0) msg += `・新規追加: ${qCount}問\n`;
                        if (updateCount > 0) msg += `・上書き更新: ${updateCount}問\n`;
                        if (hCount > 0) msg += `・履歴同期: ${hCount}件\n`;
                        alert(msg);
                        app.updateDashboard();

                        if (typeof aiTutor !== 'undefined') aiTutor.updateWeaknessDisplay();
                        if (typeof creator !== 'undefined') creator.renderUserQuestions();
                    } else {
                        alert('新しいデータは見つかりませんでした。\n（すでに全て最新の状態か、データの形式が異なります）');
                    }
                    input.value = '';
                });
            },
            resetAll: function () { if (confirm('全てのデータを削除しますか？\n（学習履歴も消えます）')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } },
            generateDemoData: function () {
                var now = Date.now();
                var dummyHistory = [
                    { date: now - 10000000, correct: 5, total: 10, mode: '第1章', weak: ['簡単なJAVAプログラムの作成', '基本データ型と文字列操作'] },
                    { date: now - 5000000, correct: 2, total: 5, mode: '第3章', weak: ['演算子と判定構造', '簡単なJAVAプログラムの作成'] },
                    { date: now, correct: 8, total: 10, mode: '模擬試験', weak: ['例外処理', 'ポリモーフィズム', '簡単なJAVAプログラムの作成'] }
                ];
                app.data.history = [...app.data.history, ...dummyHistory];
                app.save();
                alert('テスト用の学習履歴を追加しました。「記録」タブを確認してください。');
                app.renderHistory();
            },
            exportData: function () {
                var dataStr = JSON.stringify(app.data, null, 2);
                var blob = new Blob([dataStr], { type: "application/json" });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = `java_silver_data_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            }
        };

        var codingApp = {
            currentDrill: null,
            init: function () {
                var menu = document.getElementById('coding-menu');
                menu.innerHTML = '';

                codingDrills.forEach(drill => {
                    var btn = document.createElement('button');
                    btn.className = "bg-white dark:bg-darkcard border border-slate-200 dark:border-slate-700 hover:border-indigo-400 dark:hover:border-indigo-500 rounded-xl p-5 text-left transition shadow-sm group active:scale-[0.99]";
                    btn.onclick = () => this.start(drill);
                    btn.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded">${drill.tag}</span>
                            <span class="text-xl group-hover:scale-110 transition">⚡️</span>
                        </div>
                        <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-1">${drill.title}</h4>
                        <p class="text-xs text-slate-400 line-clamp-2">${drill.desc}</p>
                    `;
                    menu.appendChild(btn);
                });
            },
            start: function (drill) {
                this.currentDrill = drill;
                document.getElementById('coding-menu').classList.add('hidden');
                document.getElementById('coding-workspace').classList.remove('hidden');
                document.getElementById('coding-title').innerText = drill.title;
                document.getElementById('coding-tag').innerText = drill.tag;
                document.getElementById('coding-desc').innerText = drill.desc;
                if (drill.keywords && drill.keywords.length > 0) {
                    document.getElementById('coding-hint-box').classList.remove('hidden');
                    var kwDiv = document.getElementById('coding-keywords');
                    kwDiv.innerHTML = drill.keywords.map(k => `<span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] px-2 py-1 rounded border border-slate-200 dark:border-slate-600 font-mono">${k}</span>`).join('');
                } else {
                    document.getElementById('coding-hint-box').classList.add('hidden');
                }
                var editor = document.getElementById('coding-editor');
                editor.value = '';
                editor.focus();
                document.getElementById('coding-result').classList.add('hidden');
            },
            close: function () {
                document.getElementById('coding-menu').classList.remove('hidden');
                document.getElementById('coding-workspace').classList.add('hidden');
                this.currentDrill = null;
            },
            check: function () {
                if (!this.currentDrill) return;
                var userCode = document.getElementById('coding-editor').value;
                var keywords = this.currentDrill.keywords || [];
                var missing = keywords.filter(k => !userCode.includes(k));
                var isPerfect = missing.length === 0;
                var resultTitle = document.getElementById('coding-result-title');
                var resultMsg = document.getElementById('coding-result-msg');
                var answerCode = document.getElementById('coding-answer-code');
                if (isPerfect) {
                    resultTitle.innerHTML = '<span class="text-emerald-500">🎉 Excellent!</span>';
                    resultMsg.innerText = '必須キーワードがすべて含まれています。';
                } else {
                    resultTitle.innerHTML = '<span class="text-amber-500">⚠️ Keep Trying</span>';
                    resultMsg.innerText = `以下のキーワードが見つかりません: ${missing.join(', ')}`;
                }
                answerCode.textContent = this.currentDrill.answer;
                if (typeof Prism !== 'undefined') Prism.highlightElement(answerCode);
                document.getElementById('coding-result').classList.remove('hidden');
            },
            showAnswer: function () {
                if (!this.currentDrill) return;
                var resultTitle = document.getElementById('coding-result-title');
                var resultMsg = document.getElementById('coding-result-msg');
                var answerCode = document.getElementById('coding-answer-code');
                resultTitle.innerHTML = '<span class="text-indigo-500">👀 模範解答</span>';
                resultMsg.innerText = '解答例を確認して、自分のコードと比較してみましょう。';
                answerCode.textContent = this.currentDrill.answer;
                if (typeof Prism !== 'undefined') Prism.highlightElement(answerCode);
                document.getElementById('coding-result').classList.remove('hidden');
            }
        };

        var app = {
            data: { questions: [], results: {}, history: [], bookmarks: [], theme: 'light' },
            state: { queue: [], currentIdx: 0, sessionStats: { correct: 0, wrongInfo: [] }, modeName: '', timer: null, currentSelection: new Set(), isQuizActive: false },
            chartInstance: null,
            categoryLinks: {
                "簡単なJAVAプログラムの作成": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/lang/package-summary.html",
                "基本データ型と文字列操作": "https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html",
                "演算子と判定構造": "https://docs.oracle.com/javase/tutorial/java/nutsandbolts/operators.html",
                "制御構造": "https://docs.oracle.com/javase/tutorial/java/nutsandbolts/flow.html",
                "配列の操作": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/util/Arrays.html",
                "インスタンスとメソッド": "https://docs.oracle.com/javase/tutorial/java/javaOO/classes.html",
                "クラスの継承、インターフェイス、抽象クラス": "https://docs.oracle.com/javase/tutorial/java/IandI/subclasses.html",
                "関数型インターフェイス、ラムダ式": "https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html",
                "API": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/time/LocalDate.html",
                "例外処理": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/lang/Exception.html",
                "モジュールシステム": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/lang/module/package-summary.html"
            },
            init: function () {
                try {
                    this.loadData();
                    this.applyTheme();
                    this.switchTab('dashboard');

                    // Safe init of modules
                    if (typeof aiTutor !== 'undefined') {
                        setTimeout(function () { aiTutor.init(); }, 100);
                    }
                    if (typeof creator !== 'undefined') creator.resetForm();
                    if (typeof codingApp !== 'undefined') codingApp.init();

                    this.setupKeyboardShortcuts();
                } catch (e) {
                    console.error("App Init Error:", e);
                    alert("初期化エラー: " + e.message);
                }
            },
            setupKeyboardShortcuts: function () {
                document.addEventListener('keydown', (e) => {
                    if (!this.state.isQuizActive) return;
                    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
                    var key = e.key.toUpperCase();
                    var map = { '1': 0, '2': 1, '3': 2, '4': 3, 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
                    if (key in map) {
                        if (!document.getElementById('explanation-box').classList.contains('hidden')) return;
                        var idx = map[key];
                        var btn = document.getElementById(`option-btn-${idx}`);
                        if (btn) this.selectOption(idx, btn);
                    }
                    if (key === 'ENTER') {
                        e.preventDefault();
                        var submitBtn = document.getElementById('btn-submit-answer');
                        var resultBox = document.getElementById('explanation-box');
                        if (!resultBox.classList.contains('hidden')) { this.nextQuestion(); return; }
                        if (submitBtn && !submitBtn.classList.contains('hidden')) { this.submitAnswer(); }
                    }
                    if (key === 'B') { this.toggleBookmark(); }
                });
            },
            toggleTheme: function () {
                this.data.theme = this.data.theme === 'dark' ? 'light' : 'dark';
                this.applyTheme();
                this.save();
            },
            applyTheme: function () {
                var html = document.documentElement;
                var circle = document.getElementById('theme-toggle-circle');
                if (this.data.theme === 'dark') {
                    html.classList.add('dark');
                    if (circle) circle.classList.add('translate-x-5');
                } else {
                    html.classList.remove('dark');
                    if (circle) circle.classList.remove('translate-x-5');
                }
            },
            loadData: function () {
                try {
                    var saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) { this.data = { ...this.data, ...JSON.parse(saved) }; }
                    else {
                        for (var i = 0; i < LEGACY_KEYS.length; i++) {
                            var d = localStorage.getItem(LEGACY_KEYS[i]);
                            if (d) { this.data = { ...this.data, ...JSON.parse(d) }; this.save(); break; }
                        }
                    }
                    if (!Array.isArray(this.data.history)) this.data.history = [];
                    if (!Array.isArray(this.data.bookmarks)) this.data.bookmarks = [];
                    if (!Array.isArray(this.data.questions)) this.data.questions = [];
                    this.updateDashboard();
                } catch (e) { console.error("Load error", e); }
            },
            save: function () {
                try {
                    if (this.data.history.length > 100) this.data.history = this.data.history.slice(-100);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                    this.updateDashboard();
                } catch (e) { console.error("Save error", e); }
            },
            switchTab: function (tab) {
                if (tab !== 'quiz-view') this.state.isQuizActive = false;
                ['dashboard', 'ai', 'history', 'create', 'quiz-view', 'settings', 'coding'].forEach(id => {
                    document.getElementById('tab-' + id)?.classList.add('hidden');
                    var btn = document.getElementById('nav-' + id);
                    if (btn) { btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm', 'dark:bg-slate-700', 'dark:text-white'); btn.classList.add('text-slate-600', 'dark:text-slate-400'); }
                });
                var target = document.getElementById('tab-' + tab);
                if (target) {
                    target.classList.remove('hidden');
                    var activeBtn = document.getElementById('nav-' + tab);
                    if (activeBtn) {
                        activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400');
                        activeBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm', 'dark:bg-slate-700', 'dark:text-white');
                    }
                    requestAnimationFrame(() => {
                        if (tab === 'dashboard') this.renderChapters();
                        if (tab === 'history') this.renderHistory();
                        if (tab === 'create') creator.renderUserQuestions();
                        if (tab === 'ai') aiTutor.updateWeaknessDisplay();
                    });
                }
            },
            renderHistory: function () {
                var list = document.getElementById('history-list');
                var adviceList = document.getElementById('weakness-advice-list');
                list.innerHTML = ''; adviceList.innerHTML = '';
                var logs = this.data.history.slice().reverse().slice(0, 30);
                var weakCounts = {};
                logs.forEach(log => {
                    var rate = Math.round((log.correct / log.total) * 100);
                    var weaks = '<span class="text-xs text-slate-400">なし</span>';
                    if (log.weak && log.weak.length) {
                        log.weak.forEach(c => weakCounts[c] = (weakCounts[c] || 0) + 1);
                        weaks = log.weak.map(c => `<span class="text-xs bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 px-1.5 py-0.5 rounded border border-red-100 dark:border-red-800">${c}</span>`).join(' ');
                    }
                    var div = document.createElement('div');
                    div.className = "bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-2";
                    div.innerHTML = `<div class="flex justify-between mb-2"><span class="text-xs font-bold bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded dark:text-slate-300">${log.mode}</span><span class="font-bold text-lg ${rate >= 63 ? 'text-emerald-500' : 'text-slate-700 dark:text-slate-300'}">${rate}%</span></div><div class="flex flex-wrap gap-1">${weaks}</div>`;
                    list.appendChild(div);
                });
                if (typeof Chart !== 'undefined' && this.data.history.length > 0) {
                    var ctx = document.getElementById('historyChart');
                    if (this.chartInstance) this.chartInstance.destroy();
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels: logs.map((_, i) => i + 1), datasets: [{ label: 'Score', data: logs.map(l => Math.round(l.correct / l.total * 100)), borderColor: '#4f46e5', tension: 0.3 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100, grid: { color: '#334155' } } }, plugins: { legend: { display: false } } }
                    });
                }
                var sortedWeaks = Object.entries(weakCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
                if (sortedWeaks.length === 0) adviceList.innerHTML = '<div class="text-center text-xs text-slate-400 py-4">データ不足です</div>';
                else {
                    sortedWeaks.forEach(([cat, count]) => {
                        var div = document.createElement('div');
                        div.className = "bg-white dark:bg-slate-800 p-3 rounded-lg border border-red-100 dark:border-red-900/30 mb-2";

                        var link = app.categoryLinks[cat];
                        var labelHtml = link ? `<a href="${link}" target="_blank" class="text-sm font-bold text-indigo-600 dark:text-indigo-400 hover:underline flex items-center gap-1">${cat}<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>` : `<span class="text-sm font-bold text-slate-700 dark:text-slate-200">${cat}</span>`;

                        div.innerHTML = `<div class="flex justify-between items-center">${labelHtml}<span class="text-xs bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 px-2 py-0.5 rounded-full">Miss:${count}</span></div>`;
                        adviceList.appendChild(div);
                    });
                }
            },
            updateDashboard: function () {
                var total = this.data.questions.length;
                var answered = Object.keys(this.data.results).length;
                var correct = Object.values(this.data.results).filter(Boolean).length;
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-rate').innerText = answered ? Math.round((correct / answered) * 100) + '%' : '0%';
                var wrongs = this.data.questions.filter(q => this.data.results[q.id] === false);
                document.getElementById('wrong-count').innerText = wrongs.length;
                document.getElementById('btn-review').disabled = wrongs.length === 0;
                document.getElementById('bookmark-count').innerText = this.data.bookmarks.length;
                document.getElementById('btn-bookmark').disabled = this.data.bookmarks.length === 0;
                var userQCount = this.data.questions.filter(q => q.id.includes('user')).length;
                if (document.getElementById('user-q-count')) document.getElementById('user-q-count').innerText = userQCount;
                setTimeout(() => this.renderChapters(), 10);
            },
            renderChapters: function () {
                var grid = document.getElementById('chapter-grid');
                if (!grid) return;
                grid.innerHTML = '';
                if (this.data.questions.length === 0) {
                    grid.innerHTML = '<div class="col-span-full py-12 text-center text-slate-400 bg-white dark:bg-darkcard border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl"><p>データがありません。「データ読み込み」からJSONファイルを読み込んでください。</p></div>';
                    return;
                }
                var chapters = {};
                this.data.questions.forEach(q => {
                    if (!q || !q.id) return;
                    if (q.id.includes('user')) return; // 自作問題を集計から除外
                    var key = 'others';
                    var lower = q.id.toLowerCase();
                    var cat = q.category || "";
                    if (cat.includes('模擬')) return;
                    if (lower.startsWith('ai-')) key = 'ai';
                    else if (lower.startsWith('best-')) key = 'best';
                    else if (lower.includes('final') || cat.includes('最終')) key = 'final';
                    else { var m = lower.match(/^(?:ch|chapter)?(\d+)[-_]/); if (m) key = parseInt(m[1]); }
                    if (!chapters[key]) chapters[key] = { count: 0, correct: 0 };
                    chapters[key].count++;
                    if (this.data.results[q.id]) chapters[key].correct++;
                });
                Object.keys(chapters).sort((a, b) => {
                    var order = { 'final': 100, 'best': 101, 'ai': 102, 'others': 999 };
                    return (order[a] || parseInt(a)) - (order[b] || parseInt(b));
                }).forEach(key => {
                    var c = chapters[key];
                    var rate = Math.round((c.correct / c.count) * 100);
                    var label = '';
                    var color = 'indigo';

                    if (key === 'final') { label = '最終章'; color = 'yellow'; }
                    else if (key === 'ai') { label = 'AI生成'; color = 'purple'; }
                    else if (key === 'best') { label = '厳選'; color = 'orange'; }
                    else if (key === 'others') { label = 'その他'; color = 'slate'; }
                    else {
                        // Use official chapter titles
                        label = CHAPTER_TITLES[key] ? `第${key}章 ${CHAPTER_TITLES[key]}` : `第${key}章`;
                    }

                    var btn = document.createElement('button');
                    btn.className = `drill-card bg-white dark:bg-darkcard p-4 rounded-xl border border-slate-200 dark:border-slate-700 border-b-${color}-500 text-left h-32 flex flex-col justify-between`;
                    btn.onclick = () => this.startQuiz('chapter', key);

                    // Truncate long labels for display if needed, but let CSS handle wrap usually
                    btn.innerHTML = `<div class="font-bold text-slate-700 dark:text-slate-200 text-sm line-clamp-2">${label}</div><div><div class="flex justify-between text-xs text-slate-400 mb-1"><span>正解率</span><span>${rate}%</span></div><div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-1.5"><div class="bg-${color}-500 h-1.5 rounded-full" style="width:${rate}%"></div></div></div>`;
                    grid.appendChild(btn);
                });
            },
            startQuiz: function (mode, param) {
                if (this.data.questions.length === 0) return alert('問題がありません');
                var list = []; var name = '';
                if (mode === 'review') { list = this.data.questions.filter(q => this.data.results[q.id] === false); name = '復習'; }
                else if (mode === 'bookmark') { list = this.data.questions.filter(q => this.data.bookmarks.includes(q.id)); name = 'ブックマーク'; }
                else if (mode === 'chapter') {
                    if (param === 'final') list = this.data.questions.filter(q => q.id.includes('final') || (q.category && q.category.includes('模擬')));
                    else if (param === 'ai') list = this.data.questions.filter(q => q.id.startsWith('ai-'));
                    else if (param === 'best') list = this.data.questions.filter(q => q.id.startsWith('best-'));
                    else if (param === 'others') list = this.data.questions.filter(q => !q.id.match(/^(?:ch|chapter)?\d+/) && !q.id.startsWith('ai-') && !q.id.startsWith('best-') && !q.id.includes('final') && !q.id.includes('user'));
                    else list = this.data.questions.filter(q => { var m = q.id.toLowerCase().match(/^(?:ch|chapter)?(\d+)/); return m && parseInt(m[1]) === parseInt(param); });

                    name = CHAPTER_TITLES[param] ? `第${param}章` : (isNaN(param) ? (param === 'final' ? '最終章' : param === 'best' ? '厳選' : 'その他') : `Chapter ${param}`);
                }
                else if (mode.startsWith('level')) {
                    // Adjust regex for 11 chapters structure
                    var r1 = /^(?:ch|q)[-_]?(1|2|3|4)[-_]/i; // Ch 1-4
                    var r2 = /^(?:ch|q)[-_]?(5|6|7|9)[-_]/i; // Ch 5-7, 9 (Array, OOP, API)
                    var r3 = /^(?:ch|q)[-_]?(8|10|11)[-_]/i; // Ch 8, 10, 11 (Lambda, Exception, Module)

                    if (mode === 'level-1') list = this.data.questions.filter(q => q.id.match(r1) && !q.id.includes('user'));
                    if (mode === 'level-2') list = this.data.questions.filter(q => q.id.match(r2) && !q.id.includes('user'));
                    if (mode === 'level-3') list = this.data.questions.filter(q => q.id.match(r3) && !q.id.includes('user'));
                    // Add Limit & Shuffle for Levels
                    list.sort(() => Math.random() - 0.5);
                    list = list.slice(0, 30);
                    name = (mode === 'level-1') ? '初級 (30問)' : (mode === 'level-2') ? '中級 (30問)' : '上級 (30問)';
                }
                else if (mode === 'mock') { list = [...this.data.questions].sort(() => Math.random() - 0.5).slice(0, 40); name = '模擬試験'; }
                else if (mode === 'mock-set') { list = this.data.questions.filter(q => q.category === param); modeName = param; }
                else if (mode === 'user-all') { list = this.data.questions.filter(q => q.id.includes('user')); name = 'オリジナル全問'; }
                else if (mode === 'user-random') { list = this.data.questions.filter(q => q.id.includes('user')).sort(() => Math.random() - 0.5).slice(0, 10); name = 'オリジナル10問'; }

                if (list.length === 0) return alert('該当する問題がありません');
                if (mode !== 'mock-set' && !mode.startsWith('level')) list.sort(() => Math.random() - 0.5);

                this.state.queue = list;
                this.state.currentIdx = 0;
                this.state.modeName = name;
                this.state.sessionStats = { correct: 0, wrongInfo: [] };
                this.state.currentSelection = new Set();
                this.state.isQuizActive = true;
                document.getElementById('mode-display').innerText = name;
                if (this.state.timer) clearInterval(this.state.timer);
                if (mode === 'mock') {
                    document.getElementById('quiz-timer').classList.remove('hidden');
                    var t = 90 * 60;
                    this.state.timer = setInterval(() => {
                        t--; document.getElementById('quiz-timer').innerText = `⏳ ${Math.floor(t / 60)}:${(t % 60).toString().padStart(2, '0')}`;
                        if (t <= 0) { clearInterval(this.state.timer); this.finishSession(); }
                    }, 1000);
                } else { document.getElementById('quiz-timer').classList.add('hidden'); }
                this.switchTab('quiz-view');
                this.renderQuestion();
            },
            quitQuiz: function () {
                if (this.state.timer) clearInterval(this.state.timer);
                this.state.isQuizActive = false;
                this.switchTab('dashboard');
            },
            startSearchQuiz: function () {
                var k = document.getElementById('search-input').value.toLowerCase();
                if (!k) return;
                var list = this.data.questions.filter(q => (q.text + q.explanation + q.category).toLowerCase().includes(k));
                if (list.length === 0) return alert('見つかりませんでした');
                this.state.queue = list;
                this.state.currentIdx = 0;
                this.state.modeName = `検索:${k}`;
                this.state.sessionStats = { correct: 0, wrongInfo: [] };
                this.state.currentSelection = new Set();
                this.state.isQuizActive = true;
                document.getElementById('mode-display').innerText = this.state.modeName;
                this.switchTab('quiz-view');
                this.renderQuestion();
            },
            renderQuestion: function () {
                var q = this.state.queue[this.state.currentIdx];
                if (!q) return;
                document.getElementById('q-current').innerText = this.state.currentIdx + 1;
                document.getElementById('q-total').innerText = this.state.queue.length;
                document.getElementById('q-category').innerText = q.category || 'General';
                document.getElementById('q-text').innerText = q.text + (Array.isArray(q.answer) ? "\n(複数選択)" : "");
                document.getElementById('quiz-progress').style.width = `${(this.state.currentIdx / this.state.queue.length) * 100}%`;
                var bmBtn = document.getElementById('btn-quiz-bookmark');
                if (this.data.bookmarks.includes(q.id)) { bmBtn.classList.add('text-yellow-400'); bmBtn.classList.remove('text-slate-300'); }
                else { bmBtn.classList.remove('text-yellow-400'); bmBtn.classList.add('text-slate-300'); }
                var codeEl = document.getElementById('code-content');
                if (q.code?.trim()) {
                    document.getElementById('code-container').classList.remove('hidden');
                    codeEl.textContent = q.code;
                    if (typeof Prism !== 'undefined') { Prism.highlightElement(codeEl); }
                } else { document.getElementById('code-container').classList.add('hidden'); }
                var optsDiv = document.getElementById('options-list');
                optsDiv.innerHTML = '';
                document.getElementById('explanation-box').classList.add('hidden');
                document.getElementById('btn-submit-answer').classList.add('hidden');
                this.state.currentSelection = new Set();
                if (Array.isArray(q.options)) {
                    q.options.forEach((opt, i) => {
                        var btn = document.createElement('button');
                        btn.className = "option-btn w-full text-left p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-darkcard hover:bg-indigo-50 dark:hover:bg-indigo-900/30 hover:border-indigo-300 dark:hover:border-indigo-700 flex items-center shadow-sm active:scale-[0.99]";
                        btn.onclick = () => this.selectOption(i, btn);
                        btn.id = `option-btn-${i}`;
                        btn.innerHTML = `<span class="opt-mark w-8 h-8 flex-shrink-0 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 rounded-full flex items-center justify-center font-bold mr-4 transition">${String.fromCharCode(65 + i)}</span><span class="text-sm font-medium leading-relaxed text-slate-700 dark:text-slate-200 whitespace-pre-wrap">${opt}</span>`;
                        optsDiv.appendChild(btn);
                    });
                }
                document.getElementById('user-note-input').value = q.note || '';
            },
            selectOption: function (i, btn) {
                var q = this.state.queue[this.state.currentIdx];
                var isMulti = Array.isArray(q.answer);
                if (isMulti) {
                    if (this.state.currentSelection.has(i)) { this.state.currentSelection.delete(i); btn.classList.remove('option-selected'); }
                    else { this.state.currentSelection.add(i); btn.classList.add('option-selected'); }
                    if (this.state.currentSelection.size > 0) document.getElementById('btn-submit-answer').classList.remove('hidden');
                    else document.getElementById('btn-submit-answer').classList.add('hidden');
                } else { this.check([i]); }
            },
            submitAnswer: function () { this.check(Array.from(this.state.currentSelection)); },
            toggleBookmark: function () {
                var q = this.state.queue[this.state.currentIdx];
                var idx = this.data.bookmarks.indexOf(q.id);
                if (idx > -1) { this.data.bookmarks.splice(idx, 1); document.getElementById('btn-quiz-bookmark').classList.remove('text-yellow-400'); document.getElementById('btn-quiz-bookmark').classList.add('text-slate-300'); }
                else { this.data.bookmarks.push(q.id); document.getElementById('btn-quiz-bookmark').classList.add('text-yellow-400'); document.getElementById('btn-quiz-bookmark').classList.remove('text-slate-300'); }
                this.save();
            },
            check: function (userAns) {
                var q = this.state.queue[this.state.currentIdx];
                var cor = Array.isArray(q.answer) ? q.answer : [q.answer];
                var isCor = JSON.stringify(userAns.sort()) === JSON.stringify(cor.sort());
                if (isCor) this.state.sessionStats.correct++;
                else { var c = q.category || "その他"; if (!this.state.sessionStats.wrongInfo.includes(c)) this.state.sessionStats.wrongInfo.push(c); }
                this.data.results[q.id] = isCor;
                this.save();
                document.querySelectorAll('#options-list button').forEach(b => b.disabled = true);
                document.getElementById('btn-submit-answer').classList.add('hidden');
                userAns.forEach(i => {
                    var btn = document.getElementById(`option-btn-${i}`);
                    if (btn) {
                        if (cor.includes(i)) { btn.classList.add('!bg-emerald-50', '!border-emerald-500', 'dark:!bg-emerald-900/30', 'dark:!border-emerald-500'); btn.querySelector('.opt-mark').classList.add('!bg-emerald-500', '!text-white'); }
                        else { btn.classList.add('!bg-red-50', '!border-red-500', 'dark:!bg-red-900/30', 'dark:!border-red-500'); btn.querySelector('.opt-mark').classList.add('!bg-red-500', '!text-white'); }
                    }
                });
                cor.forEach(i => {
                    if (!userAns.includes(i)) {
                        var btn = document.getElementById(`option-btn-${i}`);
                        if (btn) { btn.classList.add('!bg-emerald-50', '!border-emerald-500', 'dark:!bg-emerald-900/30', 'dark:!border-emerald-500'); btn.querySelector('.opt-mark').classList.add('!bg-emerald-500', '!text-white'); }
                    }
                });
                document.getElementById('explanation-box').classList.remove('hidden');
                document.getElementById('result-badge').innerHTML = isCor ? '<span class="text-emerald-600">⭕ 正解！</span>' : '<span class="text-red-500">❌ 不正解...</span>';
                document.getElementById('explanation-text').innerText = `正解: ${cor.map(i => String.fromCharCode(65 + i)).join(', ')}\n\n${q.explanation}`;

                // Show Image if exists
                var imgContainer = document.getElementById('explanation-image-container');
                var imgEl = document.getElementById('explanation-img');
                if (q.explanationImage) {
                    imgEl.src = q.explanationImage;
                    imgContainer.classList.remove('hidden');
                } else {
                    imgContainer.classList.add('hidden');
                }

                var explanationBox = document.getElementById('explanation-box');
                if (window.innerWidth < 768) explanationBox.scrollIntoView({ behavior: 'smooth' });
            },
            nextQuestion: function () {
                this.state.currentIdx++;
                if (this.state.currentIdx >= this.state.queue.length) this.finishSession();
                else { this.renderQuestion(); document.getElementById('tab-quiz-view').scrollTop = 0; }
            },
            finishSession: function () {
                if (this.state.timer) clearInterval(this.state.timer);
                this.state.isQuizActive = false;
                var log = { date: Date.now(), correct: this.state.sessionStats.correct, total: this.state.queue.length, mode: this.state.modeName, weak: [...new Set(this.state.sessionStats.wrongInfo)] };
                this.data.history.push(log);
                this.save();
                document.getElementById('res-score').innerText = `${log.correct}/${log.total}`;
                document.getElementById('res-rate').innerText = Math.round((log.correct / log.total) * 100) + '%';
                document.getElementById('session-result').classList.remove('hidden');
            },
            closeSessionResult: function () { document.getElementById('session-result').classList.add('hidden'); this.switchTab('history'); },
            saveNote: function () {
                var q = this.state.queue[this.state.currentIdx];
                var note = document.getElementById('user-note-input').value;
                var target = this.data.questions.find(item => item.id === q.id);
                if (target) target.note = note;
                this.save();
                alert('メモを保存しました📝');
            }
        };

        // Initialize when DOM is ready to avoid reference errors
        window.addEventListener('DOMContentLoaded', () => {
            // Safety Check
            if (typeof app !== 'undefined') {
                app.init();
            } else {
                alert("Critical Error: App module not loaded. Please check console.");
            }
        });
    </script>
</body>

</html>