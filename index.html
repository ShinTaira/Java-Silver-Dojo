<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Silver å®Œå…¨æ”»ç•¥é“å ´ (Ver 9.1 - Ultimate Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
        }

        .code-input {
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
        }

        .fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-3 shadow-lg flex justify-between items-center z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-500 p-1.5 rounded-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                    </path>
                </svg>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-wide leading-tight">Java Silver é“å ´</h1>
                <p class="text-[10px] text-slate-400">Ver 9.1 Ultimate Fixed</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="app.switchTab('dashboard')"
                class="text-xs md:text-sm bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded transition border border-slate-700 active:scale-95">ãƒ›ãƒ¼ãƒ </button>
            <button onclick="app.switchTab('create')"
                class="text-xs md:text-sm bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded transition flex items-center gap-1 shadow-lg active:scale-95">
                <span>ğŸ“ ä½œæˆ</span>
            </button>
            <button onclick="app.switchTab('history')"
                class="text-xs md:text-sm bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded transition border border-slate-700 active:scale-95">è¨˜éŒ²</button>
            <button onclick="app.switchTab('ai')"
                class="text-xs md:text-sm bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded transition flex items-center gap-1 shadow-lg active:scale-95">
                <span>ğŸ¤– AI</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative bg-slate-100">

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="absolute inset-0 overflow-y-auto p-4 md:p-8 max-w-6xl mx-auto w-full fade-in">

            <!-- Import Alert -->
            <div id="import-alert"
                class="bg-white border border-indigo-100 text-slate-700 px-4 py-3 rounded-xl mb-6 flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-50 p-2 rounded-full">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold text-sm">å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</p>
                        <p class="text-xs text-slate-500">ä¿å­˜ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
                <label
                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-4 py-2 rounded-lg cursor-pointer transition shadow hover:shadow-md active:scale-95">
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    <input type="file" class="hidden" multiple onchange="dataManager.importData(this)">
                </label>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ç™»éŒ²å•é¡Œæ•°</div>
                    <div class="text-2xl font-bold text-slate-800 mt-1" id="stat-total">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">æ­£è§£ç‡</div>
                    <div class="text-2xl font-bold text-green-600 mt-1" id="stat-rate">0%</div>
                </div>
                <div
                    class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 col-span-2 flex items-center justify-between relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">è‹¦æ‰‹å…‹æœ</div>
                        <div class="text-2xl font-bold text-orange-500 mt-1"><span id="wrong-count">0</span> <span
                                class="text-sm font-normal text-slate-400">å•</span></div>
                    </div>
                    <button onclick="app.startQuiz('review')" id="btn-review"
                        class="relative z-10 bg-orange-100 text-orange-700 hover:bg-orange-200 px-5 py-2 rounded-lg text-sm font-bold transition disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        å¾©ç¿’ã™ã‚‹ â–¶
                    </button>
                </div>
            </div>

            <!-- SEARCH & BOOKMARK (New Features) -->
            <div class="grid md:grid-cols-2 gap-4 mb-8">
                <!-- Search -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢æ¼”ç¿’
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="search-input"
                            class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition"
                            placeholder="ä¾‹: ãƒ©ãƒ ãƒ€, ä¾‹å¤–, ç¶™æ‰¿...">
                        <button onclick="app.startSearchQuiz()"
                            class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition active:scale-95">æ¤œç´¢</button>
                    </div>
                </div>
                <!-- Bookmark -->
                <div
                    class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <svg class="w-4 h-4 text-yellow-500 fill-current" viewBox="0 0 20 20">
                                <path
                                    d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z">
                                </path>
                            </svg>
                            ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
                        </h3>
                        <p class="text-xs text-slate-400 mt-1">ä¿å­˜ã—ãŸå•é¡Œ: <span id="bookmark-count"
                                class="font-bold text-slate-700">0</span> å•</p>
                    </div>
                    <button onclick="app.startQuiz('bookmark')" id="btn-bookmark"
                        class="bg-yellow-100 text-yellow-700 hover:bg-yellow-200 px-5 py-2 rounded-lg text-sm font-bold transition disabled:opacity-50"
                        disabled>
                        è§£ã â–¶
                    </button>
                </div>
            </div>

            <!-- Level Courses -->
            <div class="mb-8">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">ãƒ¬ãƒ™ãƒ«åˆ¥ã‚³ãƒ¼ã‚¹</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <button onclick="app.startQuiz('level-1')"
                        class="bg-white hover:bg-emerald-50 border border-slate-200 hover:border-emerald-400 p-4 rounded-xl text-left transition group shadow-sm active:scale-[0.98]">
                        <div class="flex justify-between items-center mb-2"><span
                                class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-0.5 rounded">Beginner</span><span
                                class="text-xl">ğŸŒ±</span></div>
                        <h4 class="font-bold text-slate-700 group-hover:text-emerald-700">åˆç´šç·¨ï¼ˆåŸºç¤ï¼‰</h4>
                        <p class="text-[10px] text-slate-400 mt-1">ç¬¬1-4ç« : åŸºæœ¬æ§‹æ–‡, æ¼”ç®—å­, åˆ¶å¾¡æ§‹æ–‡</p>
                    </button>
                    <button onclick="app.startQuiz('level-2')"
                        class="bg-white hover:bg-blue-50 border border-slate-200 hover:border-blue-400 p-4 rounded-xl text-left transition group shadow-sm active:scale-[0.98]">
                        <div class="flex justify-between items-center mb-2"><span
                                class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">Intermediate</span><span
                                class="text-xl">ğŸ’»</span></div>
                        <h4 class="font-bold text-slate-700 group-hover:text-blue-700">ä¸­ç´šç·¨ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ï¼‰</h4>
                        <p class="text-[10px] text-slate-400 mt-1">ç¬¬5-8,12ç« : ã‚¯ãƒ©ã‚¹, ç¶™æ‰¿, API</p>
                    </button>
                    <button onclick="app.startQuiz('level-3')"
                        class="bg-white hover:bg-indigo-50 border border-slate-200 hover:border-indigo-400 p-4 rounded-xl text-left transition group shadow-sm active:scale-[0.98]">
                        <div class="flex justify-between items-center mb-2"><span
                                class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded">Advanced</span><span
                                class="text-xl">ğŸ”¥</span></div>
                        <h4 class="font-bold text-slate-700 group-hover:text-indigo-700">ä¸Šç´šç·¨ï¼ˆå¿œç”¨ï¼‰</h4>
                        <p class="text-[10px] text-slate-400 mt-1">ç¬¬9-11,13ç« : ä¾‹å¤–, ãƒ©ãƒ ãƒ€, ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</p>
                    </button>
                </div>
            </div>

            <!-- Chapter Selection -->
            <div class="mb-12">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">ç« ã”ã¨ã®æ¼”ç¿’</h3>
                <div id="chapter-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <div
                        class="col-span-full py-8 text-center text-slate-400 bg-white border border-dashed border-slate-300 rounded-xl">
                        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã¨ã“ã“ã«ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>
            </div>

            <!-- Mock Exam (With Timer) -->
            <div
                class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-xl p-6 text-white shadow-xl flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
                <div>
                    <h3 class="text-lg font-bold mb-1 flex items-center gap-2">
                        <span>ğŸ† æ¨¡æ“¬è©¦é¨“ãƒ¢ãƒ¼ãƒ‰</span>
                        <span
                            class="bg-yellow-500 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded">Timerä»˜ã</span>
                    </h3>
                    <p class="text-slate-300 text-xs">å…¨ç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«40å•ã€‚æœ¬ç•ªå½¢å¼ï¼ˆ90åˆ†ï¼‰ã§å®ŸåŠ›ã‚’æ¸¬ã‚Šã¾ã™ã€‚</p>
                </div>
                <button onclick="app.startQuiz('mock')"
                    class="bg-white text-slate-900 hover:bg-slate-100 font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5 active:translate-y-0">
                    è©¦é¨“é–‹å§‹
                </button>
            </div>

            <div class="text-center pt-8 border-t border-slate-200">
                <button onclick="dataManager.resetAll()"
                    class="text-xs text-red-400 hover:text-red-600 hover:underline transition">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="tab-history" class="absolute inset-0 overflow-y-auto p-4 bg-slate-100 hidden fade-in">
            <div class="max-w-4xl mx-auto py-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span>ğŸ“ˆ å­¦ç¿’è¨˜éŒ²</span></h2>
                    <select id="history-filter"
                        class="text-sm border border-slate-300 rounded-lg px-3 py-1.5 bg-white outline-none focus:ring-2 focus:ring-indigo-500"
                        onchange="app.renderHistory()">
                        <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
                        <option value="mock">æ¨¡æ“¬è©¦é¨“</option>
                        <option value="level">ãƒ¬ãƒ™ãƒ«åˆ¥æ¼”ç¿’</option>
                        <option value="1">ç¬¬1ç« </option>
                        <option value="2">ç¬¬2ç« </option>
                        <option value="3">ç¬¬3ç« </option>
                        <option value="4">ç¬¬4ç« </option>
                        <option value="5">ç¬¬5ç« </option>
                        <option value="6">ç¬¬6ç« </option>
                        <option value="7">ç¬¬7ç« </option>
                        <option value="8">ç¬¬8ç« </option>
                        <option value="9">ç¬¬9ç« </option>
                        <option value="10">ç¬¬10ç« </option>
                        <option value="11">ç¬¬11ç« </option>
                        <option value="12">ç¬¬12ç« </option>
                        <option value="13">ç¬¬13ç« </option>
                        <option value="final">æœ€çµ‚ç« </option>
                    </select>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 h-64 md:h-80"><canvas
                        id="historyChart"></canvas></div>
                <div id="history-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- CREATOR TAB -->
        <div id="tab-create" class="absolute inset-0 overflow-y-auto p-4 bg-slate-100 hidden fade-in">
            <div class="max-w-3xl mx-auto py-8">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-emerald-600 p-4 flex justify-between items-center text-white">
                        <h2 class="text-lg font-bold flex items-center gap-2"><span>ğŸ“ ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œä½œæˆ</span></h2>
                        <span class="text-xs bg-emerald-700 px-2 py-1 rounded">User Studio</span>
                    </div>
                    <form id="create-form" onsubmit="creator.addQuestion(event)" class="p-6 space-y-6">
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">ã‚«ãƒ†ã‚´ãƒª</label><select
                                id="create-chapter"
                                class="w-full border border-slate-300 rounded-lg px-4 py-3 appearance-none bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none"
                                onchange="creator.updateCategoryLabel()">
                                <option value="1">ç¬¬1ç« : Javaã®åŸºæœ¬</option>
                                <option value="2">ç¬¬2ç« : ãƒ‡ãƒ¼ã‚¿å‹ã¨å¤‰æ•°</option>
                                <option value="3">ç¬¬3ç« : æ¼”ç®—å­</option>
                                <option value="4">ç¬¬4ç« : ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡</option>
                                <option value="5">ç¬¬5ç« : é…åˆ—</option>
                                <option value="6">ç¬¬6ç« : ã‚¯ãƒ©ã‚¹ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</option>
                                <option value="7">ç¬¬7ç« : ç¶™æ‰¿</option>
                                <option value="8">ç¬¬8ç« : ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</option>
                                <option value="9">ç¬¬9ç« : ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ </option>
                                <option value="10">ç¬¬10ç« : ä¾‹å¤–å‡¦ç†</option>
                                <option value="11">ç¬¬11ç« : ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</option>
                                <option value="12">ç¬¬12ç« : ä¸»è¦API</option>
                                <option value="13">ç¬¬13ç« : ãƒ©ãƒ ãƒ€å¼</option>
                                <option value="99">ãã®ä»–</option>
                            </select><input type="hidden" id="create-cat-name" value="åŸºæœ¬æ§‹æ–‡"></div>
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">å•é¡Œæ–‡</label><textarea
                                id="create-text" rows="3"
                                class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none"
                                required></textarea></div>
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">Javaã‚³ãƒ¼ãƒ‰(ä»»æ„)</label><textarea
                                id="create-code" rows="4"
                                class="w-full bg-slate-800 text-slate-200 font-mono text-sm rounded-lg p-3 border border-slate-700 focus:ring-2 focus:ring-emerald-500 outline-none"></textarea>
                        </div>
                        <div><label class="block text-sm font-bold text-slate-700 mb-3">é¸æŠè‚¢</label>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3"><input type="radio" name="correct-idx" value="0"
                                        checked><input type="text"
                                        class="create-option flex-1 border border-slate-300 rounded px-3 py-2 text-sm"
                                        placeholder="é¸æŠè‚¢ A" required></div>
                                <div class="flex items-center gap-3"><input type="radio" name="correct-idx"
                                        value="1"><input type="text"
                                        class="create-option flex-1 border border-slate-300 rounded px-3 py-2 text-sm"
                                        placeholder="é¸æŠè‚¢ B" required></div>
                                <div class="flex items-center gap-3"><input type="radio" name="correct-idx"
                                        value="2"><input type="text"
                                        class="create-option flex-1 border border-slate-300 rounded px-3 py-2 text-sm"
                                        placeholder="é¸æŠè‚¢ C" required></div>
                                <div class="flex items-center gap-3"><input type="radio" name="correct-idx"
                                        value="3"><input type="text"
                                        class="create-option flex-1 border border-slate-300 rounded px-3 py-2 text-sm"
                                        placeholder="é¸æŠè‚¢ D" required></div>
                            </div>
                        </div>
                        <div><label class="block text-sm font-bold text-slate-700 mb-2">è§£èª¬</label><textarea
                                id="create-explanation" rows="4"
                                class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none"
                                required></textarea></div>
                        <div class="pt-4 border-t border-slate-100 flex justify-end"><button type="submit"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5">å•é¡Œã‚’è¿½åŠ </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- AI TAB -->
        <div id="tab-ai" class="absolute inset-0 overflow-y-auto p-4 bg-slate-100 hidden fade-in">
            <div class="max-w-2xl mx-auto space-y-6 py-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ”‘ APIè¨­å®š</span>
                    </h2>
                    <div class="space-y-4">
                        <div class="flex flex-col gap-1"><label class="text-xs font-bold text-slate-500">APIã‚­ãƒ¼</label>
                            <div class="flex gap-2"><input type="password" id="api-key-input"
                                    class="flex-1 border border-slate-300 rounded-lg px-4 py-2 text-sm outline-none"
                                    placeholder="AIza..."><button onclick="aiTutor.saveKey()"
                                    class="bg-slate-800 text-white px-5 py-2 rounded-lg text-sm hover:bg-slate-700 transition font-bold active:scale-95">ä¿å­˜</button>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1"><label class="text-xs font-bold text-slate-500">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label>
                            <div class="space-y-2"><select id="api-model-select"
                                    class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none bg-white"
                                    onchange="aiTutor.toggleCustomModelInput()">
                                    <option value="gemini-1.5-flash">gemini-1.5-flash (æ¨å¥¨ãƒ»é«˜é€Ÿ)</option>
                                    <option value="gemini-1.5-pro">gemini-1.5-pro (é«˜ç²¾åº¦)</option>
                                    <option value="gemini-pro">gemini-pro (æ—§å®‰å®šç‰ˆ)</option>
                                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
                                </select><input type="text" id="api-model-custom"
                                    class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none bg-slate-50 hidden"
                                    placeholder="ä¾‹: gemini-2.0-flash-exp"></div>
                        </div>
                    </div>
                    <div id="key-status" class="text-xs text-slate-400 mt-3 flex items-center gap-1"><span
                            class="w-2 h-2 rounded-full bg-slate-300"></span> æœªè¨­å®š</div>
                </div>
                <div class="bg-gradient-to-br from-indigo-600 to-violet-600 p-6 rounded-xl shadow-lg text-white">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xl font-bold">AIå¼±ç‚¹å…‹æœã‚³ãƒ¼ãƒ</h2>
                            <p class="text-indigo-100 text-xs mt-1">è‹¦æ‰‹åˆ†é‡ã®å•é¡Œã‚’è‡ªå‹•ç”Ÿæˆ</p>
                        </div>
                        <div class="text-2xl">ğŸ¤–</div>
                    </div>
                    <div id="ai-analysis"
                        class="bg-white/10 backdrop-blur-sm rounded-lg p-4 mb-6 border border-white/10 hidden">
                        <ul id="weak-list" class="list-disc list-inside text-sm space-y-1 text-white"></ul>
                    </div>
                    <button onclick="aiTutor.generate()" id="btn-generate"
                        class="w-full bg-white text-indigo-600 font-bold py-3.5 rounded-lg shadow-md hover:bg-indigo-50 transition flex justify-center items-center gap-2 disabled:opacity-50"
                        disabled>ğŸš€ ç”Ÿæˆ</button>
                    <div id="ai-loading" class="hidden mt-6 flex flex-col items-center">
                        <div class="loader mb-3 border-t-white border-white/20"></div>
                        <p class="text-xs text-indigo-100 animate-pulse">æ€è€ƒä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUIZ VIEW -->
        <div id="quiz-view" class="absolute inset-0 overflow-y-auto p-4 bg-[#f8fafc] hidden z-20">
            <div class="max-w-3xl mx-auto pb-20 fade-in mt-4">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="app.quitQuiz()"
                        class="text-xs text-slate-500 hover:text-slate-800 font-bold flex items-center gap-1 p-2"><span>â†</span>
                        ä¸­æ–­ã™ã‚‹</button>
                    <div class="flex items-center gap-3">
                        <div id="quiz-timer"
                            class="hidden bg-slate-800 text-white text-sm font-mono font-bold px-3 py-1 rounded shadow animate-pulse">
                            â³ 90:00</div>
                        <div class="text-[10px] font-mono text-slate-400 bg-white border border-slate-200 px-2 py-1 rounded"
                            id="mode-display">Random</div>
                    </div>
                </div>
                <div
                    class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-slate-200 mb-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-slate-100">
                        <div id="quiz-progress" class="h-full bg-indigo-500 transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-start mb-6 mt-2">
                        <span
                            class="inline-block bg-indigo-50 text-indigo-600 px-3 py-1 rounded-md text-[10px] font-bold tracking-wide uppercase border border-indigo-100"
                            id="q-category">Category</span>
                        <div class="flex items-center gap-2">
                            <button onclick="app.toggleBookmark()" id="btn-quiz-bookmark"
                                class="text-slate-300 hover:text-yellow-400 transition transform hover:scale-110 focus:outline-none"><svg
                                    class="w-6 h-6 fill-current" viewBox="0 0 20 20">
                                    <path
                                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z">
                                    </path>
                                </svg></button>
                            <div class="font-mono text-slate-300 font-bold text-xl"><span id="q-current"
                                    class="text-slate-800">1</span><span class="text-sm">/</span><span id="q-total"
                                    class="text-sm">10</span></div>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-6 leading-relaxed whitespace-pre-line" id="q-text">
                        Problem</h3>
                    <div id="code-container"
                        class="bg-[#1e1e1e] rounded-lg overflow-hidden mb-6 relative group hidden shadow-inner border border-slate-700">
                        <pre
                            class="!m-0 !p-5 overflow-x-auto text-sm"><code class="language-java code-input text-gray-100 leading-6" id="code-content"></code></pre>
                    </div>
                </div>
                <div id="options-list" class="grid gap-3 mb-8"></div>
                <div id="explanation-box"
                    class="hidden bg-emerald-50 border border-emerald-200 rounded-xl p-6 shadow-lg fade-in relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-24 h-24 text-emerald-600"
                            fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-3"><span id="result-badge"
                                class="font-bold text-lg"></span></div>
                        <div class="text-slate-700 text-sm leading-7 whitespace-pre-line" id="explanation-text"></div>
                        <button onclick="app.nextQuestion()"
                            class="mt-6 w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-lg transition shadow-lg flex items-center justify-center gap-2 active:scale-95"><span>æ¬¡ã®å•é¡Œã¸</span><svg
                                class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="session-result" class="fixed inset-0 bg-slate-900/95 z-50 hidden flex items-center justify-center p-4">
            <div
                class="bg-white rounded-2xl shadow-2xl max-w-xs w-full p-8 text-center space-y-6 fade-in transform scale-100">
                <div class="text-6xl mb-2 animate-bounce">ğŸ‰</div>
                <h3 class="text-2xl font-bold text-slate-800">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h3>
                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">æ­£è§£æ•°</div>
                        <div class="text-2xl font-bold text-indigo-600"><span id="res-score">0</span></div>
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">æ­£è§£ç‡</div>
                        <div class="text-2xl font-bold text-slate-800" id="res-rate">0%</div>
                    </div>
                </div><button onclick="app.closeSessionResult()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition active:scale-95">OK</button>
            </div>
        </div>

    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script>
        const app = {
            data: { questions: [], results: {}, history: [], bookmarks: [] },
            state: { queue: [], currentIdx: 0, sessionStats: { correct: 0, wrongInfo: [] }, modeName: '', timer: null },
            chartInstance: null,

            init() {
                try {
                    const saved = localStorage.getItem('javaSilverAI_v9_1');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.data = { ...this.data, ...parsed };
                        if (!Array.isArray(this.data.history)) this.data.history = [];
                        if (!Array.isArray(this.data.bookmarks)) this.data.bookmarks = [];
                    }
                } catch (e) { console.error("Load error", e); }

                this.updateDashboard();
                aiTutor.init();
            },

            save() {
                try {
                    if (this.data.history.length > 100) this.data.history = this.data.history.slice(-100);
                    localStorage.setItem('javaSilverAI_v9_1', JSON.stringify(this.data));
                } catch (e) { console.error("Save error", e); }
                this.updateDashboard();
            },

            switchTab(tab) {
                ['dashboard', 'ai', 'history', 'create', 'quiz-view'].forEach(id => {
                    const el = document.getElementById('tab-' + id) || document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });

                const target = document.getElementById('tab-' + tab);
                if (target) {
                    target.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        if (tab === 'dashboard') this.renderChapters();
                        if (tab === 'history') this.renderHistory();
                        if (tab === 'ai') aiTutor.analyzeWeakness();
                    });
                }
            },

            updateDashboard() {
                const total = this.data.questions.length;
                const answered = Object.keys(this.data.results).length;
                const correct = Object.values(this.data.results).filter(Boolean).length;
                const rate = answered ? Math.round((correct / answered) * 100) : 0;

                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-rate').innerText = rate + '%';

                const wrongs = this.data.questions.filter(q => this.data.results[q.id] === false);
                document.getElementById('wrong-count').innerText = wrongs.length;
                document.getElementById('btn-review').disabled = wrongs.length === 0;

                const bCount = this.data.bookmarks ? this.data.bookmarks.length : 0;
                document.getElementById('bookmark-count').innerText = bCount;
                document.getElementById('btn-bookmark').disabled = bCount === 0;

                if (total > 0) {
                    document.getElementById('import-alert').classList.add('hidden');
                    setTimeout(() => this.renderChapters(), 10);
                }
            },

            renderChapters() {
                const grid = document.getElementById('chapter-grid');
                if (this.data.questions.length === 0) return;
                grid.innerHTML = '';
                const chapters = {};
                for (const q of this.data.questions) {
                    let key = 'others';
                    const lowerId = q.id.toLowerCase();
                    const lowerCat = q.category ? q.category.toLowerCase() : "";
                    if (lowerId.startsWith('ai-')) key = 'ai';
                    else if (lowerId.startsWith('best-')) key = 'best';
                    else if (lowerId.includes('final') || lowerCat.includes('final') || lowerCat.includes('æ¨¡æ“¬') || lowerCat.includes('ç·åˆ')) key = 'final';
                    else {
                        const match = lowerId.match(/^(?:ch|chapter)?(\d+)[-_]/);
                        if (match) key = parseInt(match[1]);
                    }
                    if (!chapters[key]) chapters[key] = { count: 0, correct: 0 };
                    chapters[key].count++;
                    if (this.data.results[q.id]) chapters[key].correct++;
                }
                const sortedKeys = Object.keys(chapters).sort((a, b) => {
                    const order = { 'final': 100, 'best': 101, 'ai': 102, 'others': 999 };
                    const valA = order[a] !== undefined ? order[a] : parseInt(a);
                    const valB = order[b] !== undefined ? order[b] : parseInt(b);
                    return valA - valB;
                });
                const fragment = document.createDocumentFragment();
                sortedKeys.forEach(key => {
                    const ch = chapters[key];
                    const rate = Math.round((ch.correct / ch.count) * 100);
                    let label = '', subLabel = '', icon = '', colorClass = 'indigo';
                    const numKey = parseInt(key);
                    if (key === 'final') { label = 'æœ€çµ‚ç« '; subLabel = 'ç·åˆæ¼”ç¿’'; icon = 'ğŸ†'; colorClass = 'yellow'; }
                    else if (key === 'best') { label = 'å³é¸å•é¡Œ'; subLabel = 'Best 30'; icon = 'â˜…'; colorClass = 'orange'; }
                    else if (key === 'ai') { label = 'AIç”Ÿæˆ'; subLabel = 'Generated'; icon = 'ğŸ¤–'; colorClass = 'purple'; }
                    else if (!isNaN(numKey) && key !== 'others') { label = `ç¬¬${numKey}ç« `; icon = 'ğŸ“–'; }
                    else { label = 'ãã®ä»–'; icon = 'ğŸ“'; colorClass = 'slate'; }

                    const btn = document.createElement('button');
                    const borderClass = key === 'best' ? 'border-orange-200 bg-orange-50' : (key === 'final' ? 'border-yellow-200 bg-yellow-50' : 'border-slate-200 bg-white');
                    btn.className = `${borderClass} p-4 rounded-xl border hover:border-${colorClass}-400 hover:shadow-md transition text-left flex flex-col justify-between h-28 relative overflow-hidden group active:scale-[0.98]`;
                    btn.onclick = () => this.startQuiz('chapter', key);
                    btn.innerHTML = `<div class="flex justify-between items-start z-10"><div><div class="font-bold text-slate-700 text-sm">${label}</div>${subLabel ? `<div class="text-[10px] text-slate-500">${subLabel}</div>` : ''}</div><div class="text-lg opacity-50 group-hover:opacity-100 transition group-hover:scale-110">${icon}</div></div><div class="z-10 mt-auto"><div class="flex justify-between items-end"><div class="text-[10px] text-slate-400">æ­£è§£ç‡</div><div class="text-xl font-bold ${rate === 100 ? 'text-emerald-500' : 'text-slate-800'}">${rate}<span class="text-xs">%</span></div></div></div><div class="absolute bottom-0 left-0 h-1.5 bg-${colorClass}-500 transition-all duration-500" style="width: ${rate}%"></div>`;
                    fragment.appendChild(btn);
                });
                grid.appendChild(fragment);
            },

            startQuiz(mode, param) {
                if (this.data.questions.length === 0) return alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                let list = []; let modeName = '';

                if (mode === 'review') { list = this.data.questions.filter(q => this.data.results[q.id] === false); modeName = 'å¾©ç¿’'; }
                else if (mode === 'bookmark') { list = this.data.questions.filter(q => this.data.bookmarks.includes(q.id)); modeName = 'ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯'; }
                else if (mode === 'chapter') {
                    if (param === 'final') { list = this.data.questions.filter(q => q.id.toLowerCase().includes('final') || (q.category && q.category.includes('æ¨¡æ“¬'))); modeName = 'æœ€çµ‚ç« '; }
                    else if (param === 'best') { list = this.data.questions.filter(q => q.id.toLowerCase().startsWith('best-')); modeName = 'å³é¸å•é¡Œ'; }
                    else if (param === 'ai') { list = this.data.questions.filter(q => q.id.toLowerCase().startsWith('ai-')); modeName = 'AIç”Ÿæˆ'; }
                    else if (param === 'others') { list = this.data.questions.filter(q => { const lower = q.id.toLowerCase(); return !lower.match(/^(?:ch|chapter)?\d+[-_]/) && !lower.includes('final') && !lower.startsWith('best') && !lower.startsWith('ai'); }); modeName = 'ãã®ä»–'; }
                    else { list = this.data.questions.filter(q => { const match = q.id.toLowerCase().match(/^(?:ch|chapter)?(\d+)[-_]/); return match && parseInt(match[1]) === parseInt(param); }); modeName = `ç¬¬${param}ç« `; }
                } else if (mode.startsWith('level')) {
                    const regex1 = /^(?:ch|chapter|q)[-_]?(1|2|3|4)[-_]/i;
                    const regex2 = /^(?:ch|chapter|q)[-_]?(5|6|7|8|12)[-_]/i;
                    const regex3 = /^(?:ch|chapter|q)[-_]?(9|10|11|13)[-_]/i;
                    if (mode === 'level-1') { list = this.data.questions.filter(q => q.id.match(regex1)); modeName = 'åˆç´šç·¨'; }
                    if (mode === 'level-2') { list = this.data.questions.filter(q => q.id.match(regex2)); modeName = 'ä¸­ç´šç·¨'; }
                    if (mode === 'level-3') { list = this.data.questions.filter(q => q.id.match(regex3)); modeName = 'ä¸Šç´šç·¨'; }
                } else if (mode === 'mock') {
                    list = [...this.data.questions].sort(() => Math.random() - 0.5).slice(0, 40);
                    modeName = 'æ¨¡æ“¬è©¦é¨“';
                }

                if (list.length === 0) return alert('è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                if (mode !== 'mock') list.sort(() => Math.random() - 0.5);

                this.state.queue = list;
                this.state.currentIdx = 0;
                this.state.modeName = modeName;
                this.state.sessionStats = { correct: 0, wrongInfo: [] };
                document.getElementById('mode-display').innerText = modeName;

                if (this.state.timer) clearInterval(this.state.timer);
                const timerEl = document.getElementById('quiz-timer');
                if (mode === 'mock') {
                    timerEl.classList.remove('hidden');
                    let timeLeft = 90 * 60;
                    this.state.timer = setInterval(() => {
                        timeLeft--;
                        const m = Math.floor(timeLeft / 60);
                        const s = timeLeft % 60;
                        timerEl.innerText = `â³ ${m}:${s.toString().padStart(2, '0')}`;
                        if (timeLeft <= 0) { clearInterval(this.state.timer); alert('æ™‚é–“åˆ‡ã‚Œã§ã™ï¼'); this.finishSession(); }
                    }, 1000);
                } else {
                    timerEl.classList.add('hidden');
                }

                document.getElementById('quiz-view').classList.remove('hidden');
                this.renderQuestion();
            },

            quitQuiz() {
                if (this.state.timer) clearInterval(this.state.timer);
                this.switchTab('dashboard');
            },

            startSearchQuiz() {
                const keyword = document.getElementById('search-input').value.trim().toLowerCase();
                if (!keyword) return alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                const list = this.data.questions.filter(q => (q.text && q.text.toLowerCase().includes(keyword)) || (q.explanation && q.explanation.toLowerCase().includes(keyword)) || (q.category && q.category.toLowerCase().includes(keyword)));
                if (list.length === 0) return alert('è©²å½“ã™ã‚‹å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                this.state.queue = list;
                this.state.currentIdx = 0;
                this.state.modeName = `æ¤œç´¢: ${keyword}`;
                this.state.sessionStats = { correct: 0, wrongInfo: [] };
                document.getElementById('mode-display').innerText = this.state.modeName;
                if (this.state.timer) clearInterval(this.state.timer);
                document.getElementById('quiz-timer').classList.add('hidden');
                document.getElementById('quiz-view').classList.remove('hidden');
                this.renderQuestion();
            },

            renderQuestion() {
                const q = this.state.queue[this.state.currentIdx];
                const total = this.state.queue.length;
                const current = this.state.currentIdx + 1;
                document.getElementById('q-current').innerText = current;
                document.getElementById('q-total').innerText = total;
                document.getElementById('q-category').innerText = q.category || 'General';
                document.getElementById('q-text').innerText = q.text;
                document.getElementById('quiz-progress').style.width = `${((current - 1) / total) * 100}%`;

                const bmBtn = document.getElementById('btn-quiz-bookmark');
                if (this.data.bookmarks.includes(q.id)) { bmBtn.classList.add('text-yellow-400'); bmBtn.classList.remove('text-slate-300'); }
                else { bmBtn.classList.remove('text-yellow-400'); bmBtn.classList.add('text-slate-300'); }

                const codeEl = document.getElementById('code-content');
                if (q.code && q.code.trim()) {
                    document.getElementById('code-container').classList.remove('hidden');
                    codeEl.textContent = q.code;
                    setTimeout(() => Prism.highlightElement(codeEl), 0);
                } else {
                    document.getElementById('code-container').classList.add('hidden');
                }

                const optsDiv = document.getElementById('options-list');
                optsDiv.innerHTML = '';
                document.getElementById('explanation-box').classList.add('hidden');

                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 rounded-xl border border-slate-200 bg-white hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center shadow-sm group active:scale-[0.98]";
                    btn.onclick = () => this.check(idx, btn);
                    btn.innerHTML = `<span class="w-8 h-8 flex-shrink-0 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center font-bold mr-4 group-hover:bg-indigo-600 group-hover:text-white transition">${String.fromCharCode(65 + idx)}</span><span class="text-sm font-medium leading-relaxed text-slate-700">${opt}</span>`;
                    optsDiv.appendChild(btn);
                });
            },

            toggleBookmark() {
                const q = this.state.queue[this.state.currentIdx];
                if (!this.data.bookmarks) this.data.bookmarks = [];
                const idx = this.data.bookmarks.indexOf(q.id);
                if (idx > -1) this.data.bookmarks.splice(idx, 1);
                else this.data.bookmarks.push(q.id);
                this.save();
                this.renderQuestion();
            },

            check(idx, btn) {
                const q = this.state.queue[this.state.currentIdx];
                const isCorrect = idx == q.answer;

                if (isCorrect) { this.state.sessionStats.correct++; }
                else {
                    const cat = q.category || "ãã®ä»–";
                    if (!this.state.sessionStats.wrongInfo.includes(cat)) this.state.sessionStats.wrongInfo.push(cat);
                }

                this.data.results[q.id] = isCorrect;
                this.save();

                document.querySelectorAll('#options-list button').forEach(b => b.disabled = true);
                if (isCorrect) {
                    btn.classList.add('!bg-emerald-50', '!border-emerald-500', '!text-emerald-800');
                    btn.querySelector('span').classList.add('!bg-emerald-500', '!text-white');
                } else {
                    btn.classList.add('!bg-red-50', '!border-red-500', '!text-red-800');
                    btn.querySelector('span').classList.add('!bg-red-500', '!text-white');
                    const correctBtn = document.querySelectorAll('#options-list button')[q.answer];
                    if (correctBtn) { correctBtn.classList.add('!bg-emerald-50', '!border-emerald-500'); correctBtn.querySelector('span').classList.add('!bg-emerald-500', '!text-white'); }
                }

                const box = document.getElementById('explanation-box');
                box.classList.remove('hidden');
                document.getElementById('result-badge').innerHTML = isCorrect ? '<span class="text-emerald-600">â­• æ­£è§£ï¼</span>' : '<span class="text-red-500">âŒ ä¸æ­£è§£...</span>';
                document.getElementById('explanation-text').innerText = `æ­£è§£: ${String.fromCharCode(65 + q.answer)}\n\n${q.explanation}`;
                if (window.innerWidth < 768) box.scrollIntoView({ behavior: 'smooth' });
            },

            nextQuestion() {
                this.state.currentIdx++;
                if (this.state.currentIdx >= this.state.queue.length) { this.finishSession(); }
                else { this.renderQuestion(); document.getElementById('quiz-view').scrollTop = 0; }
            },

            finishSession() {
                if (this.state.timer) clearInterval(this.state.timer);
                const log = { date: Date.now(), correct: this.state.sessionStats.correct, total: this.state.queue.length, mode: this.state.modeName, weak: [...new Set(this.state.sessionStats.wrongInfo)] };
                this.data.history.push(log);
                this.save();
                document.getElementById('res-score').innerText = log.correct + '/' + log.total;
                document.getElementById('res-rate').innerText = Math.round((log.correct / log.total) * 100) + '%';
                document.getElementById('session-result').classList.remove('hidden');
            },

            closeSessionResult() {
                document.getElementById('session-result').classList.add('hidden');
                this.switchTab('history');
            },

            renderHistory() {
                const filter = document.getElementById('history-filter').value;
                const list = document.getElementById('history-list');
                const canvas = document.getElementById('historyChart');
                list.innerHTML = '';

                let logs = this.data.history.filter(log => {
                    if (filter === 'all') return true;
                    if (filter === 'mock') return log.mode && log.mode.includes('æ¨¡æ“¬');
                    if (filter === 'level') return log.mode && log.mode.includes('ãƒ¬ãƒ™ãƒ«');
                    if (filter === 'final') return log.mode && log.mode.includes('æœ€çµ‚');
                    if (!isNaN(parseInt(filter))) return log.mode && log.mode.includes(`ç¬¬${filter}ç« `);
                    return true;
                });

                if (logs.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-400 py-8">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    if (this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; }
                    return;
                }

                const fragment = document.createDocumentFragment();
                [...logs].reverse().slice(0, 30).forEach(log => {
                    const d = new Date(log.date);
                    const dateStr = `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                    const mode = log.mode || 'æ¼”ç¿’';
                    const rate = Math.round((log.correct / log.total) * 100);
                    const weaks = (log.weak && log.weak.length > 0) ? log.weak.join(', ') : 'ãªã—';

                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-lg shadow-sm border border-slate-100 mb-2";
                    div.innerHTML = `<div class="flex justify-between items-center mb-1"><div class="flex items-center gap-2"><span class="text-xs text-slate-500">${dateStr}</span><span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold">${mode}</span></div><div class="font-bold text-lg ${rate >= 63 ? 'text-green-600' : 'text-slate-700'}">${rate}%</div></div><div class="text-[10px] text-slate-400 flex items-start gap-1"><span class="font-bold text-red-400 whitespace-nowrap">Miss:</span><span class="leading-tight">${weaks}</span></div>`;
                    fragment.appendChild(div);
                });
                list.appendChild(fragment);

                const chartLogs = logs.slice(-20);
                const labels = chartLogs.map(l => { const d = new Date(l.date); return `${d.getMonth() + 1}/${d.getDate()}`; });
                const dataPoints = chartLogs.map(l => Math.round((l.correct / l.total) * 100));
                const passingLine = Array(chartLogs.length).fill(63);

                if (this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(canvas, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'æ­£ç­”ç‡ (%)', data: dataPoints, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', tension: 0.3, fill: true, pointRadius: 4, pointBackgroundColor: '#fff', pointBorderColor: '#4f46e5' }, { label: 'åˆæ ¼ãƒ©ã‚¤ãƒ³ (63%)', data: passingLine, borderColor: '#ef4444', borderDash: [5, 5], pointRadius: 0, borderWidth: 2, fill: false }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { stepSize: 20 } } }, plugins: { legend: { labels: { font: { size: 10 } } } } }
                });
            }
        };

        const creator = {
            categoryNames: { "1": "Javaã®åŸºæœ¬", "2": "ãƒ‡ãƒ¼ã‚¿å‹ã¨å¤‰æ•°", "3": "æ¼”ç®—å­", "4": "ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡", "5": "é…åˆ—", "6": "ã‚¯ãƒ©ã‚¹ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹", "7": "ç¶™æ‰¿", "8": "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹", "9": "ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ", "10": "ä¾‹å¤–å‡¦ç†", "11": "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«", "12": "ä¸»è¦API", "13": "ãƒ©ãƒ ãƒ€å¼", "99": "ãã®ä»–" },
            updateCategoryLabel() { const val = document.getElementById('create-chapter').value; document.getElementById('create-cat-name').value = this.categoryNames[val]; },
            addQuestion(e) { e.preventDefault(); const chapterNum = document.getElementById('create-chapter').value; const chapterName = this.categoryNames[chapterNum]; const text = document.getElementById('create-text').value; const code = document.getElementById('create-code').value; const opts = Array.from(document.querySelectorAll('.create-option')).map(i => i.value); const correctIdx = parseInt(document.querySelector('input[name="correct-idx"]:checked').value); const explanation = document.getElementById('create-explanation').value; const idPrefix = chapterNum === '99' ? 'user-' : `ch${chapterNum}-user-`; const newId = idPrefix + Date.now(); const newQ = { id: newId, category: chapterName, text: text, code: code, options: opts, answer: correctIdx, explanation: explanation }; app.data.questions.push(newQ); app.save(); alert('å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸï¼'); document.getElementById('create-form').reset(); this.updateCategoryLabel(); }
        };

        const dataManager = {
            importData(input) { if (input.files.length === 0) return; const readers = Array.from(input.files).map(file => new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsText(file); })); Promise.all(readers).then(results => { let count = 0; const newQs = []; const seenIds = new Set(app.data.questions.map(q => q.id)); results.forEach(res => { try { const json = JSON.parse(res); if (json.questions) json.questions.forEach(q => { if (!seenIds.has(q.id)) { newQs.push(q); seenIds.add(q.id); count++; } }); } catch (e) { } }); if (count > 0) { app.data.questions = [...app.data.questions, ...newQs]; app.save(); document.getElementById('import-alert').classList.add('hidden'); alert(`${count}å•ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`); app.renderChapters(); } input.value = ''; }); },
            resetAll() { if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('javaSilverAI_v9_1'); location.reload(); } }
        };

        const aiTutor = {
            apiKey: '', model: 'gemini-1.5-flash',
            init() { /* same as fixed */ },
            toggleCustomModelInput() { /* same as fixed */ },
            saveKey() { /* same as fixed */ },
            updateStatus() { /* same as fixed */ },
            analyzeWeakness() { /* same as fixed */ },
            async generate() { /* same as fixed */ }
        };

        // Restore AI logic fully from v8.1 fix
        Object.assign(aiTutor, {
            init() {
                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.model = localStorage.getItem('gemini_api_model') || 'gemini-1.5-flash';
                const select = document.getElementById('api-model-select');
                if (select) {
                    if (['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'].includes(this.model)) {
                        select.value = this.model;
                        document.getElementById('api-model-custom').classList.add('hidden');
                    } else {
                        select.value = 'custom';
                        document.getElementById('api-model-custom').classList.remove('hidden');
                        document.getElementById('api-model-custom').value = this.model;
                    }
                }
                this.updateStatus();
            },
            toggleCustomModelInput() {
                const val = document.getElementById('api-model-select').value;
                const customInput = document.getElementById('api-model-custom');
                if (val === 'custom') {
                    customInput.classList.remove('hidden');
                } else {
                    customInput.classList.add('hidden');
                }
            },
            saveKey() {
                const key = document.getElementById('api-key-input').value.trim();
                let model = document.getElementById('api-model-select').value;
                if (model === 'custom') {
                    model = document.getElementById('api-model-custom').value.trim();
                }
                if (key) localStorage.setItem('gemini_api_key', key);
                localStorage.setItem('gemini_api_model', model);
                this.model = model;
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
                this.init();
            },
            updateStatus() {
                const statusEl = document.getElementById('key-status');
                if (this.apiKey) {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> è¨­å®šæ¸ˆã¿ (' + this.model + ')';
                    statusEl.className = 'text-xs text-emerald-600 mt-2 flex items-center gap-1 font-bold';
                    document.getElementById('btn-generate').disabled = false;
                } else {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-slate-300"></span> æœªè¨­å®š';
                    statusEl.className = 'text-xs text-slate-400 mt-2 flex items-center gap-1';
                    document.getElementById('btn-generate').disabled = true;
                }
            },
            analyzeWeakness() {
                if (app.data.questions.length === 0) return "Java Silverå…¨èˆ¬";
                const cats = {};
                for (const q of app.data.questions) {
                    const c = q.category || 'General';
                    if (!cats[c]) cats[c] = { total: 0, correct: 0 };
                    if (app.data.results[q.id] !== undefined) {
                        cats[c].total++;
                        if (app.data.results[q.id]) cats[c].correct++;
                    }
                }
                const weaks = Object.keys(cats)
                    .filter(k => cats[k].total > 0)
                    .map(k => ({ name: k, rate: cats[k].correct / cats[k].total }))
                    .sort((a, b) => a.rate - b.rate)
                    .slice(0, 3);

                const ul = document.getElementById('weak-list');
                ul.innerHTML = '';
                const area = document.getElementById('ai-analysis');
                if (weaks.length > 0) {
                    area.classList.remove('hidden');
                    weaks.forEach(w => ul.innerHTML += `<li>${w.name} (${Math.round(w.rate * 100)}%)</li>`);
                    return weaks.map(w => w.name).join(',');
                } else {
                    area.classList.add('hidden');
                    return "Java Silverå…¨èˆ¬";
                }
            },
            async generate() {
                const topics = this.analyzeWeakness() || "Java Silverå…¨èˆ¬";
                const btn = document.getElementById('btn-generate');
                const loading = document.getElementById('ai-loading');
                btn.classList.add('hidden');
                loading.classList.remove('hidden');

                const prompt = `Java Silver SE11ã®è©¦é¨“å¯¾ç­–ã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‹¦æ‰‹åˆ†é‡ã€${topics}ã€‘ã«é–¢ã™ã‚‹4æŠå•é¡Œã‚’5å•ä½œæˆã—ã¦ãã ã•ã„ã€‚
                å‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã®ã¿ã€‚Markdownè¨˜æ³•ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚
                [{"id": "ai-${Date.now()}-1", "category": "...", "text": "...", "code": "...", "options": ["..."], "answer": 0, "explanation": "..."}]`;

                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`;

                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.error?.message || res.statusText);
                    }

                    const data = await res.json();
                    let text = data.candidates[0].content.parts[0].text;
                    const jsonMatch = text.match(/\[\s*\{.*\}\s*\]/s);
                    text = jsonMatch ? jsonMatch[0] : text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newQs = JSON.parse(text);

                    newQs.forEach((q, i) => {
                        q.id = `ai-${Date.now()}-${i}`;
                        app.data.questions.push(q);
                    });
                    app.save();
                    alert('5å•ã®å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ã€ŒAIç”Ÿæˆã€ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¼”ç¿’ã§ãã¾ã™ã€‚');
                    app.updateDashboard();
                } catch (e) {
                    alert(`AIç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${e.message}\n\nãƒ¢ãƒ‡ãƒ«åãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚`);
                } finally {
                    btn.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            }
        });

        // Initialize
        app.init();
        creator.updateCategoryLabel();
    </script>
</body>

</html>