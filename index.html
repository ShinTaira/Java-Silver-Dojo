<!DOCTYPE html>
<html lang="ja" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java Silver å®Œå…¨æ”»ç•¥é“å ´ (Ver 15.9 - Final Fix)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜•ï¸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .drill-card { transition: all 0.2s ease; border-bottom: 4px solid transparent; }
        .drill-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .option-btn { transition: all 0.1s ease; }
        .option-selected { background-color: #eff6ff !important; border-color: #3b82f6 !important; color: #1d4ed8 !important; box-shadow: 0 0 0 2px #3b82f6 inset !important; }
        .option-selected .opt-mark { background-color: #3b82f6 !important; color: white !important; }
        
        .dark .option-selected { background-color: #1e3a8a !important; border-color: #60a5fa !important; color: #bfdbfe !important; box-shadow: 0 0 0 2px #60a5fa inset !important; }
        .dark .option-selected .opt-mark { background-color: #60a5fa !important; color: #1e3a8a !important; }

        .loader { border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Coding Area specific */
        .coding-textarea {
            background-color: #1e1e1e;
            color: #d4d4d4;
            caret-color: white;
            font-family: 'Consolas', 'Monaco', 'Andale Mono', 'Ubuntu Mono', monospace;
            line-height: 1.5;
            tab-size: 4;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-[#f8fafc] dark:bg-darkbg dark:text-slate-200">

    <!-- Navbar -->
    <header class="bg-white dark:bg-darkcard border-b border-slate-200 dark:border-slate-700 z-50 shrink-0 transition-colors">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-xl shadow-md">â˜•ï¸</div>
                    <div>
                        <h1 class="font-bold text-xl tracking-tight text-slate-900 dark:text-white">Java Silver é“å ´</h1>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-none">Ver 15.9 Final Fix</p>
                    </div>
                </div>
                <div class="flex items-center gap-1 sm:gap-2">
                    <nav class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg overflow-x-auto">
                        <button onclick="app.switchTab('dashboard')" id="nav-dashboard" class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">ãƒ›ãƒ¼ãƒ </button>
                        <button onclick="app.switchTab('create')" id="nav-create" class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">ä½œæˆ</button>
                        <button onclick="app.switchTab('coding')" id="nav-coding" class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">ğŸ’» å®Ÿè·µ</button>
                        <button onclick="app.switchTab('history')" id="nav-history" class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">è¨˜éŒ²</button>
                        <button onclick="app.switchTab('ai')" id="nav-ai" class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">AI</button>
                        <button onclick="app.switchTab('settings')" id="nav-settings" class="nav-item px-3 py-1.5 text-sm font-medium rounded-md transition whitespace-nowrap text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white">è¨­å®š</button>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative">
        
        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 fade-in">
            <div class="max-w-5xl mx-auto">
                <!-- Status Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase">ç™»éŒ²å•é¡Œæ•°</div>
                        <div class="text-3xl font-bold text-slate-800 dark:text-white mt-1" id="stat-total">0</div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-xs text-slate-400 font-bold uppercase">æ­£è§£ç‡</div>
                        <div class="text-3xl font-bold text-emerald-500 mt-1" id="stat-rate">0%</div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm col-span-2 flex items-center justify-between bg-gradient-to-r from-white to-slate-50 dark:from-darkcard dark:to-slate-800">
                        <div>
                            <div class="text-xs text-slate-400 font-bold uppercase">è‹¦æ‰‹ãªå•é¡Œ</div>
                            <div class="text-3xl font-bold text-red-500 mt-1"><span id="wrong-count">0</span> <span class="text-base text-slate-400 font-normal">å•</span></div>
                        </div>
                        <button onclick="app.startQuiz('review')" id="btn-review" class="px-6 py-2.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 font-bold rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 transition disabled:opacity-50 disabled:cursor-not-allowed">å¾©ç¿’ã™ã‚‹</button>
                    </div>
                </div>

                <!-- Main Actions -->
                <div class="grid md:grid-cols-2 gap-6 mb-10">
                    <div class="bg-white dark:bg-darkcard p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="text-base font-bold text-slate-700 dark:text-slate-200 mb-3 flex items-center gap-2"><span class="text-xl">ğŸ”</span> ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¼”ç¿’</h3>
                        <div class="flex gap-2">
                            <input type="text" id="search-input" class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition dark:text-white" placeholder="ä¾‹: ãƒ©ãƒ ãƒ€, ä¾‹å¤–, ç¶™æ‰¿...">
                            <button onclick="app.startSearchQuiz()" class="bg-slate-800 dark:bg-slate-700 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-700 dark:hover:bg-slate-600 transition">æ¤œç´¢</button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between">
                        <div>
                            <h3 class="text-base font-bold text-slate-700 dark:text-slate-200 mb-1 flex items-center gap-2"><span class="text-xl">ğŸ”–</span> ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</h3>
                            <p class="text-xs text-slate-400">ä¿å­˜æ¸ˆã¿: <span id="bookmark-count" class="font-bold text-slate-700 dark:text-slate-300">0</span> å•</p>
                        </div>
                        <button onclick="app.startQuiz('bookmark')" id="btn-bookmark" class="px-6 py-2.5 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 font-bold rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/50 transition disabled:opacity-50">è§£ã</button>
                    </div>
                </div>

                <!-- NEW Coding Link -->
                <div class="mb-10" onclick="app.switchTab('coding')">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl p-6 text-white shadow-lg cursor-pointer hover:scale-[1.01] transition relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 text-8xl opacity-10 group-hover:scale-110 transition">ğŸ’»</div>
                        <h3 class="text-xl font-bold flex items-center gap-2 mb-1"><span>å®Ÿè·µã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é“å ´</span><span class="bg-white/20 text-[10px] px-2 py-0.5 rounded">NEW</span></h3>
                        <p class="text-emerald-100 text-sm">æ‰‹ã‚’å‹•ã‹ã—ã¦è¦šãˆã‚‹ã€‚å…¨20å•ä»¥ä¸Šã®å®Ÿè·µãƒ‰ãƒªãƒ«ã€‚</p>
                    </div>
                </div>

                <!-- User Questions -->
                <div class="mb-10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span>ğŸ“š ã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œé›†</span><span class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 text-[10px] px-2 py-0.5 rounded font-bold">User Made</span></h3>
                    </div>
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 dark:from-slate-900 dark:to-black rounded-2xl p-6 text-white shadow-lg relative overflow-hidden group border border-slate-700">
                        <div class="absolute top-0 right-0 p-8 opacity-10 text-9xl transform translate-x-10 -translate-y-4 select-none">âœï¸</div>
                        <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                            <div>
                                <h4 class="text-xl font-bold mb-1">My å•é¡Œé›†ï¼ˆé»’æœ¬å†ç¾ãªã©ï¼‰</h4>
                                <p class="text-slate-400 text-sm">ä½œæˆã—ãŸã‚ªãƒªã‚¸ãƒŠãƒ«å•é¡Œã®ã¿ã‚’å‡ºé¡Œã€‚<br><span class="text-xs opacity-70">â€»ç™»éŒ²æ•°: <span id="user-q-count">0</span> å•</span></p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="app.startQuiz('user-random')" class="px-5 py-2.5 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg text-sm font-bold transition">ãƒ©ãƒ³ãƒ€ãƒ 10å•</button>
                                <button onclick="app.startQuiz('user-all')" class="px-5 py-2.5 bg-indigo-500 hover:bg-indigo-400 text-white rounded-lg text-sm font-bold shadow-lg transition">å…¨å•è§£ã</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chapters Grid -->
                <div class="mb-12">
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4">ğŸ“– ç« ã”ã¨ã®æ¼”ç¿’ (ç¿’ç†Ÿåº¦)</h3>
                    <div id="chapter-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <div class="col-span-full py-12 text-center text-slate-400 bg-white dark:bg-darkcard border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                            <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã¨ã“ã“ã«ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CODING TAB (NEW) -->
        <div id="tab-coding" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-5xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><span>ğŸ’» å®Ÿè·µã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é“å ´</span></h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦è¦šãˆã‚ˆã†ï¼ˆå†™çµŒãƒ»æ¨¡å†™ãƒ¢ãƒ¼ãƒ‰ï¼‰</p>
                    </div>
                </div>

                <!-- Coding Menu -->
                <div id="coding-menu" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <!-- Dynamic generation -->
                </div>

                <!-- Coding Workspace (Hidden by default) -->
                <div id="coding-workspace" class="hidden flex-1 flex flex-col md:flex-row gap-4 h-full min-h-[500px]">
                    <!-- Problem Side -->
                    <div class="md:w-1/3 flex flex-col gap-4">
                        <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex-1">
                            <button onclick="codingApp.close()" class="mb-4 text-xs text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white font-bold flex items-center gap-1">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                            <span class="text-xs font-bold text-white px-2 py-0.5 rounded" id="coding-tag">åŸºæœ¬</span>
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mt-2 mb-4" id="coding-title">å•é¡Œã‚¿ã‚¤ãƒˆãƒ«</h3>
                            <div class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed whitespace-pre-wrap" id="coding-desc">ã“ã“ã«å•é¡Œæ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
                            
                            <div id="coding-hint-box" class="mt-6 hidden">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">å¿…é ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</div>
                                <div id="coding-keywords" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Editor Side -->
                    <div class="md:w-2/3 flex flex-col gap-4">
                        <div class="flex-1 bg-[#1e1e1e] rounded-xl overflow-hidden border border-slate-700 shadow-lg flex flex-col">
                            <div class="bg-[#2d2d2d] px-4 py-2 flex justify-between items-center border-b border-[#3e3e3e]">
                                <span class="text-xs text-gray-400 font-mono">Main.java</span>
                                <span class="text-[10px] text-gray-500">Auto-saved</span>
                            </div>
                            <textarea id="coding-editor" class="coding-textarea flex-1 p-4 w-full h-full resize-none outline-none text-sm" spellcheck="false" placeholder="// ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <button onclick="codingApp.showAnswer()" class="text-sm text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400 underline">æ¨¡ç¯„è§£ç­”ã‚’è¦‹ã‚‹</button>
                            <button onclick="codingApp.check()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition active:scale-95 flex items-center gap-2">
                                <span>åˆ¤å®šã™ã‚‹</span> <span class="text-lg">â–¶</span>
                            </button>
                        </div>

                        <!-- Result Area -->
                        <div id="coding-result" class="hidden bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-lg fade-in">
                            <h4 class="font-bold text-lg mb-2 flex items-center gap-2" id="coding-result-title"></h4>
                            <p class="text-sm text-slate-600 dark:text-slate-300 mb-4" id="coding-result-msg"></p>
                            
                            <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-3 border border-slate-200 dark:border-slate-600">
                                <div class="text-xs text-slate-400 mb-1">æ¨¡ç¯„è§£ç­”:</div>
                                <pre class="text-xs overflow-x-auto"><code class="language-java" id="coding-answer-code"></code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CREATE TAB -->
        <div id="tab-create" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-3xl mx-auto space-y-6">
                <div class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="border-b border-slate-100 dark:border-slate-700 p-5 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><span>ğŸ“ å•é¡Œã‚’ä½œæˆ</span></h2>
                        <span class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-2 py-1 rounded font-bold">User Studio</span>
                    </div>
                    <form id="create-form" onsubmit="creator.saveQuestion(event)" class="p-6 space-y-6">
                        <input type="hidden" id="edit-id" value="">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ã‚«ãƒ†ã‚´ãƒª (ç« )</label>
                                <div class="relative">
                                    <select id="create-chapter" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none appearance-none transition dark:text-white" onchange="creator.updateCategoryLabel()">
                                        <option value="1">ç¬¬1ç« : Javaã®åŸºæœ¬</option>
                                        <option value="2">ç¬¬2ç« : ãƒ‡ãƒ¼ã‚¿å‹ã¨å¤‰æ•°</option>
                                        <option value="3">ç¬¬3ç« : æ¼”ç®—å­</option>
                                        <option value="4">ç¬¬4ç« : ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡</option>
                                        <option value="5">ç¬¬5ç« : é…åˆ—</option>
                                        <option value="6">ç¬¬6ç« : ã‚¯ãƒ©ã‚¹ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹</option>
                                        <option value="7">ç¬¬7ç« : ç¶™æ‰¿</option>
                                        <option value="8">ç¬¬8ç« : ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</option>
                                        <option value="9">ç¬¬9ç« : ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ </option>
                                        <option value="10">ç¬¬10ç« : ä¾‹å¤–å‡¦ç†</option>
                                        <option value="11">ç¬¬11ç« : ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</option>
                                        <option value="12">ç¬¬12ç« : ä¸»è¦API</option>
                                        <option value="13">ç¬¬13ç« : ãƒ©ãƒ ãƒ€å¼</option>
                                        <option value="mock1">æ¨¡æ“¬è©¦é¨“â‘ </option>
                                        <option value="mock2">æ¨¡æ“¬è©¦é¨“â‘¡</option>
                                        <option value="mock3">æ¨¡æ“¬è©¦é¨“â‘¢</option>
                                        <option value="99">ãã®ä»–</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                                </div>
                                <input type="hidden" id="create-cat-name" value="Javaã®åŸºæœ¬">
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">å•é¡Œæ–‡</label><textarea id="create-text" rows="3" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white" required placeholder="å•é¡Œæ–‡ã‚’å…¥åŠ›..."></textarea></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Javaã‚³ãƒ¼ãƒ‰ (ä»»æ„)</label><textarea id="create-code" rows="4" class="w-full bg-slate-900 text-slate-200 font-mono text-sm rounded-lg p-3 border border-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="public class Main { ... }"></textarea></div>
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center mb-3"><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">é¸æŠè‚¢ & æ­£è§£</label><button type="button" onclick="creator.addOption()" class="text-xs bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-indigo-600 dark:text-indigo-400 px-3 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900 transition font-bold shadow-sm">ï¼‹ è¿½åŠ </button></div>
                                <div id="options-container" class="space-y-3"></div>
                                <p class="text-xs text-indigo-500 dark:text-indigo-400 mt-2 font-bold ml-1">â€» æ­£è§£ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">è§£èª¬</label><textarea id="create-explanation" rows="4" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white" required placeholder="è§£èª¬ã‚’å…¥åŠ›..."></textarea></div>
                        </div>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3">
                            <button type="button" onclick="creator.cancelEdit()" id="btn-cancel-edit" class="hidden text-sm text-slate-500 hover:text-slate-800 px-4 py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" id="btn-save-question" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5">è¿½åŠ ã™ã‚‹</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">ä½œæˆæ¸ˆã¿ãƒªã‚¹ãƒˆ</h3>
                    <div id="user-questions-list" class="space-y-2"><div class="text-center text-slate-400 py-8 text-sm">ã¾ã è‡ªä½œå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
                </div>
            </div>
        </div>

        <!-- AI TAB -->
        <div id="tab-ai" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-2xl mx-auto space-y-6">
                <div class="bg-white dark:bg-darkcard p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><span>ğŸ”‘ Gemini API è¨­å®š</span></h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">API Key</label>
                            <div class="flex gap-2">
                                <input type="password" id="api-key-input" class="flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-sm outline-none focus:border-indigo-500 transition dark:text-white" placeholder="AIzaSy...">
                                <button onclick="aiTutor.saveKey()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition">ä¿å­˜</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Model</label>
                            <select id="api-model-select" class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none dark:text-white" onchange="aiTutor.toggleCustomModelInput()">
                                <option value="gemini-1.5-flash">gemini-1.5-flash (æ¨å¥¨ãƒ»é«˜é€Ÿ)</option>
                                <option value="gemini-1.5-pro">gemini-1.5-pro (é«˜ç²¾åº¦)</option>
                                <option value="gemini-pro">gemini-pro (æ—§å®‰å®šç‰ˆ)</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
                            </select>
                            <input type="text" id="api-model-custom" class="w-full mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm outline-none hidden dark:text-white" placeholder="ä¾‹: gemini-2.0-flash-exp">
                        </div>
                    </div>
                    <div id="key-status" class="text-xs text-slate-400 mt-4 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> æœªè¨­å®š</div>
                </div>
                <div class="bg-gradient-to-br from-indigo-600 to-violet-600 p-8 rounded-2xl shadow-lg text-white relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-9xl opacity-10 select-none">ğŸ¤–</div>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold mb-1">AI å¼±ç‚¹å…‹æœã‚³ãƒ¼ãƒ</h2>
                        <p class="text-indigo-100 text-sm mb-6">å­¦ç¿’å±¥æ­´ã‚’åˆ†æã—ã¦ã€ã‚ãªãŸå°‚ç”¨ã®å•é¡Œã‚’ä½œæˆã—ã¾ã™ã€‚</p>
                        <div id="ai-analysis" class="bg-white/10 backdrop-blur-md rounded-lg p-4 mb-6 border border-white/20 hidden">
                            <h4 class="text-xs font-bold text-indigo-200 uppercase tracking-wider mb-2">Detected Weaknesses</h4>
                            <ul id="weak-list" class="list-disc list-inside text-sm space-y-1 text-white"></ul>
                        </div>
                        <button onclick="aiTutor.generate()" id="btn-generate" class="w-full bg-white text-indigo-600 font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-50 transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ğŸš€ å•é¡Œã‚’ç”Ÿæˆã™ã‚‹</button>
                        <div id="ai-loading" class="hidden mt-6 flex flex-col items-center">
                            <div class="loader mb-3 border-t-white border-white/20"></div>
                            <p class="text-xs text-indigo-100 animate-pulse" id="ai-status-text">æ€è€ƒä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-2xl mx-auto space-y-8">
                <!-- Theme Switcher -->
                <div class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">ğŸŒ™ å¤–è¦³è¨­å®š</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400">ç›®ã«å„ªã—ã„ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</p>
                    </div>
                    <button onclick="app.toggleTheme()" id="theme-toggle-btn" class="bg-slate-200 dark:bg-slate-700 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none">
                        <span aria-hidden="true" id="theme-toggle-circle" class="translate-x-0 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                    </button>
                </div>

                <div class="bg-white dark:bg-darkcard rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <p class="text-sm text-slate-500 mb-6">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã§ãã¾ã™ã€‚</p>
                    <div class="grid gap-4">
                        <div class="border border-slate-100 dark:border-slate-700 rounded-lg p-4 bg-slate-50 dark:bg-slate-800">
                            <h4 class="font-bold text-sm text-slate-700 dark:text-slate-300 mb-2">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (ä¿å­˜)</h4>
                            <button onclick="dataManager.exportData()" class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-bold shadow-sm">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button>
                        </div>
                        <div class="border border-slate-100 dark:border-slate-700 rounded-lg p-4 bg-slate-50 dark:bg-slate-800">
                            <h4 class="font-bold text-sm text-slate-700 dark:text-slate-300 mb-2">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (èª­ã¿è¾¼ã¿)</h4>
                            <label class="text-sm bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-600 transition font-bold shadow-sm cursor-pointer inline-block">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã‚€
                                <input type="file" class="hidden" onchange="dataManager.importData(this)">
                            </label>
                        </div>
                        <div class="border border-red-50 dark:border-red-900/30 rounded-lg p-4 bg-red-50/50 dark:bg-red-900/20 mt-4">
                            <h4 class="font-bold text-sm text-red-700 dark:text-red-400 mb-2">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</h4>
                            <button onclick="dataManager.resetAll()" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-300 underline">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
                <div class="text-center text-xs text-slate-400">
                    <p>Java Silver Dojo Ver 15.9</p>
                    <p>Storage Key: javaSilverDojo_GlobalData</p>
                </div>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="tab-history" class="absolute inset-0 overflow-y-auto p-4 sm:p-8 hidden fade-in">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2"><span>ğŸ“ˆ å­¦ç¿’è¨˜éŒ²</span></h2>
                    <select id="history-filter" class="text-sm border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-1.5 bg-white dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-indigo-500" onchange="app.renderHistory()">
                        <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
                        <option value="mock">æ¨¡æ“¬è©¦é¨“</option>
                        <option value="level">ãƒ¬ãƒ™ãƒ«åˆ¥</option>
                    </select>
                </div>
                <div class="grid md:grid-cols-12 gap-6">
                    <div class="md:col-span-8 space-y-6">
                        <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-64 md:h-80"><canvas id="historyChart"></canvas></div>
                        <div id="history-list" class="space-y-3"></div>
                    </div>
                    <div class="md:col-span-4">
                        <div class="sticky top-6">
                            <div class="bg-white dark:bg-darkcard p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none text-9xl">ğŸ’Š</div>
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2 relative z-10"><span class="text-xl">ğŸš‘</span> è‹¦æ‰‹å…‹æœã‚µãƒãƒ¼ãƒˆ</h3>
                                <div id="weakness-advice-list" class="space-y-4 relative z-10"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUIZ VIEW -->
        <div id="quiz-view" class="absolute inset-0 overflow-y-auto p-4 bg-[#f8fafc] dark:bg-darkbg hidden z-50">
            <div class="max-w-3xl mx-auto pb-20 fade-in mt-4">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="app.quitQuiz()" class="text-xs text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-bold flex items-center gap-1 p-2 transition"><span class="text-lg">â†</span> ä¸­æ–­ã—ã¦æˆ»ã‚‹</button>
                    <div class="text-xs font-mono text-slate-500 dark:text-slate-400 bg-white dark:bg-darkcard border border-slate-200 dark:border-slate-600 px-3 py-1 rounded-full shadow-sm" id="mode-display">Random</div>
                </div>
                <div id="quiz-timer" class="hidden text-center text-xl font-mono font-bold text-slate-700 dark:text-slate-200 mb-6 bg-yellow-50 dark:bg-yellow-900/20 py-2 rounded-lg border border-yellow-200 dark:border-yellow-900/50">â³ 90:00</div>
                
                <!-- KEYBOARD HINT -->
                <div class="text-center text-[10px] text-slate-400 mb-2 font-mono hidden md:block">
                    [Key: 1-4:Select, Enter:Submit/Next]
                </div>

                <div class="bg-white dark:bg-darkcard p-6 md:p-10 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 mb-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100 dark:bg-slate-800"><div id="quiz-progress" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div></div>
                    <div class="flex justify-between items-start mb-6 mt-2">
                        <span class="inline-block bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-3 py-1 rounded-md text-xs font-bold tracking-wide uppercase border border-indigo-100 dark:border-indigo-800" id="q-category">Category</span>
                        <div class="flex items-center gap-3">
                            <button onclick="app.toggleBookmark()" id="btn-quiz-bookmark" class="text-slate-300 hover:text-yellow-400 transition transform hover:scale-110 focus:outline-none">
                                <svg class="w-6 h-6 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                            <div class="font-mono text-slate-300 font-bold text-xl"><span id="q-current" class="text-slate-800 dark:text-white">1</span><span class="text-sm">/</span><span id="q-total" class="text-sm">10</span></div>
                        </div>
                    </div>
                    <h3 class="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-100 mb-6 leading-relaxed whitespace-pre-wrap" id="q-text">Problem Text</h3>
                    <div id="code-container" class="bg-[#1e1e1e] rounded-lg overflow-hidden mb-6 relative group hidden border border-slate-700 shadow-inner">
                        <pre class="!m-0 !p-5 overflow-x-auto text-sm"><code class="language-java code-input text-gray-100 leading-6 font-mono" id="code-content"></code></pre>
                    </div>
                </div>
                <div id="options-list" class="grid gap-3 mb-10"></div>
                <button id="btn-submit-answer" onclick="app.submitAnswer()" class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-[0.98] mb-8 text-lg">å›ç­”ã™ã‚‹ (Enter)</button>
                
                <!-- Explanation with Memo -->
                <div id="explanation-box" class="hidden bg-white dark:bg-darkcard border border-emerald-100 dark:border-emerald-900/50 rounded-2xl p-6 md:p-8 shadow-lg fade-in relative overflow-hidden ring-4 ring-emerald-50 dark:ring-emerald-900/20">
                    <div class="absolute top-0 right-0 p-6 opacity-10"><svg class="w-32 h-32 text-emerald-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg></div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-4"><span id="result-badge" class="font-bold text-xl"></span></div>
                        <div class="text-slate-700 dark:text-slate-300 text-sm md:text-base leading-8 whitespace-pre-wrap font-mono mb-8" id="explanation-text"></div>
                        
                        <!-- NEW: Memo Feature -->
                        <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl p-4 border border-indigo-100 dark:border-indigo-800 mb-6">
                            <h4 class="text-xs font-bold text-indigo-500 dark:text-indigo-400 uppercase tracking-wider mb-2 flex items-center gap-1"><span>âœï¸</span> è‡ªåˆ†ç”¨ãƒ¡ãƒ¢</h4>
                            <textarea id="user-note-input" class="w-full bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-800 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition dark:text-white" rows="2" placeholder="ã“ã“ãŒé–“é•ãˆã‚„ã™ã„ã€â—‹â—‹ãƒ¡ã‚½ãƒƒãƒ‰ã¯Ã—Ã—ãªã©..."></textarea>
                            <div class="flex justify-end mt-2">
                                <button onclick="app.saveNote()" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 transition font-bold">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
                            </div>
                        </div>
                        
                        <button onclick="app.nextQuestion()" class="w-full bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2 active:scale-[0.98]">
                            <span>æ¬¡ã®å•é¡Œã¸ (Enter)</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="session-result" class="fixed inset-0 bg-slate-900/90 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-darkcard rounded-2xl shadow-2xl max-w-sm w-full p-8 text-center space-y-6 fade-in transform scale-100">
                <div class="text-6xl mb-2 animate-bounce">ğŸ‰</div>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-white">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h3>
                <div class="grid grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-800 p-5 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div><div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">æ­£è§£æ•°</div><div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-1"><span id="res-score">0</span></div></div>
                    <div><div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">æ­£è§£ç‡</div><div class="text-3xl font-bold text-slate-800 dark:text-white mt-1" id="res-rate">0%</div></div>
                </div>
                <button onclick="app.closeSessionResult()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition active:scale-95">OK</button>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script>
        const STORAGE_KEY = 'javaSilverDojo_GlobalData';
        const LEGACY_KEYS = ['javaSilverAI_v14_2', 'javaSilverAI_v14_8'];

        const codingDrills = [
            { id: 'c1', title: 'Hello World', tag: 'åŸºæœ¬', desc: 'Mainã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€mainãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ "Hello World" ã¨å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['class', 'Main', 'public', 'static', 'void', 'main', 'System.out.println', 'Hello World'], answer: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}' },
            { id: 'c2', title: 'å¤‰æ•°ã®å®£è¨€', tag: 'åŸºæœ¬', desc: 'intå‹ã®å¤‰æ•° num ã‚’å®£è¨€ã—ã¦ 10 ã‚’ä»£å…¥ã—ã€ãã®å€¤ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['int', 'num', '=', '10', 'System.out.println'], answer: 'public class Main {\n    public static void main(String[] args) {\n        int num = 10;\n        System.out.println(num);\n    }\n}' },
            { id: 'c3', title: 'æ¡ä»¶åˆ†å² (if)', tag: 'åŸºæœ¬', desc: 'intå‹ã®å¤‰æ•° score ãŒ 80 ä»¥ä¸Šã®å ´åˆã¯ "Pass"ã€ãã‚Œä»¥å¤–ã¯ "Fail" ã¨å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['if', 'else', '>=', 'System.out.println'], answer: 'int score = 85;\nif (score >= 80) {\n    System.out.println("Pass");\n} else {\n    System.out.println("Fail");\n}' },
            { id: 'c4', title: 'ãƒ«ãƒ¼ãƒ— (for)', tag: 'åŸºæœ¬', desc: 'foræ–‡ã‚’ä½¿ã£ã¦ã€0ã‹ã‚‰4ã¾ã§ã®æ•°å­—ã‚’é †ç•ªã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['for', 'int', 'i', '<', '++', 'System.out.println'], answer: 'for (int i = 0; i < 5; i++) {\n    System.out.println(i);\n}' },
            { id: 'c5', title: 'é…åˆ—ã®æ“ä½œ', tag: 'åŸºæœ¬', desc: 'Stringå‹ã®é…åˆ— colors ã‚’ä½œæˆã—ã€"Red", "Blue", "Green" ã‚’æ ¼ç´ã—ã¦ã€æ‹¡å¼µforæ–‡ã§ã™ã¹ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['String[]', 'colors', '{', '}', 'for', 'String', 'System.out.println'], answer: 'String[] colors = {"Red", "Blue", "Green"};\nfor (String color : colors) {\n    System.out.println(color);\n}' },
            { id: 'c6', title: 'æ–‡å­—åˆ—ã®é•·ã•', tag: 'åˆç´š', desc: 'Stringå‹ã®å¤‰æ•° str ã« "Java" ã‚’ä»£å…¥ã—ã€ãã®æ–‡å­—æ•°ï¼ˆé•·ã•ï¼‰ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['String', 'str', 'length()', 'System.out.println'], answer: 'String str = "Java";\nSystem.out.println(str.length());' },
            { id: 'c7', title: 'Switchæ–‡', tag: 'åˆç´š', desc: 'intå‹ã®å¤‰æ•° day ãŒ 1 ã®å ´åˆã¯ "Monday"ã€2 ã®å ´åˆã¯ "Tuesday"ã€ãã‚Œä»¥å¤–ã¯ "Other" ã¨å‡ºåŠ›ã™ã‚‹ switch æ–‡ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚', keywords: ['switch', 'case', 'break', 'default', 'System.out.println'], answer: 'int day = 1;\nswitch (day) {\n    case 1:\n        System.out.println("Monday");\n        break;\n    case 2:\n        System.out.println("Tuesday");\n        break;\n    default:\n        System.out.println("Other");\n        break;\n}' },
            { id: 'c8', title: 'å‹å¤‰æ› (Cast)', tag: 'åˆç´š', desc: 'doubleå‹ã®å¤‰æ•° d ã« 9.9 ã‚’ä»£å…¥ã—ã€ãã‚Œã‚’ intå‹ã«ã‚­ãƒ£ã‚¹ãƒˆã—ã¦å¤‰æ•° i ã«ä»£å…¥ã—ãŸå¾Œã€i ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['double', 'int', '(int)', 'System.out.println'], answer: 'double d = 9.9;\nint i = (int) d;\nSystem.out.println(i);' },
            { id: 'c9', title: 'ã‚¯ãƒ©ã‚¹ã®å®šç¾©', tag: 'ä¸­ç´š (OOP)', desc: 'name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆStringï¼‰ã‚’æŒã¤ Person ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¦ãã ã•ã„ã€‚', keywords: ['class', 'Person', 'String', 'name'], answer: 'class Person {\n    String name;\n}' },
            { id: 'c10', title: 'ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿', tag: 'ä¸­ç´š (OOP)', desc: 'Person ã‚¯ãƒ©ã‚¹ã«ã€name ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚ŠåˆæœŸåŒ–ã™ã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', keywords: ['Person', 'String', 'this.name', '='], answer: 'class Person {\n    String name;\n    public Person(String name) {\n        this.name = name;\n    }\n}' },
            { id: 'c11', title: 'ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©', tag: 'ä¸­ç´š (OOP)', desc: '2ã¤ã® int å‹å¼•æ•°ã‚’å—ã‘å–ã‚Šã€ãã®å’Œã‚’è¿”ã™é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ add ã‚’å®šç¾©ã—ã¦ãã ã•ã„ã€‚', keywords: ['public', 'static', 'int', 'add', 'return', '+'], answer: 'public static int add(int a, int b) {\n    return a + b;\n}' },
            { id: 'c12', title: 'ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰', tag: 'ä¸­ç´š (OOP)', desc: 'Object ã‚¯ãƒ©ã‚¹ã® toString ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã€"MyObject" ã¨ã„ã†æ–‡å­—åˆ—ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚', keywords: ['@Override', 'public', 'String', 'toString', 'return'], answer: '@Override\npublic String toString() {\n    return "MyObject";\n}' },
            { id: 'c13', title: 'ã‚«ãƒ—ã‚»ãƒ«åŒ–', tag: 'ä¸­ç´š (OOP)', desc: 'private ãª int å‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ age ã‚’æŒã¡ã€ãã® getter ã¨ setter ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã‚¯ãƒ©ã‚¹å®šç¾©ã®ä¸€éƒ¨ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚', keywords: ['private', 'int', 'age', 'public', 'getAge', 'setAge', 'return', 'this.age'], answer: 'private int age;\n\npublic int getAge() {\n    return age;\n}\n\npublic void setAge(int age) {\n    this.age = age;\n}' },
            { id: 'c14', title: 'ä¾‹å¤–å‡¦ç†', tag: 'ä¸Šç´š (Silver)', desc: '0é™¤ç®—ã®å¯èƒ½æ€§ãŒã‚ã‚‹å‡¦ç†ã‚’ try-catch ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã¿ã€ArithmeticException ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ "Error" ã¨å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['try', 'catch', 'ArithmeticException', 'System.out.println'], answer: 'try {\n    int result = 10 / 0;\n} catch (ArithmeticException e) {\n    System.out.println("Error");\n}' },
            { id: 'c15', title: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹', tag: 'ä¸Šç´š (Silver)', desc: 'greet ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå¼•æ•°ãªã—ã€æˆ»ã‚Šå€¤voidï¼‰ã‚’æŒã¤ Greeter ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ãã ã•ã„ã€‚', keywords: ['interface', 'Greeter', 'void', 'greet'], answer: 'interface Greeter {\n    void greet();\n}' },
            { id: 'c16', title: 'ãƒ©ãƒ ãƒ€å¼', tag: 'ä¸Šç´š (Silver)', desc: 'List<String> list ã®å„è¦ç´ ã‚’ã€forEach ãƒ¡ã‚½ãƒƒãƒ‰ã¨ãƒ©ãƒ ãƒ€å¼ã‚’ä½¿ã£ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['list.forEach', '->', 'System.out.println'], answer: 'list.forEach(s -> System.out.println(s));' },
            { id: 'c17', title: 'StringBuilder', tag: 'è©¦é¨“å¯¾ç­–', desc: 'StringBuilder ã‚’ä½¿ã£ã¦ "A" ã« "B" ã‚’è¿½åŠ ã—ã€ã•ã‚‰ã« "C" ã‚’è¿½åŠ ã—ã¦æ–‡å­—åˆ—ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['StringBuilder', 'new', 'append', 'toString', 'System.out.println'], answer: 'StringBuilder sb = new StringBuilder("A");\nsb.append("B").append("C");\nSystem.out.println(sb.toString());' },
            { id: 'c18', title: 'æ–‡å­—åˆ—æ¯”è¼ƒ', tag: 'è©¦é¨“å¯¾ç­–', desc: 'Stringå‹ã®å¤‰æ•° s1 ã¨ s2 ã®å†…å®¹ãŒç­‰ã—ã„ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ifæ–‡ã‚’æ›¸ã„ã¦ãã ã•ã„ï¼ˆnullãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ï¼‰ã€‚', keywords: ['if', 's1.equals(s2)'], answer: 'if (s1.equals(s2)) {\n    // å‡¦ç†\n}' },
            { id: 'c19', title: 'Mapæ“ä½œ', tag: 'æ¥­å‹™å®Ÿè·µ', desc: 'HashMap<String, Integer> ã‚’ä½œæˆã—ã€ã‚­ãƒ¼ "Apple" ã« 100 ã‚’è¿½åŠ ã—ã€ãã®å¾Œ "Apple" ã®å€¤ã‚’å–å¾—ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['HashMap', 'put', 'get', 'System.out.println'], answer: 'Map<String, Integer> map = new HashMap<>();\nmap.put("Apple", 100);\nSystem.out.println(map.get("Apple"));' },
            { id: 'c20', title: 'ãƒªã‚¹ãƒˆæŠ½å‡º', tag: 'æ¥­å‹™å®Ÿè·µ', desc: 'Integerå‹ã®ãƒªã‚¹ãƒˆ nums ã‹ã‚‰ã€å¶æ•°ã ã‘ã‚’æ‹¡å¼µforæ–‡ã¨ifæ–‡ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚', keywords: ['for', 'if', '%', '==', '0', 'System.out.println'], answer: 'for (Integer n : nums) {\n    if (n % 2 == 0) {\n        System.out.println(n);\n    }\n}' },
            { id: 'c21', title: 'Staticãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—', tag: 'ä¸­ç´š (OOP)', desc: 'Mathã‚¯ãƒ©ã‚¹ã®maxãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€10ã¨20ã®ã†ã¡å¤§ãã„æ–¹ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚', keywords: ['Math.max', 'System.out.println'], answer: 'System.out.println(Math.max(10, 20));' }
        ];

        const app = {
            data: { questions: [], results: {}, history: [], bookmarks: [], theme: 'light' },
            state: { queue: [], currentIdx: 0, sessionStats: { correct: 0, wrongInfo: [] }, modeName: '', timer: null, currentSelection: new Set(), isQuizActive: false },
            chartInstance: null,
            categoryLinks: {
                "Javaã®åŸºæœ¬": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/lang/package-summary.html",
                "ãƒ‡ãƒ¼ã‚¿å‹ã¨å¤‰æ•°": "https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html",
                "æ¼”ç®—å­": "https://docs.oracle.com/javase/tutorial/java/nutsandbolts/operators.html",
                "ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡": "https://docs.oracle.com/javase/tutorial/java/nutsandbolts/flow.html",
                "é…åˆ—": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/util/Arrays.html",
                "ã‚¯ãƒ©ã‚¹ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹": "https://docs.oracle.com/javase/tutorial/java/javaOO/classes.html",
                "ç¶™æ‰¿": "https://docs.oracle.com/javase/tutorial/java/IandI/subclasses.html",
                "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹": "https://docs.oracle.com/javase/tutorial/java/IandI/createinterface.html",
                "ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ": "https://docs.oracle.com/javase/tutorial/java/IandI/polymorphism.html",
                "ä¾‹å¤–å‡¦ç†": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/lang/Exception.html",
                "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/lang/module/package-summary.html",
                "ä¸»è¦API": "https://docs.oracle.com/javase/jp/11/docs/api/java.base/java/time/LocalDate.html",
                "ãƒ©ãƒ ãƒ€å¼": "https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html"
            },
            init() { 
                this.loadData(); 
                this.applyTheme();
                this.switchTab('dashboard'); 
                aiTutor.init(); 
                creator.resetForm(); 
                codingApp.init(); // Initialize Coding App
                this.setupKeyboardShortcuts();
            },
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Only active during quiz and not focused on input
                    if (!this.state.isQuizActive) return;
                    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

                    const key = e.key.toUpperCase();
                    // Option Selection (1-4 or A-D)
                    const map = { '1': 0, '2': 1, '3': 2, '4': 3, 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
                    
                    if (key in map) {
                        // Check if result is shown, prevent changing options
                        if (!document.getElementById('explanation-box').classList.contains('hidden')) return;
                        
                        const idx = map[key];
                        const btn = document.getElementById(`option-btn-${idx}`);
                        if (btn) this.selectOption(idx, btn);
                    }
                    
                    // Enter Key Action
                    if (key === 'ENTER') {
                        e.preventDefault();
                        const submitBtn = document.getElementById('btn-submit-answer');
                        const nextBtn = document.querySelector('#explanation-box button');
                        const resultBox = document.getElementById('explanation-box');
                        
                        // Case 1: Result shown -> Next Question
                        if (!resultBox.classList.contains('hidden')) {
                            this.nextQuestion();
                            return;
                        }
                        // Case 2: Options selected -> Submit
                        if (submitBtn && !submitBtn.classList.contains('hidden')) {
                            this.submitAnswer();
                        }
                    }
                    
                    // B key for Bookmark
                    if (key === 'B') {
                        this.toggleBookmark();
                    }
                });
            },
            toggleTheme() {
                this.data.theme = this.data.theme === 'dark' ? 'light' : 'dark';
                this.applyTheme();
                this.save();
            },
            applyTheme() {
                const html = document.documentElement;
                const circle = document.getElementById('theme-toggle-circle');
                if (this.data.theme === 'dark') {
                    html.classList.add('dark');
                    if(circle) circle.classList.add('translate-x-5');
                } else {
                    html.classList.remove('dark');
                    if(circle) circle.classList.remove('translate-x-5');
                }
            },
            loadData() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) { this.data = { ...this.data, ...JSON.parse(saved) }; } 
                    else {
                        for (const key of LEGACY_KEYS) {
                            const d = localStorage.getItem(key);
                            if (d) { this.data = { ...this.data, ...JSON.parse(d) }; this.save(); break; }
                        }
                    }
                    if (!Array.isArray(this.data.history)) this.data.history = [];
                    if (!Array.isArray(this.data.bookmarks)) this.data.bookmarks = [];
                    if (!Array.isArray(this.data.questions)) this.data.questions = [];
                    this.updateDashboard();
                } catch (e) { console.error("Load error", e); }
            },
            save() {
                try {
                    if (this.data.history.length > 100) this.data.history = this.data.history.slice(-100);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
                    this.updateDashboard();
                } catch (e) { console.error("Save error", e); }
            },
            switchTab(tab) {
                // Reset quiz state if leaving quiz
                if (tab !== 'quiz-view') this.state.isQuizActive = false;

                ['dashboard', 'ai', 'history', 'create', 'quiz-view', 'settings', 'coding'].forEach(id => {
                    document.getElementById('tab-' + id)?.classList.add('hidden');
                    const btn = document.getElementById('nav-' + id);
                    if (btn) { btn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm', 'dark:bg-slate-700', 'dark:text-white'); btn.classList.add('text-slate-600', 'dark:text-slate-400'); }
                });
                document.getElementById('tab-' + tab)?.classList.remove('hidden');
                const activeBtn = document.getElementById('nav-' + tab);
                if (activeBtn) { activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400'); activeBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm', 'dark:bg-slate-700', 'dark:text-white'); }
                requestAnimationFrame(() => {
                    if (tab === 'dashboard') this.renderChapters();
                    if (tab === 'history') this.renderHistory();
                    if (tab === 'create') creator.renderUserQuestions();
                    if (tab === 'ai') aiTutor.analyzeWeakness();
                });
            },
            renderHistory() {
                const list = document.getElementById('history-list');
                const adviceList = document.getElementById('weakness-advice-list');
                list.innerHTML = ''; adviceList.innerHTML = '';
                const logs = this.data.history.slice().reverse().slice(0, 30);
                const weakCounts = {};
                
                logs.forEach(log => {
                    const rate = Math.round((log.correct / log.total) * 100);
                    let weaks = '<span class="text-xs text-slate-400">ãªã—</span>';
                    if (log.weak && log.weak.length) {
                        log.weak.forEach(c => weakCounts[c] = (weakCounts[c] || 0) + 1);
                        weaks = log.weak.map(c => `<span class="text-xs bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 px-1.5 py-0.5 rounded border border-red-100 dark:border-red-800">${c}</span>`).join(' ');
                    }
                    const div = document.createElement('div');
                    div.className = "bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-2";
                    div.innerHTML = `<div class="flex justify-between mb-2"><span class="text-xs font-bold bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded dark:text-slate-300">${log.mode}</span><span class="font-bold text-lg ${rate>=63?'text-emerald-500':'text-slate-700 dark:text-slate-300'}">${rate}%</span></div><div class="flex flex-wrap gap-1">${weaks}</div>`;
                    list.appendChild(div);
                });

                if (typeof Chart !== 'undefined' && this.data.history.length > 0) {
                    const ctx = document.getElementById('historyChart');
                    if (this.chartInstance) this.chartInstance.destroy();
                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: logs.map((_, i) => i + 1),
                            datasets: [{ label: 'Score', data: logs.map(l => Math.round(l.correct/l.total*100)), borderColor: '#4f46e5', tension: 0.3 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100, grid: { color: '#334155' } } }, plugins: { legend: { display: false } } }
                    });
                }
                
                const sortedWeaks = Object.entries(weakCounts).sort((a,b)=>b[1]-a[1]).slice(0,3);
                if(sortedWeaks.length===0) adviceList.innerHTML = '<div class="text-center text-xs text-slate-400 py-4">ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã§ã™</div>';
                else {
                    sortedWeaks.forEach(([cat, count]) => {
                        const div = document.createElement('div');
                        div.className = "bg-white dark:bg-slate-800 p-3 rounded-lg border border-red-100 dark:border-red-900/30 mb-2";
                        div.innerHTML = `<div class="flex justify-between"><span class="text-sm font-bold text-slate-700 dark:text-slate-200">${cat}</span><span class="text-xs bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 px-2 rounded-full">Miss:${count}</span></div>`;
                        adviceList.appendChild(div);
                    });
                }
            },
            updateDashboard() {
                const total = this.data.questions.length;
                const answered = Object.keys(this.data.results).length;
                const correct = Object.values(this.data.results).filter(Boolean).length;
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-rate').innerText = answered ? Math.round((correct/answered)*100) + '%' : '0%';
                const wrongs = this.data.questions.filter(q => this.data.results[q.id] === false);
                document.getElementById('wrong-count').innerText = wrongs.length;
                document.getElementById('btn-review').disabled = wrongs.length === 0;
                document.getElementById('bookmark-count').innerText = this.data.bookmarks.length;
                document.getElementById('btn-bookmark').disabled = this.data.bookmarks.length === 0;
                const userQCount = this.data.questions.filter(q => q.id.includes('user')).length;
                if(document.getElementById('user-q-count')) document.getElementById('user-q-count').innerText = userQCount;
                
                if (total > 0) {
                    const alertEl = document.getElementById('import-alert');
                    if(alertEl) alertEl.classList.add('hidden');
                    setTimeout(() => this.renderChapters(), 10); 
                }
            },
            renderChapters() {
                const grid = document.getElementById('chapter-grid');
                if(!grid || this.data.questions.length===0) return;
                grid.innerHTML = '';
                const chapters = {};
                this.data.questions.forEach(q => {
                    let key = 'others';
                    const lower = q.id.toLowerCase();
                    const cat = q.category || "";
                    if(cat.includes('æ¨¡æ“¬')) return;
                    if(lower.startsWith('ai-')) key='ai';
                    else if(lower.startsWith('best-')) key='best';
                    else if(lower.includes('final') || cat.includes('æœ€çµ‚')) key='final';
                    else { const m = lower.match(/^(?:ch|chapter)?(\d+)[-_]/); if(m) key=parseInt(m[1]); }
                    if(!chapters[key]) chapters[key] = {count:0, correct:0};
                    chapters[key].count++;
                    if(this.data.results[q.id]) chapters[key].correct++;
                });
                
                Object.keys(chapters).sort((a,b) => {
                    const order = {'final':100, 'best':101, 'ai':102, 'others':999};
                    return (order[a]||parseInt(a)) - (order[b]||parseInt(b));
                }).forEach(key => {
                    const c = chapters[key];
                    const rate = Math.round((c.correct/c.count)*100);
                    let label = `Chapter ${key}`;
                    let color = 'indigo';
                    if(key==='final') { label='æœ€çµ‚ç« '; color='yellow'; }
                    else if(key==='ai') { label='AIç”Ÿæˆ'; color='purple'; }
                    else if(key==='best') { label='å³é¸'; color='orange'; }
                    else if(key==='others') { label='ãã®ä»–'; color='slate'; }
                    else {
                        // æ•°å€¤ã‚­ãƒ¼ãªã‚‰ãã®ã¾ã¾ã€ŒChapter Xã€ã§ã¯ãªãã€å…ƒãƒ‡ãƒ¼ã‚¿ã®ã‚«ãƒ†ã‚´ãƒªåã‚’ä½¿ã„ãŸã„ãŒ
                        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œç¬¬Xç« ã€ã«å¤‰æ›ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
                        label = `ç¬¬${key}ç« `;
                    }
                    
                    const btn = document.createElement('button');
                    btn.className = `drill-card bg-white dark:bg-darkcard p-4 rounded-xl border border-slate-200 dark:border-slate-700 border-b-${color}-500 text-left h-32 flex flex-col justify-between`;
                    btn.onclick = () => this.startQuiz('chapter', key);
                    btn.innerHTML = `<div class="font-bold text-slate-700 dark:text-slate-200">${label}</div><div><div class="flex justify-between text-xs text-slate-400 mb-1"><span>æ­£è§£ç‡</span><span>${rate}%</span></div><div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-1.5"><div class="bg-${color}-500 h-1.5 rounded-full" style="width:${rate}%"></div></div></div>`;
                    grid.appendChild(btn);
                });
            },
            startQuiz(mode, param) {
                if(this.data.questions.length===0) return alert('å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
                let list = []; let name = '';
                if(mode==='review') { list = this.data.questions.filter(q => this.data.results[q.id]===false); name='å¾©ç¿’'; }
                else if(mode==='bookmark') { list = this.data.questions.filter(q => this.data.bookmarks.includes(q.id)); name='ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯'; }
                else if(mode==='chapter') {
                    if(param==='final') list = this.data.questions.filter(q => q.id.includes('final') || (q.category&&q.category.includes('æ¨¡æ“¬')));
                    else if(param==='ai') list = this.data.questions.filter(q => q.id.startsWith('ai-'));
                    else if(param==='others') list = this.data.questions.filter(q => !q.id.match(/^(?:ch|chapter)?\d+/) && !q.id.startsWith('ai-'));
                    else list = this.data.questions.filter(q => { const m=q.id.toLowerCase().match(/^(?:ch|chapter)?(\d+)/); return m && parseInt(m[1])===parseInt(param); });
                    
                    // ã‚«ãƒ†ã‚´ãƒªåè¡¨ç¤ºã®ä¿®æ­£
                    name = (typeof param === 'number') ? `ç¬¬${param}ç« ` : `Chapter ${param}`;
                }
                else if(mode.startsWith('level')) {
                    const r1=/^(?:ch|q)[-_]?(1|2|3|4)[-_]/i, r2=/^(?:ch|q)[-_]?(5|6|7|8|12)[-_]/i, r3=/^(?:ch|q)[-_]?(9|10|11|13)[-_]/i;
                    if(mode==='level-1') list=this.data.questions.filter(q=>q.id.match(r1)&&!q.id.includes('user'));
                    if(mode==='level-2') list=this.data.questions.filter(q=>q.id.match(r2)&&!q.id.includes('user'));
                    if(mode==='level-3') list=this.data.questions.filter(q=>q.id.match(r3)&&!q.id.includes('user'));
                    name = mode;
                }
                else if(mode==='mock') { list=[...this.data.questions].sort(()=>Math.random()-0.5).slice(0,40); name='æ¨¡æ“¬è©¦é¨“'; }
                else if(mode==='mock-set') { list = this.data.questions.filter(q => q.category === param); modeName = param; }
                else if(mode==='user-all') { list=this.data.questions.filter(q=>q.id.includes('user')); name='ã‚ªãƒªã‚¸ãƒŠãƒ«å…¨å•'; }
                else if(mode==='user-random') { list=this.data.questions.filter(q=>q.id.includes('user')).sort(()=>Math.random()-0.5).slice(0,10); name='ã‚ªãƒªã‚¸ãƒŠãƒ«10å•'; }

                if(list.length===0) return alert('è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
                if(mode!=='mock-set') list.sort(()=>Math.random()-0.5);
                
                this.state.queue = list;
                this.state.currentIdx = 0;
                this.state.modeName = name;
                this.state.sessionStats = {correct:0, wrongInfo:[]};
                this.state.currentSelection = new Set();
                this.state.isQuizActive = true;
                document.getElementById('mode-display').innerText = name;
                
                if(this.state.timer) clearInterval(this.state.timer);
                if(mode==='mock') {
                    document.getElementById('quiz-timer').classList.remove('hidden');
                    let t = 90*60;
                    this.state.timer = setInterval(() => {
                        t--; document.getElementById('quiz-timer').innerText = `â³ ${Math.floor(t/60)}:${(t%60).toString().padStart(2,'0')}`;
                        if(t<=0) { clearInterval(this.state.timer); this.finishSession(); }
                    }, 1000);
                } else { document.getElementById('quiz-timer').classList.add('hidden'); }
                
                this.switchTab('quiz-view');
                this.renderQuestion();
            },
            quitQuiz() {
                if(this.state.timer) clearInterval(this.state.timer);
                this.state.isQuizActive = false;
                this.switchTab('dashboard');
            },
            startSearchQuiz() {
                const k = document.getElementById('search-input').value.toLowerCase();
                if(!k) return;
                const list = this.data.questions.filter(q => (q.text+q.explanation+q.category).toLowerCase().includes(k));
                if(list.length===0) return alert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                this.state.queue = list;
                this.state.currentIdx = 0;
                this.state.modeName = `æ¤œç´¢:${k}`;
                this.state.sessionStats = {correct:0, wrongInfo:[]};
                this.state.currentSelection = new Set();
                this.state.isQuizActive = true;
                document.getElementById('mode-display').innerText = this.state.modeName;
                this.switchTab('quiz-view');
                this.renderQuestion();
            },
            renderQuestion() {
                const q = this.state.queue[this.state.currentIdx];
                document.getElementById('q-current').innerText = this.state.currentIdx + 1;
                document.getElementById('q-total').innerText = this.state.queue.length;
                document.getElementById('q-category').innerText = q.category || 'General';
                document.getElementById('q-text').innerText = q.text + (Array.isArray(q.answer)?"\n(è¤‡æ•°é¸æŠ)":"");
                document.getElementById('quiz-progress').style.width = `${(this.state.currentIdx/this.state.queue.length)*100}%`;
                
                const bmBtn = document.getElementById('btn-quiz-bookmark');
                if(this.data.bookmarks.includes(q.id)) { bmBtn.classList.add('text-yellow-400'); bmBtn.classList.remove('text-slate-300'); }
                else { bmBtn.classList.remove('text-yellow-400'); bmBtn.classList.add('text-slate-300'); }

                const codeEl = document.getElementById('code-content');
                if(q.code?.trim()) { 
                    document.getElementById('code-container').classList.remove('hidden'); 
                    codeEl.textContent = q.code; 
                    Prism.highlightElement(codeEl); 
                } else { document.getElementById('code-container').classList.add('hidden'); }

                const optsDiv = document.getElementById('options-list');
                optsDiv.innerHTML = '';
                document.getElementById('explanation-box').classList.add('hidden');
                document.getElementById('btn-submit-answer').classList.add('hidden');
                this.state.currentSelection = new Set();
                
                q.options.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn w-full text-left p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-darkcard hover:bg-indigo-50 dark:hover:bg-indigo-900/30 hover:border-indigo-300 dark:hover:border-indigo-700 flex items-center shadow-sm active:scale-[0.99]";
                    btn.onclick = () => this.selectOption(i, btn);
                    btn.id = `option-btn-${i}`;
                    btn.innerHTML = `<span class="opt-mark w-8 h-8 flex-shrink-0 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 rounded-full flex items-center justify-center font-bold mr-4 transition">${String.fromCharCode(65+i)}</span><span class="text-sm font-medium leading-relaxed text-slate-700 dark:text-slate-200 whitespace-pre-wrap">${opt}</span>`;
                    optsDiv.appendChild(btn);
                });

                // Load existing note
                document.getElementById('user-note-input').value = q.note || '';
            },
            selectOption(i, btn) {
                const q = this.state.queue[this.state.currentIdx];
                const isMulti = Array.isArray(q.answer);
                if(isMulti) {
                    if(this.state.currentSelection.has(i)) { this.state.currentSelection.delete(i); btn.classList.remove('option-selected'); }
                    else { this.state.currentSelection.add(i); btn.classList.add('option-selected'); }
                    if(this.state.currentSelection.size>0) document.getElementById('btn-submit-answer').classList.remove('hidden');
                    else document.getElementById('btn-submit-answer').classList.add('hidden');
                } else { this.check([i]); }
            },
            submitAnswer() { this.check(Array.from(this.state.currentSelection)); },
            toggleBookmark() {
                const q = this.state.queue[this.state.currentIdx];
                const idx = this.data.bookmarks.indexOf(q.id);
                if(idx>-1) { this.data.bookmarks.splice(idx,1); document.getElementById('btn-quiz-bookmark').classList.remove('text-yellow-400'); document.getElementById('btn-quiz-bookmark').classList.add('text-slate-300'); }
                else { this.data.bookmarks.push(q.id); document.getElementById('btn-quiz-bookmark').classList.add('text-yellow-400'); document.getElementById('btn-quiz-bookmark').classList.remove('text-slate-300'); }
                this.save();
            },
            check(userAns) {
                const q = this.state.queue[this.state.currentIdx];
                const cor = Array.isArray(q.answer) ? q.answer : [q.answer];
                const isCor = JSON.stringify(userAns.sort()) === JSON.stringify(cor.sort());
                
                if(isCor) this.state.sessionStats.correct++;
                else { const c = q.category||"ãã®ä»–"; if(!this.state.sessionStats.wrongInfo.includes(c)) this.state.sessionStats.wrongInfo.push(c); }
                
                this.data.results[q.id] = isCor;
                this.save();
                
                document.querySelectorAll('#options-list button').forEach(b => b.disabled=true);
                document.getElementById('btn-submit-answer').classList.add('hidden');
                
                userAns.forEach(i => {
                    const btn = document.getElementById(`option-btn-${i}`);
                    if(btn) {
                        if(cor.includes(i)) { btn.classList.add('!bg-emerald-50','!border-emerald-500','dark:!bg-emerald-900/30','dark:!border-emerald-500'); btn.querySelector('.opt-mark').classList.add('!bg-emerald-500','!text-white'); }
                        else { btn.classList.add('!bg-red-50','!border-red-500','dark:!bg-red-900/30','dark:!border-red-500'); btn.querySelector('.opt-mark').classList.add('!bg-red-500','!text-white'); }
                    }
                });
                cor.forEach(i => {
                    if(!userAns.includes(i)) {
                         const btn = document.getElementById(`option-btn-${i}`);
                         if(btn) { btn.classList.add('!bg-emerald-50','!border-emerald-500','dark:!bg-emerald-900/30','dark:!border-emerald-500'); btn.querySelector('.opt-mark').classList.add('!bg-emerald-500','!text-white'); }
                    }
                });

                document.getElementById('explanation-box').classList.remove('hidden');
                document.getElementById('result-badge').innerHTML = isCor ? '<span class="text-emerald-600">â­• æ­£è§£ï¼</span>' : '<span class="text-red-500">âŒ ä¸æ­£è§£...</span>';
                document.getElementById('explanation-text').innerText = `æ­£è§£: ${cor.map(i=>String.fromCharCode(65+i)).join(', ')}\n\n${q.explanation}`;
                if (window.innerWidth < 768) box.scrollIntoView({ behavior: 'smooth' });
            },
            nextQuestion() {
                this.state.currentIdx++;
                if(this.state.currentIdx >= this.state.queue.length) this.finishSession();
                else { this.renderQuestion(); document.getElementById('quiz-view').scrollTop = 0; }
            },
            finishSession() {
                if(this.state.timer) clearInterval(this.state.timer);
                this.state.isQuizActive = false;
                const log = { date: Date.now(), correct: this.state.sessionStats.correct, total: this.state.queue.length, mode: this.state.modeName, weak: [...new Set(this.state.sessionStats.wrongInfo)] };
                this.data.history.push(log);
                this.save();
                document.getElementById('res-score').innerText = `${log.correct}/${log.total}`;
                document.getElementById('res-rate').innerText = Math.round((log.correct/log.total)*100) + '%';
                document.getElementById('session-result').classList.remove('hidden');
            },
            closeSessionResult() { document.getElementById('session-result').classList.add('hidden'); this.switchTab('history'); },
            saveNote() {
                const q = this.state.queue[this.state.currentIdx];
                const note = document.getElementById('user-note-input').value;
                const target = this.data.questions.find(item => item.id === q.id);
                if(target) target.note = note;
                this.save();
                alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸğŸ“');
            }
        };

        // Coding App Logic
        const codingApp = {
            currentDrill: null,
            
            init() {
                const menu = document.getElementById('coding-menu');
                menu.innerHTML = '';
                
                codingDrills.forEach(drill => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white dark:bg-darkcard border border-slate-200 dark:border-slate-700 hover:border-indigo-400 dark:hover:border-indigo-500 rounded-xl p-5 text-left transition shadow-sm group active:scale-[0.99]";
                    btn.onclick = () => this.start(drill);
                    btn.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded">${drill.tag}</span>
                            <span class="text-xl group-hover:scale-110 transition">âš¡ï¸</span>
                        </div>
                        <h4 class="font-bold text-slate-700 dark:text-slate-200 mb-1">${drill.title}</h4>
                        <p class="text-xs text-slate-400 line-clamp-2">${drill.desc}</p>
                    `;
                    menu.appendChild(btn);
                });
            },
            
            start(drill) {
                this.currentDrill = drill;
                document.getElementById('coding-menu').classList.add('hidden');
                document.getElementById('coding-workspace').classList.remove('hidden');
                
                document.getElementById('coding-title').innerText = drill.title;
                document.getElementById('coding-tag').innerText = drill.tag;
                document.getElementById('coding-desc').innerText = drill.desc;
                
                // Hints
                if (drill.keywords && drill.keywords.length > 0) {
                    document.getElementById('coding-hint-box').classList.remove('hidden');
                    const kwDiv = document.getElementById('coding-keywords');
                    kwDiv.innerHTML = drill.keywords.map(k => `<span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] px-2 py-1 rounded border border-slate-200 dark:border-slate-600 font-mono">${k}</span>`).join('');
                } else {
                    document.getElementById('coding-hint-box').classList.add('hidden');
                }
                
                // Reset editor & result
                const editor = document.getElementById('coding-editor');
                editor.value = '';
                editor.focus();
                document.getElementById('coding-result').classList.add('hidden');
            },
            
            close() {
                document.getElementById('coding-menu').classList.remove('hidden');
                document.getElementById('coding-workspace').classList.add('hidden');
                this.currentDrill = null;
            },
            
            check() {
                if (!this.currentDrill) return;
                const userCode = document.getElementById('coding-editor').value;
                const keywords = this.currentDrill.keywords || [];
                
                // Simple Check: Contains keywords?
                const missing = keywords.filter(k => !userCode.includes(k));
                const isPerfect = missing.length === 0;
                
                const resultTitle = document.getElementById('coding-result-title');
                const resultMsg = document.getElementById('coding-result-msg');
                const answerCode = document.getElementById('coding-answer-code');
                
                if (isPerfect) {
                    resultTitle.innerHTML = '<span class="text-emerald-500">ğŸ‰ Excellent!</span>';
                    resultMsg.innerText = 'å¿…é ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã™ã¹ã¦å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚';
                } else {
                    resultTitle.innerHTML = '<span class="text-amber-500">âš ï¸ Keep Trying</span>';
                    resultMsg.innerText = `ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}`;
                }
                
                answerCode.textContent = this.currentDrill.answer;
                Prism.highlightElement(answerCode);
                
                document.getElementById('coding-result').classList.remove('hidden');
            },
            
            showAnswer() {
                if (!this.currentDrill) return;
                const resultTitle = document.getElementById('coding-result-title');
                const resultMsg = document.getElementById('coding-result-msg');
                const answerCode = document.getElementById('coding-answer-code');
                
                resultTitle.innerHTML = '<span class="text-indigo-500">ğŸ‘€ æ¨¡ç¯„è§£ç­”</span>';
                resultMsg.innerText = 'è§£ç­”ä¾‹ã‚’ç¢ºèªã—ã¦ã€è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
                
                answerCode.textContent = this.currentDrill.answer;
                Prism.highlightElement(answerCode);
                
                document.getElementById('coding-result').classList.remove('hidden');
            }
        };

        const creator = {
            categoryNames: { "1": "Javaã®åŸºæœ¬", "2": "ãƒ‡ãƒ¼ã‚¿å‹ã¨å¤‰æ•°", "3": "æ¼”ç®—å­", "4": "ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡", "5": "é…åˆ—", "6": "ã‚¯ãƒ©ã‚¹ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹", "7": "ç¶™æ‰¿", "8": "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹", "9": "ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ", "10": "ä¾‹å¤–å‡¦ç†", "11": "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«", "12": "ä¸»è¦API", "13": "ãƒ©ãƒ ãƒ€å¼", "mock1": "æ¨¡æ“¬è©¦é¨“â‘ ", "mock2": "æ¨¡æ“¬è©¦é¨“â‘¡", "mock3": "æ¨¡æ“¬è©¦é¨“â‘¢", "99": "ãã®ä»–" },
            updateCategoryLabel() { const val = document.getElementById('create-chapter').value; document.getElementById('create-cat-name').value = this.categoryNames[val]; },
            addOption() {
                const container = document.getElementById('options-container');
                const idx = container.children.length;
                const div = document.createElement('div');
                div.className = "flex items-start gap-3 option-row";
                div.innerHTML = `
                    <input type="checkbox" name="correct-idx" value="${idx}" class="w-5 h-5 mt-2 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                    <textarea class="create-option flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition resize-y dark:text-white" rows="2" placeholder="é¸æŠè‚¢ ${String.fromCharCode(65 + idx)}" required></textarea>
                    <button type="button" onclick="creator.removeOption(this)" class="text-slate-400 hover:text-red-500 px-2 font-bold text-lg mt-1">Ã—</button>
                `;
                container.appendChild(div);
            },
            removeOption(btn) { btn.closest('.option-row').remove(); this.reindexOptions(); },
            reindexOptions() {
                const rows = document.querySelectorAll('.option-row');
                rows.forEach((row, index) => {
                    row.querySelector('input[type="checkbox"]').value = index;
                    row.querySelector('.create-option').placeholder = `é¸æŠè‚¢ ${String.fromCharCode(65 + index)}`;
                });
            },
            resetForm() {
                document.getElementById('create-form').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('options-container').innerHTML = '';
                for (let i = 0; i < 4; i++) this.addOption();
                const btn = document.getElementById('btn-save-question');
                btn.innerText = "è¿½åŠ ã™ã‚‹";
                btn.className = "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5";
                document.getElementById('btn-cancel-edit').classList.add('hidden');
                this.updateCategoryLabel();
            },
            renderUserQuestions() {
                const listEl = document.getElementById('user-questions-list');
                const userQs = app.data.questions.filter(q => q.id.includes('user'));
                listEl.innerHTML = '';
                if (userQs.length === 0) { listEl.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm">ã¾ã è‡ªä½œå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
                [...userQs].reverse().forEach(q => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-start bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-600 hover:border-indigo-300 dark:hover:border-indigo-700 transition";
                    div.innerHTML = `<div class="flex-1 pr-2"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-2 py-0.5 rounded font-bold whitespace-nowrap">${q.category}</span></div><p class="text-sm text-slate-700 dark:text-slate-300 font-medium line-clamp-2">${q.text}</p></div><div class="flex flex-col gap-2"><button onclick="creator.editQuestion('${q.id}')" class="text-xs bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-500 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:text-indigo-600 dark:hover:text-indigo-300 transition">ç·¨é›†</button><button onclick="creator.deleteQuestion('${q.id}')" class="text-xs bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-500 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded hover:bg-red-50 dark:hover:bg-red-900 hover:text-red-600 dark:hover:text-red-300 transition">å‰Šé™¤</button></div>`;
                    listEl.appendChild(div);
                });
            },
            editQuestion(id) {
                const q = app.data.questions.find(x => x.id === id);
                if (!q) return;
                document.getElementById('edit-id').value = q.id;
                document.getElementById('create-text').value = q.text;
                document.getElementById('create-code').value = q.code || '';
                document.getElementById('create-explanation').value = q.explanation;

                // Chapter Select
                const select = document.getElementById('create-chapter');
                const options = Array.from(select.options);
                const found = options.find(o => o.text.includes(q.category));
                if(found) select.value = found.value;

                // Options
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                q.options.forEach((optText) => {
                    this.addOption();
                    const inputs = container.querySelectorAll('.create-option');
                    inputs[inputs.length - 1].value = optText;
                });

                const checkboxes = document.querySelectorAll('input[name="correct-idx"]');
                const correctArr = Array.isArray(q.answer) ? q.answer : [q.answer];
                correctArr.forEach(idx => { if (checkboxes[idx]) checkboxes[idx].checked = true; });

                const btn = document.getElementById('btn-save-question');
                btn.innerText = "æ›´æ–°ã™ã‚‹";
                btn.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:-translate-y-0.5";
                document.getElementById('btn-cancel-edit').classList.remove('hidden');
                // Scroll to top of create tab
                document.getElementById('tab-create').scrollTop = 0;
            },
            cancelEdit() { this.resetForm(); },
            deleteQuestion(id) {
                if (!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                app.data.questions = app.data.questions.filter(q => q.id !== id);
                app.save();
                this.renderUserQuestions();
            },
            saveQuestion(e) {
                e.preventDefault();
                const editId = document.getElementById('edit-id').value;
                const chapterNum = document.getElementById('create-chapter').value;
                const select = document.getElementById('create-chapter');
                const chapterName = select.options[select.selectedIndex].text.replace(/^\d+:\s*/, ''); 
                
                const text = document.getElementById('create-text').value;
                const code = document.getElementById('create-code').value;

                const opts = Array.from(document.querySelectorAll('.create-option')).map(i => i.value);
                const checkedBoxes = document.querySelectorAll('input[name="correct-idx"]:checked');
                if (checkedBoxes.length === 0) return alert("æ­£è§£ã‚’å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„");

                const correctIdxs = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
                const finalAnswer = correctIdxs.length === 1 ? correctIdxs[0] : correctIdxs;

                const explanation = document.getElementById('create-explanation').value;

                if (editId) {
                    const index = app.data.questions.findIndex(q => q.id === editId);
                    if (index !== -1) {
                        app.data.questions[index] = { ...app.data.questions[index], category: chapterName, text: text, code: code, options: opts, answer: finalAnswer, explanation: explanation };
                        alert('å•é¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                    }
                    this.cancelEdit();
                } else {
                    let idPrefix = `user-${chapterNum}-`;
                    const newId = idPrefix + Date.now();
                    const newQ = { id: newId, category: chapterName, text: text, code: code, options: opts, answer: finalAnswer, explanation: explanation };
                    app.data.questions.push(newQ);
                    alert(`å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
                    this.resetForm();
                }
                app.save();
                this.renderUserQuestions();
            },
            updateCategoryLabel() {} 
        };

        const dataManager = {
            importData(input) { if (input.files.length === 0) return; const readers = Array.from(input.files).map(file => new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsText(file); })); Promise.all(readers).then(results => { let count = 0; const newQs = []; const seenIds = new Set(app.data.questions.map(q => q.id)); results.forEach(res => { try { const json = JSON.parse(res); if (json.questions) json.questions.forEach(q => { if (!seenIds.has(q.id)) { newQs.push(q); seenIds.add(q.id); count++; } }); } catch (e) { } }); if (count > 0) { app.data.questions = [...app.data.questions, ...newQs]; app.save(); document.getElementById('import-alert').classList.add('hidden'); alert(`${count}å•ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`); app.renderChapters(); } input.value = ''; }); },
            resetAll() { if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } },
            generateDemoData() {
                const now = Date.now();
                const dummyHistory = [
                    { date: now - 10000000, correct: 5, total: 10, mode: 'ç¬¬1ç« ', weak: ['Javaã®åŸºæœ¬', 'ãƒ‡ãƒ¼ã‚¿å‹ã¨å¤‰æ•°'] },
                    { date: now - 5000000, correct: 2, total: 5, mode: 'ç¬¬3ç« ', weak: ['æ¼”ç®—å­', 'Javaã®åŸºæœ¬'] },
                    { date: now, correct: 8, total: 10, mode: 'æ¨¡æ“¬è©¦é¨“', weak: ['ä¾‹å¤–å‡¦ç†', 'ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ', 'Javaã®åŸºæœ¬'] }
                ];
                app.data.history = [...app.data.history, ...dummyHistory];
                app.save();
                alert('ãƒ†ã‚¹ãƒˆç”¨ã®å­¦ç¿’å±¥æ­´ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œè¨˜éŒ²ã€ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                app.renderHistory();
            },
            exportData() {
                const dataStr = JSON.stringify(app.data, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `java_silver_data_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            }
        };

        const aiTutor = {
            apiKey: '', 
            model: 'gemini-1.5-flash',
            init() {
                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.model = localStorage.getItem('gemini_api_model') || 'gemini-1.5-flash';
                const select = document.getElementById('api-model-select');
                if (select) {
                    if (['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'].includes(this.model)) { select.value = this.model; document.getElementById('api-model-custom').classList.add('hidden'); }
                    else { select.value = 'custom'; document.getElementById('api-model-custom').classList.remove('hidden'); document.getElementById('api-model-custom').value = this.model; }
                }
                this.updateStatus();
            },
            toggleCustomModelInput() { 
                const val = document.getElementById('api-model-select').value; 
                const customInput = document.getElementById('api-model-custom'); 
                if (val === 'custom') customInput.classList.remove('hidden'); 
                else customInput.classList.add('hidden'); 
            },
            saveKey() { 
                const key = document.getElementById('api-key-input').value.trim(); 
                let model = document.getElementById('api-model-select').value; 
                if (model === 'custom') model = document.getElementById('api-model-custom').value.trim(); 
                if (key) localStorage.setItem('gemini_api_key', key); 
                localStorage.setItem('gemini_api_model', model); 
                this.model = model; 
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚'); 
                this.init(); 
            },
            updateStatus() { 
                const statusEl = document.getElementById('key-status'); 
                if (this.apiKey) { 
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> è¨­å®šæ¸ˆã¿'; 
                    statusEl.className = 'text-xs text-emerald-600 mt-2 flex items-center gap-1 font-bold'; 
                    document.getElementById('btn-generate').disabled = false; 
                } else { 
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-slate-300"></span> æœªè¨­å®š'; 
                    statusEl.className = 'text-xs text-slate-400 mt-2 flex items-center gap-1'; 
                    document.getElementById('btn-generate').disabled = true; 
                } 
            },
            analyzeWeakness() {
                if (app.data.results.length === 0) return "Java Silverå…¨èˆ¬";
                const wrongCounts = {};
                for (const q of app.data.questions) {
                    if (app.data.results[q.id] === false) {
                        const cat = q.category || "ãã®ä»–";
                        wrongCounts[cat] = (wrongCounts[cat] || 0) + 1;
                    }
                }
                const sortedWeakness = Object.entries(wrongCounts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(e => e[0]);
                const listEl = document.getElementById('weak-list');
                const analysisBox = document.getElementById('ai-analysis');
                if (sortedWeakness.length > 0) {
                    analysisBox.classList.remove('hidden');
                    listEl.innerHTML = sortedWeakness.map(w => `<li>${w}</li>`).join('');
                    return sortedWeakness.join('ã€');
                } else {
                    analysisBox.classList.add('hidden');
                    return "Java Silverå…¨èˆ¬";
                }
            },
            async generate() {
                const topics = this.analyzeWeakness() || "Java Silverå…¨èˆ¬";
                const btn = document.getElementById('btn-generate');
                const loading = document.getElementById('ai-loading');
                const loadingText = document.getElementById('ai-status-text');
                btn.classList.add('hidden');
                loading.classList.remove('hidden');

                const prompt = `Java Silver SE11ã®è©¦é¨“å¯¾ç­–ã¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‹¦æ‰‹åˆ†é‡ã€${topics}ã€‘ã«é–¢ã™ã‚‹4æŠå•é¡Œã‚’5å•ä½œæˆã—ã¦ãã ã•ã„ã€‚å‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã®ã¿ã€‚Markdownè¨˜æ³•ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚[{"id": "ai-${Date.now()}-1", "category": "AIç”Ÿæˆ", "text": "...", "code": "...", "options": ["..."], "answer": 0, "explanation": "..."}]`;

                const fetchWithRetry = async (model, retries = 1) => {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${this.apiKey}`;
                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!res.ok) {
                            if (res.status === 429 && retries > 0) {
                                loadingText.innerText = "æ··é›‘ä¸­...å†è©¦è¡Œã—ã¾ã™";
                                await new Promise(r => setTimeout(r, 3000));
                                return fetchWithRetry(model, retries - 1);
                            }
                            if (res.status === 404 && model === 'gemini-1.5-flash') {
                                return fetchWithRetry('gemini-pro', 0);
                            }
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.error?.message || res.statusText);
                        }
                        return res.json();
                    } catch (e) { throw e; }
                };

                try {
                    const data = await fetchWithRetry(this.model);
                    let text = data.candidates[0].content.parts[0].text;
                    const jsonMatch = text.match(/\[\s*\{.*\}\s*\]/s);
                    text = jsonMatch ? jsonMatch[0] : text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newQs = JSON.parse(text);
                    newQs.forEach((q, i) => { q.id = `ai-${Date.now()}-${i}`; app.data.questions.push(q); });
                    app.save();
                    alert('5å•ã®å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
                    app.updateDashboard();
                } catch (e) {
                    alert(`AIç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${e.message}`);
                } finally {
                    btn.classList.remove('hidden');
                    loading.classList.add('hidden');
                }
            }
        };

        // Initialize
        app.init();
    </script>
</body>

</html>